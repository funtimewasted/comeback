<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Question Bank</title>
    <style>
        /* --- START OF styles.css --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc; /* Light background for body */
            color: #1e293b; /* Default text color */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff; /* White background for main container */
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .header {
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #0f172a; /* Darker heading */
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .subjects {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px;
        }

        .secondary-nav {
            display: flex;
            gap: 10px;
            padding-left: 0; /* No indent needed now */
            align-items: center;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            color: #334155;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
            border-color: #cbd5e1;
        }

        .nav-btn.active {
            background-color: #0f172a;
            color: white;
            border-color: #0f172a; /* Match border */
        }
        .nav-btn.active span { /* Adjust icon color on active */
             filter: brightness(0) invert(1);
        }


        .semester-toggle {
            display: flex;
            gap: 5px;
            background-color: #f1f5f9;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .semester-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: none;
            color: #334155; /* Default color */
            transition: all 0.2s ease;
        }

        .semester-btn.active {
            background-color: #ffffff;
            color: #0f172a; /* Active color */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- Topic List Styles (#content) --- */
        #content {
            /* Styles for when the topic list is visible */
        }

        .unit-container { /* Container for semester title */
             margin-bottom: 20px;
        }

        .unit-title { /* Title for the Semester (e.g., "First Semester") */
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e293b;
             padding-bottom: 10px;
             border-bottom: 1px solid #e2e8f0;
        }

        .section { /* Represents a Unit Box */
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            margin-bottom: 20px; /* Space between units */
        }
         /* Remove bottom margin from the last unit section in the list */
        .semester-content > .section:last-of-type {
             margin-bottom: 0;
         }


        .section-title { /* Represents the Unit Title inside the Unit Box */
            font-size: 17px; /* Unit title size */
            font-weight: 600;
            margin-bottom: 15px;
            color: #334155;
        }

        /* .section-content represents a clickable Lesson Box inside a Unit Box */
        .section-content {
            padding: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            font-size: 15px;
            color: #334155;
            display: block;
            text-align: left;
        }
        .section-content:last-child { /* Last lesson box in a unit */
            margin-bottom: 0;
        }

        .section-content:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
            transform: translateY(-1px);
        }

        .semester-content {
            display: none;
        }
        .semester-content.active {
            display: block;
        }

        /* --- Quiz View Styles (#quiz-view) --- */
        #quiz-view {
             padding: 20px 0;
        }

        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        #quiz-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        #quiz-container {
            margin-bottom: 20px;
        }

        .question-type-wrapper {
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            margin-bottom: 20px;
             box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .question-progress {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 15px;
            text-align: right;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 25px;
            line-height: 1.6;
            color: #1e293b;
        }
        .question-text strong {
            font-weight: 600;
            margin-right: 5px;
        }

        /* --- MC Specific --- */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 0; }
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background-color: #fff; }
        .option-label:hover { background-color: #f1f5f9; border-color: #cbd5e1; }
        .option-label input:checked + .option-text { font-weight: 500; }
        .option-label input:checked { accent-color: #2563eb; }
        .option-input { margin-right: 15px; flex-shrink: 0; }
        .option-text { flex-grow: 1; font-size: 16px; color: #334155; }

        /* --- Matching Specific --- */
        .matching-instructions { font-size: 15px; color: #475569; margin-bottom: 20px; }
        .matching-container { position: relative; display: flex; justify-content: space-between; gap: 5%; margin-bottom: 0; }
        .matching-column { flex-basis: 47%; display: flex; flex-direction: column; gap: 10px; }
        .matching-column h4 { margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .matching-item { padding: 10px 15px; border: 1px solid #cbd5e1; background-color: #fff; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; display: flex; align-items: center; min-height: 30px; }
        .matching-item:hover { background-color: #f1f5f9; border-color: #94a3b8; }
        .matching-item.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: 500; }
        .matching-item.matched { background-color: #e5e7eb; border-color: #9ca3af; cursor: pointer; opacity: 1.0; }
        #matching-arrow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 1; }
        #matching-arrow-svg line { stroke: #60a5fa; stroke-width: 2; transition: all 0.3s ease; marker-end: url(#arrowhead); }
        .review-matched-pair-correct { background-color: #dcfce7 !important; border-color: #16a34a !important; }
        .review-matched-pair-incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }

        /* --- Ordering Specific --- */
        .ordering-instructions { font-size: 15px; color: #475569; margin-bottom: 20px; }
        .ordering-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 0; }
        .ordering-item { display: flex; align-items: center; padding: 10px 15px; border: 1px solid #e2e8f0; background-color: #fff; border-radius: 6px; }
        .ordering-select { margin-right: 15px; padding: 5px 8px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 14px; min-width: 60px; }
        .ordering-text { flex-grow: 1; font-size: 16px; }
        .review-order-number { font-weight: 600; min-width: 25px; text-align: right; margin-right: 10px; }
        .review-order-correct { color: #059669; }
        .review-order-incorrect { color: #dc2626; text-decoration: line-through; margin-right: 5px;}

        /* --- Feedback & Buttons --- */
        #feedback-container { padding: 15px; margin-top: 20px; border-radius: 6px; background-color: #f1f5f9; border: 1px solid #e2e8f0; }
        #feedback-container.hidden { display: none; }
        .correct-feedback { color: #059669; font-weight: 600; font-size: 16px; }
        .incorrect-feedback { color: #dc2626; font-weight: 600; font-size: 16px; }
        .incorrect-feedback span { display: block; font-weight: 500; margin-top: 8px; font-size: 15px; color: #475569; line-height: 1.5; }
        .partial-feedback { color: #ca8a04; font-weight: 600; font-size: 16px; }

        /* Highlighting */
        .correct-option { background-color: #dcfce7 !important; border-color: #16a34a !important; }
        .correct-option .option-text { color: #065f46 !important; }
        .incorrect-option { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .incorrect-option .option-text { color: #b91c1c !important; }

        /* Button container */
        #quiz-buttons-container { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .results-actions, .review-actions { justify-content: space-between; }
        .results-actions .back-to-topics-btn { margin-left: auto; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s ease; line-height: 1.5; }
        .submit-btn { background-color: #2563eb; color: white; }
        .submit-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        .submit-btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .next-btn { background-color: #059669; color: white; }
        .next-btn:hover { background-color: #047857; }
        .review-btn { background-color: #16a34a; color: white; }
        .review-btn:hover { background-color: #15803d; }
        .redo-btn { background-color: #f97316; color: white; } /* Orange for Redo */
        .redo-btn:hover { background-color: #ea580c; }
        .close-btn, .back-to-topics-btn { background-color: #64748b; color: white; }
        .close-btn:hover, .back-to-topics-btn:hover { background-color: #475569; }
        .back-btn { background-color: #64748b; color: white; }
        .back-btn:hover { background-color: #475569; }

        .hidden { display: none !important; }

        /* --- Error Message Styles --- */
        .error-display { padding: 30px; text-align: center; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; }
        .error-message { color: #b91c1c; font-weight: 500; margin-bottom: 20px; }

        /* --- Results Styles --- */
        .results-container { padding: 10px 0; text-align: center; }
        .results-header { font-size: 24px; margin-bottom: 25px; color: #1e293b; }
        .results-score { margin: 30px 0 35px 0; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; background-color: #f1f5f9; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; border: 6px solid #2563eb; box-shadow: 0 0 15px rgba(37, 99, 235, 0.2); }
        .score-number { font-size: 40px; font-weight: bold; color: #1e293b; line-height: 1; }
        .score-percent-sign { font-size: 18px; font-weight: 500; color: #475569; margin-top: 2px; }
        .results-details { max-width: 450px; margin: 0 auto 35px auto; text-align: left; background-color: #f8fafc; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .results-details p { margin: 10px 0; font-size: 15px; color: #334155; }
        .results-details p strong { color: #1e293b; min-width: 120px; display: inline-block; }

        /* --- Review Answers Styles --- */
        .review-container { padding: 10px 0; }
        .question-review { padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e2e8f0; border-left-width: 5px; background-color: #fff; }
        .question-review.correct { border-left-color: #16a34a; }
        .question-review.incorrect { border-left-color: #ef4444; }
        .question-review.partial { border-left-color: #f59e0b; }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
        .review-question-number { font-weight: 600; color: #1e293b; font-size: 16px; }
        .review-status { font-weight: 600; font-size: 14px; padding: 3px 8px; border-radius: 4px; text-align: center; }
        .question-review.correct .review-status { color: #065f46; background-color: #dcfce7; }
        .question-review.incorrect .review-status { color: #991b1b; background-color: #fee2e2; }
        .question-review.partial .review-status { color: #854d0e; background-color: #fef9c3; }
        .review-question-text { margin-bottom: 15px; font-size: 16px; color: #334155; }

        /* Review specific content */
        .review-mc-answer, .review-matching-answer, .review-ordering-answer { background-color: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; margin-top: 15px; }
        .review-mc-answer p, .review-matching-answer p, .review-ordering-answer p { margin: 8px 0; font-size: 15px; color: #475569; }
        .review-mc-answer p strong, .review-matching-answer p strong, .review-ordering-answer p strong { color: #1e293b; margin-right: 5px; display: inline-block; min-width: 110px; }
        .review-mc-answer .correct-answer-text, .review-matching-answer .correct-answer-text, .review-ordering-answer .correct-answer-text { color: #059669; font-weight: 500; }
        .review-mc-answer .user-answer-text.incorrect { color: #dc2626; text-decoration: line-through; }
        .review-mc-answer .user-answer-text.correct { color: #059669; font-weight: 500; }

        /* Review Matching */
        .review-matching-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .review-matching-column { flex: 1; min-width: 200px;}
        .review-matching-column div { padding: 5px 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #e2e8f0; background-color: #fff; }

        /* Review Ordering */
        .review-ordering-list { margin-top: 10px; }
        .review-ordering-list-item { display: flex; align-items: center; margin-bottom: 5px; padding: 5px 8px; border-radius: 4px; border: 1px solid #e2e8f0; background-color: #fff; }

        /* --- END OF styles.css --- */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Interactive Question Bank</h1>
        </div>

        <!-- Navigation -->
        <div class="nav-section">
            <div class="subjects">
                <button class="nav-btn" data-subject="اللغة العربية"><span>📚</span> اللغة العربية</button>
                <button class="nav-btn active" data-subject="english"><span>🌎</span> English</button>
                <button class="nav-btn" data-subject="التاريخ"><span>📜</span> التاريخ</button>
                <button class="nav-btn" data-subject="دين"><span>📖</span> دين</button>
            </div>
            <div class="secondary-nav">
                <div class="semester-toggle">
                    <button class="semester-btn active" data-semester="first">First Semester</button>
                    <button class="semester-btn" data-semester="second">Second Semester</button>
                </div>
            </div>
        </div>

        <!-- Content Area for Topic Lists -->
        <div id="content">
            <!-- Topic lists loaded by JS -->
        </div>

        <!-- Quiz View Area (Initially Hidden) -->
        <div id="quiz-view" class="hidden">
            <div id="quiz-header">
                <h2 id="quiz-title">Quiz Title</h2>
                <button class="btn back-to-topics-btn" onclick="showTopicList()">← Back to Topics</button>
            </div>
            <div id="quiz-container">
                 <!-- Quiz Question/Results/Review content loads here -->
            </div>
             <div id="feedback-container" class="feedback-container hidden">
                 <!-- Feedback messages load here -->
             </div>
             <div id="quiz-buttons-container" class="quiz-buttons">
                 <!-- Submit/Next/Review/Back buttons load here -->
            </div>
        </div>

    </div> <!-- End of .container -->

    <script>
        // --- START OF topics.js ---

        // FULL Topics data structure - RESTORED PLACEHOLDERS
        const topicsData = {
            "english": {
                "first": {
                    "title": "First Semester",
                    "units": [
                        {
                            "title": "Unit 1", // Unit Title
                            "lessons": [ // Lessons within the unit
                                {
                                    "title": "Vocabulary & Grammar Basics", // Lesson Title
                                    "questions": [
                                        { "type": "multiple_choice", "question": "Device in 'curtain of night fell'?", "options": ["Simile", "Metaphor", "Alliteration", "Hyperbole"], "answer": "Metaphor" },
                                        { "type": "multiple_choice", "question": "'Ambiguous' means:", "options": ["Clear", "Uncertain", "Definite", "Determined"], "answer": "Uncertain" },
                                        { "type": "ordering", "question": "Order alphabetically:", "items": ["Banana", "Apple", "Cherry", "Date", "Fig"], "answer": ["Apple", "Banana", "Cherry", "Date", "Fig"] },
                                        { "type": "matching", "question": "Match country and capital:", "prompts": ["France", "Japan", "Egypt", "Brazil", "Canada"], "matches": ["Cairo", "Tokyo", "Paris", "Brasília", "Ottawa"], "answer": { "0": 2, "1": 1, "2": 0, "3": 3, "4": 4 } },
                                        { "type": "ordering", "question": "Order tea steps:", "items": ["Add tea bag", "Boil water", "Pour water"], "answer": ["Boil water", "Add tea bag", "Pour water"] }
                                    ]
                                },
                                {
                                    "title": "Past & Present Tenses & Question Tags",
                                    "questions": [
                                        { "type": "multiple_choice", "question": "Correct tense: 'She ___ school.'", "options": ["go", "goes", "going", "went"], "answer": "goes" },
                                        { "type": "multiple_choice", "question": "Correct tag: 'You're coming, ___?'", "options": ["aren't you", "don't you", "isn't you", "won't you"], "answer": "aren't you" }
                                    ]
                                }
                            ]
                        },
                        {
                            "title": "Unit 2",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Future Forms", "questions": [] }
                            ]
                        },
                        {
                            "title": "Unit 3",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Habits & Clauses", "questions": [] }
                            ]
                        },
                        {
                            "title": "Unit 4",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Narration & Inversion", "questions": [] }
                            ]
                        }
                    ]
                },
                "second": {
                    "title": "Second Semester",
                    "units": [
                        { "title": "Unit 1", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modal & Related & Articles", "questions": [] } ] },
                        { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Reported Speech & Reporting Verbs", "questions": [] } ] },
                        { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "The Passive", "questions": [] } ] },
                        { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Conditionals & Modals", "questions": [] } ] },
                        { "title": "Unit 5", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modals & Clauses", "questions": [] } ] }
                    ]
                }
            },
            "اللغة العربية": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الوحدة الأولى", "lessons": [ { "title": "من القيم الإنسانية في القرآن", "questions": [] }, { "title": "اسلوب الطلب وجوابه المجزوم والتشبيه المفرد", "questions": [] } ] },
                        { "title": "الوحدة الثانية", "lessons": [ { "title": "عمانيات", "questions": [] }, { "title": "صور الفاعل والتشبيه التمثيلي", "questions": [] } ] },
                        { "title": "الوحدة الثالثة", "lessons": [ { "title": "الزهايمر-الخرف المبكر", "questions": [] }, { "title": "صور المبتدأ والخبر والجملة الخبرية والإنشائية", "questions": [] } ] },
                        { "title": "الوحدة الرابعة", "lessons": [ { "title": "الإعلام ومشروع النهوض باللغة العربية", "questions": [] }, { "title": "المفعول معه والأمر", "questions": [] } ] },
                        { "title": "الوحدة الخامسة", "lessons": [ { "title": "التعليم التقني بوابة المستقبل في عالم متغير", "questions": [] }, { "title": "انواع ما والإستفهام", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "في فتح القدس", "questions": [] }, { "title": "معاني حروف الجر والتشخيص", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "قصة-حفنة تمر", "questions": [] }, { "title": "اسم الفاعل واسم المفعول والطباق والمقابلة", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "شاعرات من بلدي", "questions": [] }, { "title": "اسم الزمان واسم المكان وجمع التكسير (القلة والكثرة)", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "من مقامات بديع الزمان الهمذاني", "questions": [] }, { "title": "مصدر المرة ومصدر الهيئة والبحر المتدارك", "questions": [] } ] },
                         { "title": "الوحدة الخامسة", "lessons": [ { "title": "الذكاء الاصطناعي-عالم جديد", "questions": [] }, { "title": "اسم الآلة", "questions": [] } ] }
                    ]
                }
            },
             "التاريخ": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الأردن في العصور القديمة", "lessons": [ { "title": "الأردن في العصور الحجرية", "questions": [] }, { "title": "الأردن في العصر الحديدي", "questions": [] }, { "title": "مملكة الأنباط", "questions": [] }, { "title": "مظاهر الحضارة اليونانية في الأردن", "questions": [] }, { "title": "مظاهر الحضارة الرومانية-البيزنطية في الأردن", "questions": [] } ] },
                        { "title": "الأردن في صدر الإسلام", "lessons": [ { "title": "الأردن في صدر الإسلام", "questions": [] }, { "title": "الأردن في العصر الأموي", "questions": [] }, { "title": "الأردن في العصر العباسي", "questions": [] }, { "title": "الأردن خلال حملات الفرنجة", "questions": [] }, { "title": "الأردن في العصر الأيوبي", "questions": [] }, { "title": "الأردن في العصر المملوكي", "questions": [] } ] },
                        { "title": "الأردن في العصر الحديث", "lessons": [ { "title": "الأوضاع السياسية والإدارية في الأردن في العهد العثماني", "questions": [] }, { "title": "الأوضاع الإجتماعية والإقتصادية الأردن في العهد العثماني", "questions": [] }, { "title": "الثورة العربية الكبرى", "questions": [] }, { "title": "الأردن في عهد المملكة العربية السورية والحكومات المحلية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                     "units": [
                        { "title": "الحياة السياسية في الأردن", "lessons": [ { "title": "تأسيس الإمارة الأردنية", "questions": [] }, { "title": "استقلال المملكة الأردنية الهاشمية", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1948-1957)", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1958-1999)", "questions": [] }, { "title": "الحياة السياسية في الأردن منذ 1999", "questions": [] }, { "title": "الأردن والعلاقات العربية والدولية", "questions": [] }, { "title": "القوات المسلحة الأردنية - الجيش العربي", "questions": [] }, { "title": "الأجهزة الأمنية الأردنية", "questions": [] } ] },
                        { "title": "الحياة الاقتصادية في الأردن", "lessons": [ { "title": "الحياة الاقتصادية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1951-1967)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1968-1999)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "الحياة الاجتماعية في الأردن", "lessons": [ { "title": "الحياة الاجتماعية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن بين عامي (1951-1999)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "التعليم والثقافة في الأردن", "lessons": [ { "title": "التعليم العام في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1951-1987)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1988-2024)", "questions": [] }, { "title": "التعليم العالي والبحث العلمي في الأردن منذ عام 1951", "questions": [] }, { "title": "الحياة الثقافية في الأردن في عهد الإمارة", "questions": [] }, { "title": "الحياة الثقافية في الأردن منذ عام 1946", "questions": [] } ] },
                        { "title": "الأردن والقضية الفلسطينية", "lessons": [ { "title": "موقف الأردن من القضية الفلسطينية بين عامي (1916-1951)", "questions": [] }, { "title": "موقف الأردن من القضية الفلسطينية منذ عام 1951", "questions": [] }, { "title": "الوصاية والإعمار الهاشمي للمقدسات الدينية في القدس", "questions": [] } ] }
                    ]
                }
            },
             "دين": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة آل عمران (102-105)", "questions": [] }, { "title": "حديث اتقاء الشبهات", "questions": [] }, { "title": "من صور الضلال", "questions": [] }, { "title": "كرامة الإنسان في الشريعة", "questions": [] }, { "title": "الزواج-مشروعيته ومقدماته", "questions": [] }, { "title": "الجهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "جهود علماء المسلمين في خدمة القرآن", "questions": [] }, { "title": "العزيمة والرخصة", "questions": [] }, { "title": "معركة مؤتة (8 هجري)", "questions": [] }, { "title": "المحرمات من النساء", "questions": [] }, { "title": "التعايش الإنساني", "questions": [] }, { "title": "الحقوق الإجتماعية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة آل عمران (169-174)", "questions": [] }, { "title": "حديث - رضا الله تعالى", "questions": [] }, { "title": "فتح مكة (8 هجري)", "questions": [] }, { "title": "من خصائص الشريعة - الإيجابية", "questions": [] }, { "title": "شروط صحة عقد الزواج", "questions": [] }, { "title": "الحقوق المالية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "سورة الروم (21-24)", "questions": [] }, { "title": "مكانة السنة النبوية في التشريع", "questions": [] }, { "title": "مراعاة الأعراف في الشريعة", "questions": [] }, { "title": "حقوق الزوجين", "questions": [] }, { "title": "تنظيم النسل وتحديده", "questions": [] }, { "title": "الأمن الغذائي في الإسلام", "questions": [] }, { "title": "الإسلام والوحدة الوطنية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة البقرة (284-286)", "questions": [] }, { "title": "دلائل وجود الله تعالى", "questions": [] }, { "title": "إعجاز القرآن الكريم", "questions": [] }, { "title": "الأمر بالمعروف والنهي عن المنكر", "questions": [] }, { "title": "اليوم الآخر - احداثه وآثار الإيمان به", "questions": [] }, { "title": "الإجتهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "سورة الأعراف (31-34)", "questions": [] }, { "title": "مراعاة المصالح في الشريعة", "questions": [] }, { "title": "جهود علماء المسلمين في الحفاظ على السنة النبوية", "questions": [] }, { "title": "حديث - منهج الإسلام في الحياة", "questions": [] }, { "title": "رسائل النبي الى الملوك والزعماء في عصره", "questions": [] }, { "title": "يوم تبوك (9 هجري)", "questions": [] }, { "title": "الحقوق السياسية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة الفرقان (63-77)", "questions": [] }, { "title": "الطلاق", "questions": [] }, { "title": "العدة", "questions": [] }, { "title": "الوصية في الشريعة", "questions": [] }, { "title": "الميراث في الشريعة", "questions": [] }, { "title": "من خصائص الشريعة - الوسطية", "questions": [] }, { "title": "مجالات الوقف ودورها في التنمية", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "حديث - مفهوم الإفلاس بين الدنيا والآخرة", "questions": [] }, { "title": "مقاصد الشريعة", "questions": [] }, { "title": "منهج الإسلام في مكافحة الجريمة", "questions": [] }, { "title": "من وصايا النبي في حجة الوداع", "questions": [] }, { "title": "المسؤولية المجتمعية في الإسلام", "questions": [] }, { "title": "حقوق الإنسان بين الإسلام والإعلان العالمي لحقوق الإنسان", "questions": [] } ] }
                    ]
                }
            }
        };

        // Generate HTML for topic lists (Restored UI)
        function generateSemesterContent(subject, semester) {
            if (!topicsData[subject]?.[semester]) {
                console.error(`Data missing for ${subject}, ${semester}`);
                return `<div id="${subject}-${semester}" class="semester-content"><div class="unit-container"><div class="unit-title">Error</div><p>Content unavailable.</p></div></div>`;
            }
            const semesterData = topicsData[subject][semester];
            let html = `<div id="${subject}-${semester}" class="semester-content">
                            <div class="unit-container"> <div class="unit-title">${semesterData.title}</div> </div>`; // Semester Title container

            if (!semesterData.units?.length) {
                 html += `<div class="section"><p>No units available.</p></div>`;
            } else {
                 semesterData.units.forEach(unit => {
                     if (unit?.title) {
                         html += `<div class="section"> <div class="section-title">${unit.title}</div>`; // Unit Box + Title
                         if (unit.lessons?.length) {
                             unit.lessons.forEach(lesson => {
                                 if (lesson?.title) {
                                     html += `<div class="section-content" data-subject="${subject}" data-unit="${unit.title}" data-lesson="${lesson.title}">${lesson.title}</div>`; // Lesson Box
                                 }
                             });
                         } else { html += `<p style="margin:10px 0 0 0; font-size:14px; color:#64748b;">(No lessons)</p>`; }
                         html += `</div>`; // End Unit section
                     }
                 });
            }
            html += `</div>`; // End semester content
            return html;
        }

        // Generate all content on load
        function generateAllContent() {
            let contentHTML = '';
            const contentDiv = document.getElementById('content');
            if (!contentDiv) { console.error("#content not found!"); return; }
            Object.keys(topicsData).forEach(subject => {
                Object.keys(topicsData[subject]).forEach(semester => {
                    contentHTML += generateSemesterContent(subject, semester);
                });
            });
            contentDiv.innerHTML = contentHTML;
        }

        document.addEventListener('DOMContentLoaded', generateAllContent);

        // --- END OF topics.js ---
    </script>

    <script>
        // --- START OF questions.js ---

        // --- Global State ---
        let quizState = {
            currentQuestionIndex: 0,
            correctAnswers: 0,
            totalQuestions: 0,
            startTime: null,
            endTime: null,
            selectedAnswers: [], // User's response structure for each question
            questions: [],       // Current SHUFFLED list of questions for the quiz
            originalQuestions: [], // Original, unshuffled list for redo reference
            subject: '',
            unit: '',
            lesson: '',
            matchingState: { selectedPromptElement: null, userPairs: {} }
        };

        // --- DOM Element References ---
        let contentElement, quizViewElement, quizTitleElement, quizContainerElement, feedbackContainerElement, quizButtonsContainerElement, matchingSvgElement;
        let matchingArrowObserver = null;
        let resizeTimeout = null;

        // --- Utility Functions ---
        function shuffleArray(array) {
             // Creates a new shuffled array (doesn't modify original)
             const newArray = [...array];
             for (let i = newArray.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
             }
             return newArray;
         }

        function debounce(func, wait) { /* Included */
            let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); };
        }

        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            contentElement = document.getElementById('content');
            quizViewElement = document.getElementById('quiz-view');
            quizTitleElement = document.getElementById('quiz-title');
            quizContainerElement = document.getElementById('quiz-container');
            feedbackContainerElement = document.getElementById('feedback-container');
            quizButtonsContainerElement = document.getElementById('quiz-buttons-container');

            // Nav button listeners with confirmation
            document.querySelectorAll('.nav-btn[data-subject]').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress lost.")) return;
                    showTopicList();
                    document.querySelectorAll('.nav-btn[data-subject]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });
            document.querySelectorAll('.semester-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress lost.")) return;
                    showTopicList();
                    document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });

            window.addEventListener('resize', debounce(updateAllArrowPositions, 250));
            updateContent();
        });

        // --- View Management ---
        function showTopicList() {
            if (contentElement && quizViewElement) {
                contentElement.classList.remove('hidden');
                quizViewElement.classList.add('hidden');
                if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; }
                if(matchingSvgElement) matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa"/></marker></defs>';
                quizState = { // Reset state fully
                    currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null,
                    selectedAnswers: [], questions: [], originalQuestions: [], subject: '', unit: '', lesson: '',
                    matchingState: { selectedPromptElement: null, userPairs: {} }
                };
            }
        }
        function showQuizView() {
             if (contentElement && quizViewElement) {
                 contentElement.classList.add('hidden');
                 quizViewElement.classList.remove('hidden');
                 quizViewElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
        }

        // --- Core Functions ---
        function updateContent() { // Updates topic list view
            const activeSubjectBtn = document.querySelector('.nav-btn[data-subject].active');
            const activeSemesterBtn = document.querySelector('.semester-btn.active');
            if (!activeSubjectBtn || !activeSemesterBtn || !contentElement) return;
            const activeSubject = activeSubjectBtn.dataset.subject;
            const activeSemester = activeSemesterBtn.dataset.semester;
            contentElement.querySelectorAll('.semester-content').forEach(c => c.classList.remove('active'));
            const contentId = `${activeSubject}-${activeSemester}`;
            const semesterContentElement = contentElement.querySelector(`#${contentId}`);
            if (semesterContentElement) {
                semesterContentElement.classList.add('active');
                semesterContentElement.querySelectorAll('.section-content').forEach(lessonBox => { // Target lesson boxes
                    const newLessonBox = lessonBox.cloneNode(true);
                    lessonBox.parentNode.replaceChild(newLessonBox, lessonBox);
                    newLessonBox.addEventListener('click', () => handleSectionClick(newLessonBox.dataset.subject, newLessonBox.dataset.unit, newLessonBox.dataset.lesson));
                });
            } else { console.warn(`Semester content ID "${contentId}" not found.`); }
        }

        function handleSectionClick(subject, unit, lesson) { // Starts quiz if questions found
             if (!subject || !unit || !lesson) { alert("Error identifying topic."); return; }
            try {
                const originalQuestions = getQuestions(subject, unit, lesson); // Get original order
                if (originalQuestions?.length) {
                    startQuiz(subject, unit, lesson, originalQuestions); // Pass original list
                } else { showError(subject, unit, lesson); }
            } catch (error) {
                console.error("Section click error:", error);
                showError(subject, unit, lesson, "Error loading questions.");
            }
        }

        // Start/Redo Quiz - SHUFFLES questions
        function startQuiz(subject, unit, lesson, originalQuestions) {
            const shuffledQuestions = shuffleArray(originalQuestions); // Shuffle for this attempt

            quizState = {
                currentQuestionIndex: 0,
                correctAnswers: 0,
                totalQuestions: shuffledQuestions.length,
                startTime: new Date(),
                endTime: null,
                selectedAnswers: new Array(shuffledQuestions.length).fill(null),
                questions: shuffledQuestions,       // Use shuffled list for quiz flow
                originalQuestions: originalQuestions, // Store original list for redo
                subject: subject,
                unit: unit,
                lesson: lesson,
                matchingState: { selectedPromptElement: null, userPairs: {} }
            };

            if (quizTitleElement) quizTitleElement.textContent = `${lesson}`;
            showQuizView();
            displayQuestion();
        }

        // Display the current question
        function displayQuestion() {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement) return;
             const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
             if (!currentQuestion) { displayResults(); return; }

             quizContainerElement.innerHTML = ''; feedbackContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             if (matchingSvgElement) matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa"/></marker></defs>';
             if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; }

             const questionWrapper = document.createElement('div'); questionWrapper.className = 'question-display-wrapper';
             const progressText = document.createElement('div'); progressText.className = 'question-progress'; progressText.textContent = `Question ${quizState.currentQuestionIndex + 1} of ${quizState.totalQuestions}`; questionWrapper.appendChild(progressText);
             const questionText = document.createElement('p'); questionText.className = 'question-text'; questionText.innerHTML = `<strong>Q:</strong> ${currentQuestion.question || '?'}`; questionWrapper.appendChild(questionText);
             const typeWrapper = document.createElement('div'); typeWrapper.className = 'question-type-wrapper';

             try {
                  switch (currentQuestion.type) {
                      case "matching": renderMatching(currentQuestion, typeWrapper); setupArrowObserver(); break;
                      case "ordering": renderOrdering(currentQuestion, typeWrapper); break;
                      case "multiple_choice": default: renderMultipleChoice(currentQuestion, typeWrapper); break;
                  }
             } catch (renderError) { console.error("Render error:", renderError); typeWrapper.innerHTML = `<p style="color: red;">Error displaying question.</p>`; }
             questionWrapper.appendChild(typeWrapper); quizContainerElement.appendChild(questionWrapper);

             // Buttons
             const submitBtn = document.createElement('button'); submitBtn.className = 'btn submit-btn'; submitBtn.id = 'submit-btn'; submitBtn.textContent = 'Submit Answer'; submitBtn.onclick = checkAnswer;
             const nextBtn = document.createElement('button'); nextBtn.className = 'btn next-btn hidden'; nextBtn.id = 'next-btn'; nextBtn.textContent = quizState.currentQuestionIndex === quizState.totalQuestions - 1 ? 'See Results' : 'Next Question'; nextBtn.onclick = nextQuestion;
             quizButtonsContainerElement.appendChild(submitBtn); quizButtonsContainerElement.appendChild(nextBtn);

             // Initial submit button state
              submitBtn.disabled = true;
              if (currentQuestion.type !== 'multiple_choice' && currentQuestion.type !== 'ordering' && currentQuestion.type !== 'matching') {
                  submitBtn.disabled = false; // Enable for unknown types or types not needing selection
              }
              // Specific types enable button via their render/interaction logic
        }


        // --- Rendering Functions ---
        function renderMultipleChoice(question, container) {
             if (!question.options?.length) { container.textContent = 'Error: Options invalid.'; return; }
             const optionsDiv = document.createElement('div'); optionsDiv.className = 'options-container'; optionsDiv.id = 'options-list';
             question.options.forEach((option, index) => {
                 const id = `option-${index}`, lbl = document.createElement('label'); lbl.className = 'option-label'; lbl.htmlFor = id;
                 const inp = document.createElement('input'); inp.type = 'radio'; inp.name = 'question-option'; inp.value = index; inp.id = id; inp.className = 'option-input';
                 inp.addEventListener('change', () => { document.getElementById('submit-btn').disabled = false; });
                 const txt = document.createElement('span'); txt.className = 'option-text'; txt.textContent = option;
                 lbl.appendChild(inp); lbl.appendChild(txt); optionsDiv.appendChild(lbl);
             }); container.appendChild(optionsDiv);
        }
        function renderMatching(question, container) {
             if (!question.prompts?.length || !question.matches?.length || question.prompts.length !== question.matches.length) { container.textContent = 'Error: Matching data invalid.'; return; }
             quizState.matchingState.userPairs = {};
             const instr = document.createElement('p'); instr.className = 'matching-instructions'; instr.textContent = 'Click left item, then right item. Click matched item to deselect.'; container.appendChild(instr);
             const outer = document.createElement('div'); outer.style.position = 'relative';
             const matchCont = document.createElement('div'); matchCont.className = 'matching-container'; matchCont.id = 'matching-cols';
             const promCol = document.createElement('div'); promCol.className = 'matching-column'; promCol.id = 'prompts-column'; promCol.innerHTML = '<h4>Items</h4>';
             const matCol = document.createElement('div'); matCol.className = 'matching-column'; matCol.id = 'matches-column'; matCol.innerHTML = '<h4>Matches</h4>';
             matchingSvgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); matchingSvgElement.id = 'matching-arrow-svg'; matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa"/></marker></defs>'; outer.appendChild(matchingSvgElement);
             const shuffled = question.matches.map((t, i) => ({ t, i })).sort(() => 0.5 - Math.random());
             question.prompts.forEach((t, i) => { const it = document.createElement('div'); it.className = 'matching-item prompt-item'; it.textContent = t; it.dataset.index = i; it.id=`prompt-${i}`; it.onclick = handleMatchingClick; promCol.appendChild(it); });
             shuffled.forEach(o => { const it = document.createElement('div'); it.className = 'matching-item match-item'; it.textContent = o.t; it.dataset.index = o.i; it.id=`match-${o.i}`; it.onclick = handleMatchingClick; matCol.appendChild(it); });
             matchCont.append(promCol, matCol); outer.appendChild(matchCont); container.appendChild(outer);
        }
        function renderOrdering(question, container) {
            if (!question.items?.length) { container.textContent = 'Error: Ordering data invalid.'; return; }
            const num = question.items.length;
            const instr = document.createElement('p'); instr.className = 'ordering-instructions'; instr.textContent = `Select order number (1-${num}) for each.`; container.appendChild(instr);
            const orderCont = document.createElement('div'); orderCont.className = 'ordering-container'; orderCont.id = 'ordering-list';
            const checkDone = () => { const allSel = Array.from(orderCont.querySelectorAll('.ordering-select')).every(s => s.value !== ""); const btn = document.getElementById('submit-btn'); if(btn) btn.disabled = !allSel; };
            question.items.forEach((t, i) => {
                const div = document.createElement('div'); div.className = 'ordering-item'; div.dataset.originalIndex = i;
                const sel = document.createElement('select'); sel.className = 'ordering-select'; sel.dataset.itemIndex = i; const defOpt = document.createElement('option'); defOpt.value = ""; defOpt.textContent = "-"; defOpt.selected = true; defOpt.disabled = true; sel.appendChild(defOpt);
                for (let j = 1; j <= num; j++) { const opt = document.createElement('option'); opt.value = j; opt.textContent = j; sel.appendChild(opt); }
                sel.addEventListener('change', checkDone);
                const span = document.createElement('span'); span.className = 'ordering-text'; span.textContent = t;
                div.append(sel, span); orderCont.appendChild(div);
            }); container.appendChild(orderCont);
        }

        // --- Interaction Handlers ---
        function handleMatchingClick(event) { // Includes deselect logic
             const clicked = event.target; if (!clicked.classList.contains('matching-item')) return;
             const isPrompt = clicked.classList.contains('prompt-item'), isMatched = clicked.classList.contains('matched');
             let currentSel = quizState.matchingState.selectedPromptElement; const idx = clicked.dataset.index;

             if (isMatched) { // --- Deselection ---
                 let pIdx = -1, mIdx = -1;
                 if (isPrompt) { pIdx = idx; mIdx = quizState.matchingState.userPairs[pIdx]; }
                 else { mIdx = idx; pIdx = Object.keys(quizState.matchingState.userPairs).find(k => quizState.matchingState.userPairs[k] == mIdx); }
                 if (pIdx !== -1 && mIdx !== undefined) {
                     const pEl = document.getElementById(`prompt-${pIdx}`), mEl = document.getElementById(`match-${mIdx}`);
                     if (pEl) { pEl.classList.remove('matched'); pEl.style.cursor = 'pointer'; pEl.style.pointerEvents = 'auto'; }
                     if (mEl) { mEl.classList.remove('matched'); mEl.style.cursor = 'pointer'; mEl.style.pointerEvents = 'auto'; }
                     delete quizState.matchingState.userPairs[pIdx]; removeArrow(pIdx);
                     if (currentSel) currentSel.classList.remove('selected'); quizState.matchingState.selectedPromptElement = null;
                     document.getElementById('submit-btn').disabled = true; return;
                 }
             }
             // --- Selection / Matching ---
             if (isPrompt) { if (clicked === currentSel) { clicked.classList.remove('selected'); quizState.matchingState.selectedPromptElement = null; } else if (!isMatched) { if (currentSel) currentSel.classList.remove('selected'); clicked.classList.add('selected'); quizState.matchingState.selectedPromptElement = clicked; } }
             else { if (currentSel && !isMatched) { const pIdx = currentSel.dataset.index, mIdx = idx; quizState.matchingState.userPairs[pIdx] = parseInt(mIdx, 10); currentSel.classList.remove('selected'); currentSel.classList.add('matched'); clicked.classList.add('matched'); drawArrow(currentSel, clicked, pIdx); quizState.matchingState.selectedPromptElement = null; const total = document.querySelectorAll('.prompt-item').length, matched = document.querySelectorAll('.prompt-item.matched').length; if (total === matched) document.getElementById('submit-btn').disabled = false; } }
         }

        // --- Arrow Drawing ---
        function drawArrow(promptEl, matchEl, promptIndex) { /* Same */
            if (!matchingSvgElement || !promptEl || !matchEl) return; const svgR = matchingSvgElement.getBoundingClientRect(), pR = promptEl.getBoundingClientRect(), mR = matchEl.getBoundingClientRect(); const sx = pR.right - svgR.left, sy = pR.top + pR.height/2 - svgR.top, ex = mR.left - svgR.left, ey = mR.top + mR.height/2 - svgR.top; let line = matchingSvgElement.querySelector(`#arrow-${promptIndex}`); if (!line) { line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); line.id = `arrow-${promptIndex}`; matchingSvgElement.appendChild(line); } line.setAttribute('x1', sx); line.setAttribute('y1', sy); line.setAttribute('x2', ex); line.setAttribute('y2', ey); line.style.opacity = '1';
         }
        function removeArrow(promptIndex) { /* Same */
            if (!matchingSvgElement) return; const line = matchingSvgElement.querySelector(`#arrow-${promptIndex}`); if (line) { line.style.opacity = '0'; setTimeout(() => line.remove(), 300); }
         }
        function updateAllArrowPositions() { /* Same */
             if (!matchingSvgElement || !quizState || quizState.questions[quizState.currentQuestionIndex]?.type !== 'matching') return; const pairs = quizState.matchingState.userPairs; for (const pIdx in pairs) { if (pairs.hasOwnProperty(pIdx)) { const mIdx = pairs[pIdx], pEl = document.getElementById(`prompt-${pIdx}`), mEl = document.getElementById(`match-${mIdx}`); if (pEl && mEl) drawArrow(pEl, mEl, pIdx); } }
         }
        function setupArrowObserver() { /* Same */
            const target = document.getElementById('matching-cols'); if (!target) return; const cfg = { attributes: true, childList: true, subtree: true, characterData: true }; const cb = debounce(() => updateAllArrowPositions(), 100); matchingArrowObserver = new MutationObserver(cb); matchingArrowObserver.observe(target, cfg);
         }

        // --- Answer Checking ---
        function checkAnswer() {
            if (!feedbackContainerElement || !quizButtonsContainerElement) return;
            if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; } // Disconnect observer
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex]; let result = { isCorrect: false, feedback: '', userResponse: null, scoreIncrement: 0 };
            try { switch (currentQuestion.type) { case "matching": result = checkMatching(currentQuestion); break; case "ordering": result = checkOrdering(currentQuestion); break; case "multiple_choice": default: result = checkMultipleChoice(currentQuestion); break; } }
            catch (error) { console.error("Check error:", error); result = { isCorrect: false, feedback: '<div class="incorrect-feedback">Error checking.</div>', userResponse: null, scoreIncrement: 0 }; }
            quizState.selectedAnswers[quizState.currentQuestionIndex] = result.userResponse; if (result.isCorrect) quizState.correctAnswers++; // Only count fully correct
            feedbackContainerElement.innerHTML = result.feedback; feedbackContainerElement.classList.remove('hidden');
            disableInputs(); const submitBtn = quizButtonsContainerElement.querySelector('#submit-btn'), nextBtn = quizButtonsContainerElement.querySelector('#next-btn'); if(submitBtn) submitBtn.classList.add('hidden'); if(nextBtn) nextBtn.classList.remove('hidden');
        }
        function checkMultipleChoice(question) { /* Same */
            const sel = document.querySelector('input[name="question-option"]:checked'); if (!sel) return { isCorrect: false, feedback: '<div class="incorrect-feedback">Select answer.</div>', userResponse: null, scoreIncrement: 0 }; const idx = parseInt(sel.value, 10), correctText = question.answer, selText = question.options[idx], isCorrect = selText === correctText; document.querySelectorAll('.option-label').forEach((lbl, i) => { const inp = lbl.querySelector('input'); if (question.options[i] === correctText) lbl.classList.add('correct-option'); if (inp && parseInt(inp.value, 10) === idx && !isCorrect) lbl.classList.add('incorrect-option'); }); const fb = isCorrect ? '<div class="correct-feedback">Correct! ✓</div>' : `<div class="incorrect-feedback">Incorrect. <span>Correct: ${correctText}</span></div>`; return { isCorrect, feedback: fb, userResponse: idx, scoreIncrement: isCorrect ? 1 : 0 };
        }
        function checkMatching(question) { /* Same */
             const userPairs = quizState.matchingState.userPairs, correctPairs = question.answer || {}, total = Object.keys(correctPairs).length; let correctCount = 0; if (total === 0) return { isCorrect: true, feedback: '<div class="correct-feedback">N/A</div>', userResponse: userPairs, scoreIncrement: 0 }; for (const pIdx in correctPairs) { if (userPairs.hasOwnProperty(pIdx) && userPairs[pIdx] === correctPairs[pIdx]) correctCount++; } const isFull = correctCount === total; let fb = ''; if (isFull) fb = `<div class="correct-feedback">Correct! ✓ (${correctCount}/${total})</div>`; else if (correctCount > 0) fb = `<div class="partial-feedback">Partial. Matched ${correctCount}/${total}.</div>`; else fb = `<div class="incorrect-feedback">Incorrect. Matched 0/${total}.</div>`; return { isCorrect: isFull, feedback: fb, userResponse: userPairs, scoreIncrement: isFull ? 1 : 0 };
        }
        function checkOrdering(question) { /* Same */
            const items = question.items || [], correctOrder = question.answer || [], numItems = items.length; if (numItems === 0 || !Array.isArray(correctOrder) || numItems !== correctOrder.length) { console.error("Invalid ordering data:", question); return { isCorrect: false, feedback: '<div class="incorrect-feedback">Error: Invalid setup.</div>', userResponse: null, scoreIncrement: 0 }; } const userOrderMap = {}, selectedNumbers = new Set(); let allSelected = true, hasDuplicate = false; const selects = document.querySelectorAll('#ordering-list .ordering-select'); if (selects.length !== numItems) { return { isCorrect: false, feedback: '<div class="incorrect-feedback">Error processing form.</div>', userResponse: null, scoreIncrement: 0 }; } selects.forEach(sel => { const idx = parseInt(sel.dataset.itemIndex, 10), val = sel.value; if (val === "") allSelected = false; else { const num = parseInt(val, 10); if (isNaN(num) || num < 1 || num > numItems) { allSelected = false; return; } userOrderMap[idx] = num; if (selectedNumbers.has(num)) hasDuplicate = true; selectedNumbers.add(num); } }); if (!allSelected) return { isCorrect: false, feedback: '<div class="incorrect-feedback">Select order for all.</div>', userResponse: null, scoreIncrement: 0 }; if (hasDuplicate || selectedNumbers.size !== numItems) return { isCorrect: false, feedback: `<div class="incorrect-feedback">Use each number (1-${numItems}) once.</div>`, userResponse: null, scoreIncrement: 0 }; const userOrderedItems = new Array(numItems).fill(null); let ok = true; for (const idxStr in userOrderMap) { if (userOrderMap.hasOwnProperty(idxStr)) { const idx = parseInt(idxStr, 10), text = items[idx], pos = userOrderMap[idx] - 1; if (text === undefined || pos < 0 || pos >= numItems || userOrderedItems[pos] !== null) { ok = false; break; } userOrderedItems[pos] = text; } } if (!ok || userOrderedItems.some(i => i === null)) { console.error("Construction Fail:", userOrderMap, userOrderedItems); return { isCorrect: false, feedback: '<div class="incorrect-feedback">Error processing sequence.</div>', userResponse: userOrderedItems, scoreIncrement: 0 }; } const isCorrect = JSON.stringify(userOrderedItems) === JSON.stringify(correctOrder); let fb = ''; if (isCorrect) fb = `<div class="correct-feedback">Correct! ✓</div>`; else fb = `<div class="incorrect-feedback">Incorrect. <span>Correct: ${correctOrder.join(' → ')}</span></div>`; selects.forEach(sel => { const idx = parseInt(sel.dataset.itemIndex, 10), userN = userOrderMap[idx], correctN = correctOrder.indexOf(items[idx]) + 1; sel.style.borderColor = (userN === correctN) ? '#16a34a' : '#ef4444'; sel.style.borderWidth = '2px'; }); return { isCorrect, feedback: fb, userResponse: userOrderedItems, scoreIncrement: isCorrect ? 1 : 0 };
        }
        function disableInputs() { /* Same */
             document.querySelectorAll('input[name="question-option"], .ordering-select').forEach(i => i.disabled = true); document.querySelectorAll('.option-label').forEach(l => l.style.cursor = 'default'); document.querySelectorAll('.matching-item').forEach(i => { i.style.pointerEvents = 'none'; i.style.cursor = 'default'; });
        }

        // --- Navigation and Results ---
        function nextQuestion() { /* Same */
            quizState.currentQuestionIndex++; if (quizState.currentQuestionIndex < quizState.totalQuestions) displayQuestion(); else { quizState.endTime = new Date(); displayResults(); }
        }
        function displayResults() { // ADDED Redo Button
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             quizTitleElement.textContent = 'Quiz Results'; // Update title for results

             const time = quizState.endTime && quizState.startTime ? (quizState.endTime - quizState.startTime) / 1000 : 0; const mins = Math.floor(time / 60), secs = Math.floor(time % 60); const timeStr = time > 0 ? `${mins}m ${secs}s` : 'N/A';
             const score = quizState.totalQuestions > 0 ? (quizState.correctAnswers / quizState.totalQuestions) * 100 : 0;
             let msg = ''; // Performance message logic...
             if (quizState.totalQuestions === 0) msg = 'No questions.'; else if (score >= 90) msg = 'Excellent! 🎉'; else if (score >= 70) msg = 'Good work! 👍'; else if (score >= 50) msg = 'Not bad! 💪'; else msg = 'Needs practice. 📚';

             const resultsDiv = document.createElement('div'); resultsDiv.className = 'results-container';
             resultsDiv.innerHTML = `
                <h2 class="results-header">${msg}</h2>
                <div class="results-score"> <div class="score-circle"> <span class="score-number">${score.toFixed(0)}</span> <span class="score-percent-sign">%</span> </div> </div>
                <div class="results-details">
                    <p><strong>Subject:</strong> ${quizState.subject || 'N/A'}</p> <p><strong>Unit:</strong> ${quizState.unit || 'N/A'}</p> <p><strong>Lesson:</strong> ${quizState.lesson || 'N/A'}</p>
                    <p><strong>Correct:</strong> ${quizState.correctAnswers} / ${quizState.totalQuestions}</p> <p><strong>Time:</strong> ${timeStr}</p>
                </div>`;
             quizContainerElement.appendChild(resultsDiv);

             // Results Buttons
             const actionsDiv = document.createElement('div'); actionsDiv.className = 'results-actions quiz-buttons'; // Use quiz-buttons for consistent layout
             const redoBtn = document.createElement('button'); // NEW Redo button
             redoBtn.className = 'btn redo-btn'; redoBtn.textContent = 'Redo Quiz';
             redoBtn.onclick = () => {
                 // Restart quiz with the original (unshuffled) list, which will be shuffled again in startQuiz
                 startQuiz(quizState.subject, quizState.unit, quizState.lesson, quizState.originalQuestions);
             };
             actionsDiv.appendChild(redoBtn);

             if (quizState.totalQuestions > 0) { // Show Review only if questions exist
                 const reviewBtn = document.createElement('button'); reviewBtn.id = 'review-btn'; reviewBtn.className = 'btn review-btn'; reviewBtn.textContent = 'Review Answers'; reviewBtn.onclick = reviewAnswers;
                 actionsDiv.appendChild(reviewBtn);
             }
             const backTopicsBtn = document.createElement('button'); backTopicsBtn.className = 'btn back-to-topics-btn'; backTopicsBtn.textContent = 'Back to Topics'; backTopicsBtn.onclick = showTopicList;
             actionsDiv.appendChild(backTopicsBtn); // This will be on the far right due to justify-content: flex-end on quiz-buttons

              // Adjust button order if needed (e.g., Back to Topics first)
              // actionsDiv.insertBefore(backTopicsBtn, actionsDiv.firstChild); // Example: Move back button first


             quizButtonsContainerElement.appendChild(actionsDiv);
         }

        // --- Answer Review ---
        function reviewAnswers() { // Renders review into quiz container
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             quizTitleElement.textContent = `Review: ${quizState.lesson}`;

             const reviewDiv = document.createElement('div'); reviewDiv.className = 'review-container';
             quizState.questions.forEach((q, i) => { // Iterate through SHUFFLED questions used in quiz
                 const reviewBox = document.createElement('div');
                 const userAns = quizState.selectedAnswers[i]; // Get user answer for this position
                 let { correctnessClass, statusText } = calculateReviewStatus(q, userAns);
                 reviewBox.className = `question-review ${correctnessClass}`;
                 reviewBox.innerHTML = `<div class="review-question-header"><span class="review-question-number">Question ${i + 1} (${q.type.replace('_',' ')})</span><span class="review-status">${statusText}</span></div><p class="review-question-text">${q.question||'?'}</p><div id="review-answer-content-${i}"></div>`;
                 reviewDiv.appendChild(reviewBox);
                 const contentArea = reviewBox.querySelector(`#review-answer-content-${i}`);
                 if (contentArea) {
                     try { switch(q.type){ case "matching": reviewMatchingReview(q, userAns, contentArea); break; case "ordering": reviewOrderingReview(q, userAns, contentArea); break; case "multiple_choice": default: reviewMultipleChoiceReview(q, userAns, contentArea); break; } }
                     catch(e){ console.error("Review render error:", e); contentArea.innerHTML = `<p style="color:red;">Error displaying review.</p>`; }
                 }
             });
             quizContainerElement.appendChild(reviewDiv);

             // Review Buttons
             const actionsDiv = document.createElement('div'); actionsDiv.className = 'review-actions quiz-buttons'; // Use shared class
             const backResultsBtn = document.createElement('button'); backResultsBtn.className = 'btn back-btn'; backResultsBtn.textContent = '← Back to Results'; backResultsBtn.onclick = displayResults; actionsDiv.appendChild(backResultsBtn);
             const backTopicsBtn = document.createElement('button'); backTopicsBtn.className = 'btn back-to-topics-btn'; backTopicsBtn.textContent = 'Back to Topics'; backTopicsBtn.onclick = showTopicList; actionsDiv.appendChild(backTopicsBtn);
             quizButtonsContainerElement.appendChild(actionsDiv);
         }
        function calculateReviewStatus(question, userAnswer) { /* Same */
            let cl = 'incorrect', st = '✗ Incorrect', correct = false; try { switch (question.type) { case "matching": const cp = question.answer || {}, tot = Object.keys(cp).length; let ct = 0; if (tot > 0 && userAnswer && typeof userAnswer === 'object') { for (const pIdx in cp) { if (userAnswer.hasOwnProperty(pIdx) && userAnswer[pIdx] === cp[pIdx]) ct++; } } correct = tot > 0 && (ct === tot); if (correct) { cl = 'correct'; st = '✓ Correct'; } else if (ct > 0) { cl = 'partial'; st = `~ Partial (${ct}/${tot})`; } break; case "ordering": if (userAnswer && Array.isArray(userAnswer) && question.answer && Array.isArray(question.answer)) { correct = JSON.stringify(userAnswer) === JSON.stringify(question.answer); } cl = correct ? 'correct' : 'incorrect'; st = correct ? '✓ Correct' : '✗ Incorrect'; break; case "multiple_choice": default: if (userAnswer !== null && question.options && question.answer) { correct = (question.options[userAnswer] === question.answer); } cl = correct ? 'correct' : 'incorrect'; st = correct ? '✓ Correct' : '✗ Incorrect'; break; } } catch(e) { console.error("CalcReviewStatus Error:", e); } return { correctnessClass: cl, statusText: st };
         }
        function reviewMultipleChoiceReview(question, userAnswerIndex, container) { /* Same */
            const div = document.createElement('div'); div.className = 'review-mc-answer'; const userTxt = (userAnswerIndex !== null && question.options?.[userAnswerIndex] !== undefined) ? question.options[userAnswerIndex] : 'No answer'; const isOk = (userAnswerIndex !== null) && (userTxt === question.answer); div.innerHTML = `<p><strong>Your answer:</strong> <span class="user-answer-text ${isOk ? 'correct' : (userAnswerIndex !== null ? 'incorrect' : '')}">${userTxt}</span></p>${!isOk ? `<p><strong>Correct answer:</strong> <span class="correct-answer-text">${question.answer || 'N/A'}</span></p>` : ''}`; container.appendChild(div);
         }
        function reviewMatchingReview(question, userPairs, container) { /* Same */
             const div = document.createElement('div'); div.className = 'review-matching-answer'; div.innerHTML = `<p><strong>Matching Review:</strong></p>`; const grid = document.createElement('div'); grid.className = 'review-matching-grid'; const pCol = document.createElement('div'); pCol.className = 'review-matching-column'; const mCol = document.createElement('div'); mCol.className = 'review-matching-column'; const correct = question.answer || {}; (question.prompts || []).forEach((pTxt, pIdx) => { const userMIdx = userPairs ? userPairs[pIdx] : null, correctMIdx = correct[pIdx], isPairOk = userMIdx !== null && userMIdx === correctMIdx; const pDiv = document.createElement('div'); pDiv.textContent = pTxt; const mDiv = document.createElement('div'); const userMTxt = (userMIdx !== null && question.matches?.[userMIdx]) ? question.matches[userMIdx] : '(No match)'; const correctMTxt = (correctMIdx !== undefined && question.matches?.[correctMIdx]) ? question.matches[correctMIdx] : '(N/A)'; if (isPairOk) { pDiv.className='review-matched-pair-correct'; mDiv.textContent = correctMTxt; mDiv.className='review-matched-pair-correct'; } else { pDiv.className='review-matched-pair-incorrect'; mDiv.innerHTML = `<span style="text-decoration: line-through; color: #dc2626;">${userMTxt}</span> <span style="color: #059669;">(${correctMTxt})</span>`; mDiv.className='review-matched-pair-incorrect'; } pCol.appendChild(pDiv); mCol.appendChild(mDiv); }); grid.append(pCol, mCol); div.appendChild(grid); container.appendChild(div);
         }
        function reviewOrderingReview(question, userOrderedItems, container) { /* Same */
             const div = document.createElement('div'); div.className = 'review-ordering-answer'; const correctOrd = question.answer || []; const isOk = userOrderedItems && (JSON.stringify(userOrderedItems) === JSON.stringify(correctOrd)); div.innerHTML = `<p><strong>Ordering Review:</strong></p>`; const list = document.createElement('div'); list.className = 'review-ordering-list'; correctOrd.forEach((corrTxt, corrIdx) => { const item = document.createElement('div'); item.className = 'review-ordering-list-item'; const userIdx = userOrderedItems ? userOrderedItems.indexOf(corrTxt) : -1; const userNum = (userIdx !== -1) ? userIdx + 1 : null; const correctNum = corrIdx + 1; let numSpan = ''; if (userNum === correctNum) numSpan = `<span class="review-order-number review-order-correct">${userNum}.</span>`; else if (userNum !== null) numSpan = `<span class="review-order-number review-order-incorrect">${userNum}.</span> <span class="review-order-number review-order-correct">(${correctNum}.)</span>`; else numSpan = `<span class="review-order-number review-order-incorrect">(N/P)</span> <span class="review-order-number review-order-correct">(${correctNum}.)</span>`; item.innerHTML = `${numSpan} ${corrTxt}`; list.appendChild(item); }); div.appendChild(list); if (!isOk && userOrderedItems) div.innerHTML += `<p style="margin-top:10px;"><strong>Your Order:</strong> ${userOrderedItems.join(' → ')}</p>`; container.appendChild(div);
         }

        // --- Error Display ---
        function showError(subject, unit, lesson, message = '') { // Renders error into quiz container
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             showQuizView(); quizTitleElement.textContent = 'Error';
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             const msg = message || `Sorry, no questions available for ${lesson} in ${unit}.`;
             const errDiv = document.createElement('div'); errDiv.className = 'error-display'; errDiv.innerHTML = `<div class="error-message">${msg}</div>`;
             const backBtn = document.createElement('button'); backBtn.className = 'btn back-to-topics-btn'; backBtn.textContent = 'Back to Topics'; backBtn.onclick = showTopicList; errDiv.appendChild(backBtn);
             quizContainerElement.appendChild(errDiv);
        }

        // --- Get Questions Data ---
        function getQuestions(subject, unitTitle, lessonTitle) { // Adds default type if missing
             const semBtn = document.querySelector('.semester-btn.active'); if (!semBtn) { console.error("No active semester."); return []; } const sem = semBtn.dataset.semester;
             if (!subject || !unitTitle || !lessonTitle || !sem) { console.error("Missing params for getQuestions."); return []; }
             try {
                 const semData = topicsData[subject]?.[sem]; const units = semData?.units; if (!units) { console.warn(`Data missing: ${subject} -> ${sem}`); return []; }
                 const unit = units.find(u => u?.title === unitTitle); const lessons = unit?.lessons; if (!lessons) { console.warn(`Unit "${unitTitle}" or lessons missing.`); return []; }
                 const lesson = lessons.find(l => l?.title === lessonTitle); if (!lesson) { console.warn(`Lesson "${lessonTitle}" missing.`); return []; }
                 if (lesson.questions?.length) { return lesson.questions.map(q => ({ ...(q.type ? {} : {type: 'multiple_choice'}), ...q })); } else { return []; } // Default to MC if type missing
             } catch (e) { console.error("Error finding questions:", e); return []; }
         }

        // --- END OF questions.js ---
    </script>

</body>
</html>
