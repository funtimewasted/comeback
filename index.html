<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Question Bank</title>
    <style>
        /* --- START OF styles.css --- */
        :root {
            /* Light Theme Variables */
            --body-bg: #f8fafc;
            --container-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --text-heading: #0f172a;
            --border-color: #e2e8f0;
            --border-color-hover: #cbd5e1;
            --accent-color: #2563eb;
            --accent-color-dark: #1d4ed8;
            --accent-color-light: #dbeafe;
            --button-bg: #ffffff;
            --button-border: #e0e0e0;
            --button-text: #334155;
            --button-hover-bg: #f1f5f9;
            --button-active-bg: #0f172a;
            --button-active-text: #ffffff;
            --button-secondary-bg: #64748b;
            --button-secondary-hover-bg: #475569;
            --button-disabled-bg: #94a3b8;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --feedback-bg: #f1f5f9;
            --feedback-border: #e2e8f0;
            --correct-bg: #dcfce7;
            --correct-border: #16a34a;
            --correct-text: #065f46;
            --incorrect-bg: #fee2e2;
            --incorrect-border: #ef4444;
            --incorrect-text: #b91c1c;
            --partial-bg: #fef9c3;
            --partial-border: #f59e0b;
            --partial-text: #854d0e;
            --shadow-color: rgba(0,0,0,0.05);
            --matched-item-bg: #e5e7eb;
            --matched-item-border: #9ca3af;
            --toggle-icon: '☀️';
        }

        body.dark-theme {
            /* Dark Theme Variable Overrides */
            --body-bg: #0f172a; /* Dark blue */
            --container-bg: #1e293b; /* Slightly lighter blue */
            --text-color: #cbd5e1; /* Lighter gray */
            --text-muted: #94a3b8; /* Medium gray */
            --text-heading: #f1f5f9; /* Off-white */
            --border-color: #334155; /* Darker gray-blue */
            --border-color-hover: #475569;
            --accent-color: #3b82f6; /* Brighter blue for dark */
            --accent-color-dark: #2563eb;
            --accent-color-light: #1e3a8a; /* Darker blue for selection */
            --button-bg: #334155;
            --button-border: #475569;
            --button-text: #e2e8f0;
            --button-hover-bg: #475569;
            --button-active-bg: #f1f5f9;
            --button-active-text: #0f172a;
            --button-secondary-bg: #475569;
            --button-secondary-hover-bg: #52525b; /* Zinc */
            --button-disabled-bg: #334155;
            --input-bg: #0f172a;
            --input-border: #475569;
            --feedback-bg: #1e293b;
            --feedback-border: #334155;
            --correct-bg: #064e3b; /* Dark green */
            --correct-border: #10b981;
            --correct-text: #a7f3d0;
            --incorrect-bg: #7f1d1d; /* Dark red */
            --incorrect-border: #f87171;
            --incorrect-text: #fecaca;
            --partial-bg: #713f12; /* Dark amber */
            --partial-border: #fbbf24;
            --partial-text: #fef08a;
            --shadow-color: rgba(0,0,0,0.2);
            --matched-item-bg: #475569;
            --matched-item-border: #64748b;
            --toggle-icon: '🌙';
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
            color: var(--text-heading);
        }

        #theme-toggle {
            background: none;
            border: 1px solid var(--button-border);
            color: var(--text-muted);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px; /* Adjust size for icon */
            line-height: 1;
            transition: all 0.2s ease;
        }
         #theme-toggle::before {
             content: var(--toggle-icon); /* Display icon */
             display: inline-block;
             margin-right: 4px;
         }

        #theme-toggle:hover {
            background-color: var(--button-hover-bg);
            border-color: var(--border-color-hover);
            color: var(--text-color);
        }

        /* Nav Section hiding */
        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
             transition: opacity 0.3s ease, max-height 0.3s ease, visibility 0.3s ease, margin 0.3s ease, padding 0.3s ease;
             overflow: hidden;
             max-height: 500px; /* Adjust if nav gets taller */
             opacity: 1;
             visibility: visible;
        }
         .nav-section.hidden {
             max-height: 0;
             opacity: 0;
             margin-bottom: 0;
             padding-top: 0;
             padding-bottom: 0;
             border: none; /* Remove any potential borders when hidden */
             visibility: hidden;
         }

        .subjects { display: flex; flex-wrap: wrap; gap: 10px; }
        .secondary-nav { display: flex; gap: 10px; align-items: center; }

        .nav-btn {
            padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;
            display: flex; align-items: center; gap: 6px;
            background-color: var(--button-bg); border: 1px solid var(--button-border);
            transition: all 0.2s ease; color: var(--button-text);
        }
        .nav-btn:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .nav-btn.active { background-color: var(--button-active-bg); color: var(--button-active-text); border-color: var(--button-active-bg); }
        .nav-btn.active span {
            /* Invert icon color for dark theme active state */
            body.dark-theme & { filter: none; } /* Keep default icon color in dark theme active */
            body:not(.dark-theme) & { filter: brightness(0) invert(1); } /* Invert icon color in light theme active */
        }


        .semester-toggle { display: flex; gap: 5px; background-color: var(--feedback-bg); padding: 4px; border-radius: 6px; border: 1px solid var(--button-border); }
        .semester-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; background: none; color: var(--text-muted); transition: all 0.2s ease; }
        .semester-btn.active { background-color: var(--container-bg); color: var(--text-heading); box-shadow: 0 1px 3px var(--shadow-color); }

        /* --- Topic List Styles (#content) --- */
        #content { /* remains visible */ }
        .unit-container { margin-bottom: 20px; } /* Container for semester title */
        .unit-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text-heading); padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .section { /* Represents a Unit Box */
            background-color: var(--container-bg); border-radius: 12px; padding: 20px 25px; box-shadow: 0 1px 3px var(--shadow-color); border: 1px solid var(--border-color); margin-bottom: 20px;
        }
        .semester-content > .section:last-of-type { margin-bottom: 0; }
        .section-title { /* Unit Title */
            font-size: 17px; font-weight: 600; margin-bottom: 15px; color: var(--text-heading);
        }
        .section-content { /* Lesson Box */
            padding: 15px; background-color: var(--button-bg); border-radius: 8px; border: 1px solid var(--button-border); margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; color: var(--button-text); display: block; text-align: left;
        }
        .section-content:last-child { margin-bottom: 0; }
        .section-content:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); transform: translateY(-1px); }
        .lesson-q-count { font-size: 0.85em; color: var(--text-muted); margin-left: 8px; font-weight: 400; }
        .semester-content { display: none; }
        .semester-content.active { display: block; }

        /* --- Quiz View Styles (#quiz-view) --- */
        #quiz-view { padding: 20px 0; }
        #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        #quiz-title { font-size: 20px; font-weight: 600; color: var(--text-heading); }
        #quiz-container { margin-bottom: 20px; }
        .question-type-wrapper { padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--container-bg); margin-bottom: 20px; box-shadow: 0 1px 2px var(--shadow-color); }
        .question-progress { font-size: 14px; color: var(--text-muted); margin-bottom: 15px; text-align: right; }
        .question-text { font-size: 18px; margin-bottom: 25px; line-height: 1.6; color: var(--text-color); }
        .question-text strong { font-weight: 600; margin-right: 5px; }

        /* --- MC Specific --- */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 0; }
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background-color: var(--input-bg); }
        .option-label:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .option-label input:checked + .option-text { font-weight: 500; color: var(--accent-color); }
        .option-label input:checked { accent-color: var(--accent-color); }
        .option-input { margin-right: 15px; flex-shrink: 0; }
        .option-text { flex-grow: 1; font-size: 16px; color: var(--text-color); }

        /* --- Matching Specific --- */
        .matching-instructions { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
        .matching-container { position: relative; display: flex; justify-content: space-between; gap: 5%; margin-bottom: 0; }
        .matching-column { flex-basis: 47%; display: flex; flex-direction: column; gap: 10px; }
        .matching-column h4 { margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .matching-item { padding: 10px 15px; border: 1px solid var(--input-border); background-color: var(--input-bg); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; display: flex; align-items: center; min-height: 30px; color: var(--text-color); }
        .matching-item:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .matching-item.selected { background-color: var(--accent-color-light); border-color: var(--accent-color); font-weight: 500; }
        .matching-item.matched { background-color: var(--matched-item-bg); border-color: var(--matched-item-border); cursor: pointer; opacity: 1.0; }
        #matching-arrow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 1; }
        #matching-arrow-svg line { stroke: var(--accent-color); stroke-width: 2; transition: all 0.3s ease; marker-end: url(#arrowhead); }
        #matching-arrow-svg #arrowhead polygon { fill: var(--accent-color); }

        /* --- Ordering Specific --- */
        .ordering-instructions { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
        .ordering-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 0; }
        .ordering-item { display: flex; align-items: center; padding: 10px 15px; border: 1px solid var(--border-color); background-color: var(--input-bg); border-radius: 6px; }
        .ordering-select { margin-right: 15px; padding: 5px 8px; border-radius: 4px; border: 1px solid var(--input-border); font-size: 14px; min-width: 60px; background-color: var(--input-bg); color: var(--text-color); }
        .ordering-text { flex-grow: 1; font-size: 16px; color: var(--text-color); }

        /* --- Feedback & Buttons --- */
        #feedback-container { padding: 15px; margin-top: 20px; border-radius: 6px; background-color: var(--feedback-bg); border: 1px solid var(--feedback-border); }
        #feedback-container.hidden { display: none; }
        .correct-feedback { color: var(--correct-text); font-weight: 600; font-size: 16px; }
        .incorrect-feedback { color: var(--incorrect-text); font-weight: 600; font-size: 16px; }
        .incorrect-feedback span { display: block; font-weight: 500; margin-top: 8px; font-size: 15px; color: var(--text-muted); line-height: 1.5; }
        .partial-feedback { color: var(--partial-text); font-weight: 600; font-size: 16px; }

        /* Highlighting */
        .correct-option { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; }
        .correct-option .option-text { color: var(--correct-text) !important; }
        .incorrect-option { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; }
        .incorrect-option .option-text { color: var(--incorrect-text) !important; }

        /* Button container */
        #quiz-buttons-container { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .results-actions, .review-actions { justify-content: space-between; }
        .results-actions .back-to-topics-btn { margin-left: auto; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s ease; line-height: 1.5; background-color: var(--button-bg); color: var(--button-text); border: 1px solid var(--button-border); }
        .btn:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .submit-btn { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .submit-btn:hover:not(:disabled) { background-color: var(--accent-color-dark); border-color: var(--accent-color-dark); }
        .submit-btn:disabled { background-color: var(--button-disabled-bg); border-color: var(--button-disabled-bg); color: var(--text-muted); cursor: not-allowed; }
        .next-btn { background-color: var(--correct-border); color: var(--correct-text); border-color: var(--correct-border); }
        body.dark-theme .next-btn { color: white; }
        .next-btn:hover { filter: brightness(1.1); }
        .review-btn { background-color: var(--correct-border); color: var(--correct-text); border-color: var(--correct-border); }
        body.dark-theme .review-btn { color: white; }
        .review-btn:hover { filter: brightness(1.1); }
        .redo-btn { background-color: #f97316; color: white; border-color: #f97316; }
        .redo-btn:hover { background-color: #ea580c; border-color: #ea580c; }
        .close-btn, .back-to-topics-btn, .back-btn { background-color: var(--button-secondary-bg); color: white; border-color: var(--button-secondary-bg); }
        .close-btn:hover, .back-to-topics-btn:hover, .back-btn:hover { background-color: var(--button-secondary-hover-bg); border-color: var(--button-secondary-hover-bg); }


        .hidden { display: none !important; }

        /* --- Error Message Styles --- */
        .error-display { padding: 30px; text-align: center; background-color: var(--incorrect-bg); border: 1px solid var(--incorrect-border); border-radius: 8px; }
        .error-message { color: var(--incorrect-text); font-weight: 500; margin-bottom: 20px; }

        /* --- Results Styles --- */
        .results-container { padding: 10px 0; text-align: center; }
        .results-header { font-size: 24px; margin-bottom: 25px; color: var(--text-heading); }
        .results-score { margin: 30px 0 35px 0; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; background-color: var(--feedback-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; border: 6px solid var(--accent-color); box-shadow: 0 0 15px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .score-number { font-size: 40px; font-weight: bold; color: var(--text-heading); line-height: 1; }
        .score-percent-sign { font-size: 18px; font-weight: 500; color: var(--text-muted); margin-top: 2px; }
        .results-details { max-width: 450px; margin: 0 auto 35px auto; text-align: left; background-color: var(--feedback-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--feedback-border); }
        .results-details p { margin: 10px 0; font-size: 15px; color: var(--text-color); }
        .results-details p strong { color: var(--text-heading); min-width: 120px; display: inline-block; }

        /* --- Review Answers Styles --- */
        .review-container { padding: 10px 0; }
        .question-review { padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color); border-left-width: 5px; background-color: var(--container-bg); }
        .question-review.correct { border-left-color: var(--correct-border); }
        .question-review.incorrect { border-left-color: var(--incorrect-border); }
        .question-review.partial { border-left-color: var(--partial-border); }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .review-question-number { font-weight: 600; color: var(--text-heading); font-size: 16px; }
        .review-status { font-weight: 600; font-size: 14px; padding: 3px 8px; border-radius: 4px; text-align: center; }
        .question-review.correct .review-status { color: var(--correct-text); background-color: var(--correct-bg); }
        .question-review.incorrect .review-status { color: var(--incorrect-text); background-color: var(--incorrect-bg); }
        .question-review.partial .review-status { color: var(--partial-text); background-color: var(--partial-bg); }
        .review-question-text { margin-bottom: 15px; font-size: 16px; color: var(--text-color); }

        /* Review specific content */
        .review-mc-answer, .review-matching-answer, .review-ordering-answer { background-color: var(--feedback-bg); padding: 15px; border-radius: 6px; border: 1px solid var(--feedback-border); margin-top: 15px; }
        .review-mc-answer p, .review-matching-answer p, .review-ordering-answer p { margin: 8px 0; font-size: 15px; color: var(--text-color); }
        .review-mc-answer p strong, .review-matching-answer p strong, .review-ordering-answer p strong { color: var(--text-heading); margin-right: 5px; display: inline-block; min-width: 110px; }
        .review-mc-answer .correct-answer-text, .review-matching-answer .correct-answer-text, .review-ordering-answer .correct-answer-text { color: var(--correct-text); font-weight: 500; }
        .review-mc-answer .user-answer-text.incorrect { color: var(--incorrect-text); text-decoration: line-through; }
        .review-mc-answer .user-answer-text.correct { color: var(--correct-text); font-weight: 500; }

        /* Review Matching */
        .review-matching-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .review-matching-column { flex: 1; min-width: 200px;}
        .review-matching-column div { padding: 5px 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); }
        .review-matched-pair-correct { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; color: var(--correct-text) !important; }
        .review-matched-pair-incorrect { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; color: var(--incorrect-text) !important; }
        /* Ensure nested spans in dark mode get correct review colors */
        body.dark-theme .review-matched-pair-incorrect span { color: var(--incorrect-text) !important; }
        body.dark-theme .review-matched-pair-incorrect span + span { color: var(--correct-text) !important; }

        /* Review Ordering */
        .review-ordering-list { margin-top: 10px; }
        .review-ordering-list-item { display: flex; align-items: center; margin-bottom: 5px; padding: 5px 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); }

        /* --- END OF styles.css --- */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Interactive Question Bank</h1>
            <button id="theme-toggle" title="Toggle Theme"></button>
        </div>

        <!-- Navigation -->
        <div class="nav-section">
            <div class="subjects">
                <button class="nav-btn" data-subject="اللغة العربية"><span>📚</span> اللغة العربية</button>
                <button class="nav-btn active" data-subject="english"><span>🌎</span> English</button>
                <button class="nav-btn" data-subject="التاريخ"><span>📜</span> التاريخ</button>
                <button class="nav-btn" data-subject="دين"><span>📖</span> دين</button>
            </div>
            <div class="secondary-nav">
                <div class="semester-toggle">
                    <button class="semester-btn active" data-semester="first">First Semester</button>
                    <button class="semester-btn" data-semester="second">Second Semester</button>
                </div>
            </div>
        </div>

        <!-- Content Area for Topic Lists -->
        <div id="content">
            <!-- Topic lists loaded by JS -->
        </div>

        <!-- Quiz View Area (Initially Hidden) -->
        <div id="quiz-view" class="hidden">
            <div id="quiz-header">
                <h2 id="quiz-title">Quiz Title</h2>
                <button class="btn back-to-topics-btn" onclick="showTopicList()">← Back to Topics</button>
            </div>
            <div id="quiz-container">
                 <!-- Quiz Question/Results/Review content loads here -->
            </div>
             <div id="feedback-container" class="feedback-container hidden">
                 <!-- Feedback messages load here -->
             </div>
             <div id="quiz-buttons-container" class="quiz-buttons">
                 <!-- Submit/Next/Review/Back buttons load here -->
            </div>
        </div>

    </div> <!-- End of .container -->

    <script>
        // --- START OF topics.js ---

        // FULL Topics data structure - RESTORED PLACEHOLDERS
        const topicsData = {
            "english": {
                "first": {
                    "title": "First Semester",
                    "units": [
                        {
                            "title": "Unit 1", // Unit Title
                            "lessons": [ // Lessons within the unit
                                {
                                    "title": "Vocabulary & Grammar Basics", // Lesson Title
                                    "questions": [
                                        { "type": "multiple_choice", "question": "Device in 'curtain of night fell'?", "options": ["Simile", "Metaphor", "Alliteration", "Hyperbole"], "answer": "Metaphor" },
                                        { "type": "multiple_choice", "question": "'Ambiguous' means:", "options": ["Clear", "Uncertain", "Definite", "Determined"], "answer": "Uncertain" },
                                        { "type": "ordering", "question": "Order alphabetically:", "items": ["Banana", "Apple", "Cherry", "Date", "Fig"], "answer": ["Apple", "Banana", "Cherry", "Date", "Fig"] },
                                        { "type": "matching", "question": "Match country and capital:", "prompts": ["France", "Japan", "Egypt", "Brazil", "Canada"], "matches": ["Cairo", "Tokyo", "Paris", "Brasília", "Ottawa"], "answer": { "0": 2, "1": 1, "2": 0, "3": 3, "4": 4 } },
                                        { "type": "ordering", "question": "Order tea steps:", "items": ["Add tea bag", "Boil water", "Pour water"], "answer": ["Boil water", "Add tea bag", "Pour water"] }
                                    ]
                                },
                                {
                                    "title": "Past & Present Tenses & Question Tags",
                                    "questions": [
                                        { "type": "multiple_choice", "question": "Correct tense: 'She ___ school.'", "options": ["go", "goes", "going", "went"], "answer": "goes" },
                                        { "type": "multiple_choice", "question": "Correct tag: 'You're coming, ___?'", "options": ["aren't you", "don't you", "isn't you", "won't you"], "answer": "aren't you" }
                                    ]
                                }
                            ]
                        },
                        {
                            "title": "Unit 2",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Future Forms", "questions": [] }
                            ]
                        },
                        {
                            "title": "Unit 3",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Habits & Clauses", "questions": [] }
                            ]
                        },
                        {
                            "title": "Unit 4",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Narration & Inversion", "questions": [] }
                            ]
                        }
                    ]
                },
                "second": {
                    "title": "Second Semester",
                    "units": [
                        { "title": "Unit 1", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modal & Related & Articles", "questions": [] } ] },
                        { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Reported Speech & Reporting Verbs", "questions": [] } ] },
                        { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "The Passive", "questions": [] } ] },
                        { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Conditionals & Modals", "questions": [] } ] },
                        { "title": "Unit 5", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modals & Clauses", "questions": [] } ] }
                    ]
                }
            },
            "اللغة العربية": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الوحدة الأولى", "lessons": [ { "title": "من القيم الإنسانية في القرآن", "questions": [] }, { "title": "اسلوب الطلب وجوابه المجزوم والتشبيه المفرد", "questions": [] } ] },
                        { "title": "الوحدة الثانية", "lessons": [ { "title": "عمانيات", "questions": [] }, { "title": "صور الفاعل والتشبيه التمثيلي", "questions": [] } ] },
                        { "title": "الوحدة الثالثة", "lessons": [ { "title": "الزهايمر-الخرف المبكر", "questions": [] }, { "title": "صور المبتدأ والخبر والجملة الخبرية والإنشائية", "questions": [] } ] },
                        { "title": "الوحدة الرابعة", "lessons": [ { "title": "الإعلام ومشروع النهوض باللغة العربية", "questions": [] }, { "title": "المفعول معه والأمر", "questions": [] } ] },
                        { "title": "الوحدة الخامسة", "lessons": [ { "title": "التعليم التقني بوابة المستقبل في عالم متغير", "questions": [] }, { "title": "انواع ما والإستفهام", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "في فتح القدس", "questions": [] }, { "title": "معاني حروف الجر والتشخيص", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "قصة-حفنة تمر", "questions": [] }, { "title": "اسم الفاعل واسم المفعول والطباق والمقابلة", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "شاعرات من بلدي", "questions": [] }, { "title": "اسم الزمان واسم المكان وجمع التكسير (القلة والكثرة)", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "من مقامات بديع الزمان الهمذاني", "questions": [] }, { "title": "مصدر المرة ومصدر الهيئة والبحر المتدارك", "questions": [] } ] },
                         { "title": "الوحدة الخامسة", "lessons": [ { "title": "الذكاء الاصطناعي-عالم جديد", "questions": [] }, { "title": "اسم الآلة", "questions": [] } ] }
                    ]
                }
            },
             "التاريخ": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الأردن في العصور القديمة", "lessons": [ { "title": "الأردن في العصور الحجرية", "questions": [] }, { "title": "الأردن في العصر الحديدي", "questions": [] }, { "title": "مملكة الأنباط", "questions": [] }, { "title": "مظاهر الحضارة اليونانية في الأردن", "questions": [] }, { "title": "مظاهر الحضارة الرومانية-البيزنطية في الأردن", "questions": [] } ] },
                        { "title": "الأردن في صدر الإسلام", "lessons": [ { "title": "الأردن في صدر الإسلام", "questions": [] }, { "title": "الأردن في العصر الأموي", "questions": [] }, { "title": "الأردن في العصر العباسي", "questions": [] }, { "title": "الأردن خلال حملات الفرنجة", "questions": [] }, { "title": "الأردن في العصر الأيوبي", "questions": [] }, { "title": "الأردن في العصر المملوكي", "questions": [] } ] },
                        { "title": "الأردن في العصر الحديث", "lessons": [ { "title": "الأوضاع السياسية والإدارية في الأردن في العهد العثماني", "questions": [] }, { "title": "الأوضاع الإجتماعية والإقتصادية الأردن في العهد العثماني", "questions": [] }, { "title": "الثورة العربية الكبرى", "questions": [] }, { "title": "الأردن في عهد المملكة العربية السورية والحكومات المحلية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                     "units": [
                        { "title": "الحياة السياسية في الأردن", "lessons": [ { "title": "تأسيس الإمارة الأردنية", "questions": [] }, { "title": "استقلال المملكة الأردنية الهاشمية", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1948-1957)", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1958-1999)", "questions": [] }, { "title": "الحياة السياسية في الأردن منذ 1999", "questions": [] }, { "title": "الأردن والعلاقات العربية والدولية", "questions": [] }, { "title": "القوات المسلحة الأردنية - الجيش العربي", "questions": [] }, { "title": "الأجهزة الأمنية الأردنية", "questions": [] } ] },
                        { "title": "الحياة الاقتصادية في الأردن", "lessons": [ { "title": "الحياة الاقتصادية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1951-1967)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1968-1999)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "الحياة الاجتماعية في الأردن", "lessons": [ { "title": "الحياة الاجتماعية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن بين عامي (1951-1999)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "التعليم والثقافة في الأردن", "lessons": [ { "title": "التعليم العام في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1951-1987)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1988-2024)", "questions": [] }, { "title": "التعليم العالي والبحث العلمي في الأردن منذ عام 1951", "questions": [] }, { "title": "الحياة الثقافية في الأردن في عهد الإمارة", "questions": [] }, { "title": "الحياة الثقافية في الأردن منذ عام 1946", "questions": [] } ] },
                        { "title": "الأردن والقضية الفلسطينية", "lessons": [ { "title": "موقف الأردن من القضية الفلسطينية بين عامي (1916-1951)", "questions": [] }, { "title": "موقف الأردن من القضية الفلسطينية منذ عام 1951", "questions": [] }, { "title": "الوصاية والإعمار الهاشمي للمقدسات الدينية في القدس", "questions": [] } ] }
                    ]
                }
            },
             "دين": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة آل عمران (102-105)", "questions": [] }, { "title": "حديث اتقاء الشبهات", "questions": [] }, { "title": "من صور الضلال", "questions": [] }, { "title": "كرامة الإنسان في الشريعة", "questions": [] }, { "title": "الزواج-مشروعيته ومقدماته", "questions": [] }, { "title": "الجهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "جهود علماء المسلمين في خدمة القرآن", "questions": [] }, { "title": "العزيمة والرخصة", "questions": [] }, { "title": "معركة مؤتة (8 هجري)", "questions": [] }, { "title": "المحرمات من النساء", "questions": [] }, { "title": "التعايش الإنساني", "questions": [] }, { "title": "الحقوق الإجتماعية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة آل عمران (169-174)", "questions": [] }, { "title": "حديث - رضا الله تعالى", "questions": [] }, { "title": "فتح مكة (8 هجري)", "questions": [] }, { "title": "من خصائص الشريعة - الإيجابية", "questions": [] }, { "title": "شروط صحة عقد الزواج", "questions": [] }, { "title": "الحقوق المالية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "سورة الروم (21-24)", "questions": [] }, { "title": "مكانة السنة النبوية في التشريع", "questions": [] }, { "title": "مراعاة الأعراف في الشريعة", "questions": [] }, { "title": "حقوق الزوجين", "questions": [] }, { "title": "تنظيم النسل وتحديده", "questions": [] }, { "title": "الأمن الغذائي في الإسلام", "questions": [] }, { "title": "الإسلام والوحدة الوطنية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة البقرة (284-286)", "questions": [] }, { "title": "دلائل وجود الله تعالى", "questions": [] }, { "title": "إعجاز القرآن الكريم", "questions": [] }, { "title": "الأمر بالمعروف والنهي عن المنكر", "questions": [] }, { "title": "اليوم الآخر - احداثه وآثار الإيمان به", "questions": [] }, { "title": "الإجتهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "سورة الأعراف (31-34)", "questions": [] }, { "title": "مراعاة المصالح في الشريعة", "questions": [] }, { "title": "جهود علماء المسلمين في الحفاظ على السنة النبوية", "questions": [] }, { "title": "حديث - منهج الإسلام في الحياة", "questions": [] }, { "title": "رسائل النبي الى الملوك والزعماء في عصره", "questions": [] }, { "title": "يوم تبوك (9 هجري)", "questions": [] }, { "title": "الحقوق السياسية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة الفرقان (63-77)", "questions": [] }, { "title": "الطلاق", "questions": [] }, { "title": "العدة", "questions": [] }, { "title": "الوصية في الشريعة", "questions": [] }, { "title": "الميراث في الشريعة", "questions": [] }, { "title": "من خصائص الشريعة - الوسطية", "questions": [] }, { "title": "مجالات الوقف ودورها في التنمية", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "حديث - مفهوم الإفلاس بين الدنيا والآخرة", "questions": [] }, { "title": "مقاصد الشريعة", "questions": [] }, { "title": "منهج الإسلام في مكافحة الجريمة", "questions": [] }, { "title": "من وصايا النبي في حجة الوداع", "questions": [] }, { "title": "المسؤولية المجتمعية في الإسلام", "questions": [] }, { "title": "حقوق الإنسان بين الإسلام والإعلان العالمي لحقوق الإنسان", "questions": [] } ] }
                    ]
                }
            }
        };

        // Generate HTML for topic lists (Adding Question Counter)
        function generateSemesterContent(subject, semester) {
            if (!topicsData[subject]?.[semester]) {
                console.error(`Data missing for ${subject}, ${semester}`);
                return `<div id="${subject}-${semester}" class="semester-content"><div class="section"><p>Content unavailable.</p></div></div>`;
            }
            const semesterData = topicsData[subject][semester];
            let html = `<div id="${subject}-${semester}" class="semester-content">
                            <div class="unit-container"> <div class="unit-title">${semesterData.title}</div> </div>`; // Semester Title container

            if (!semesterData.units?.length) {
                 html += `<div class="section"><p>No units available.</p></div>`;
            } else {
                 semesterData.units.forEach(unit => {
                     if (unit?.title) {
                         html += `<div class="section"> <div class="section-title">${unit.title}</div>`; // Unit Box + Title
                         if (unit.lessons?.length) {
                             unit.lessons.forEach(lesson => {
                                 if (lesson?.title) {
                                     // Calculate question count
                                     const qCount = lesson.questions?.length || 0;
                                     const countText = qCount === 1 ? "1 question" : `${qCount} questions`;
                                     html += `<div class="section-content" data-subject="${subject}" data-unit="${unit.title}" data-lesson="${lesson.title}">
                                                 ${lesson.title}
                                                 <span class="lesson-q-count">(${countText})</span>
                                               </div>`; // Added counter span
                                 } else { console.warn(`Invalid lesson in unit: ${unit.title}`, lesson); }
                             });
                         } else { html += `<p style="margin:10px 0 0 0; font-size:14px; color:var(--text-muted);">(No lessons)</p>`; }
                         html += `</div>`; // End Unit section
                     } else { console.warn(`Invalid unit in subject: ${subject}, semester: ${semester}`, unit); }
                 });
            }
            html += `</div>`; // End semester content
            return html;
        }

        // Generate all content on load
        function generateAllContent() {
            let contentHTML = '';
            const contentDiv = document.getElementById('content');
            if (!contentDiv) { console.error("#content not found!"); return; }
            Object.keys(topicsData).forEach(subject => {
                Object.keys(topicsData[subject]).forEach(semester => {
                    contentHTML += generateSemesterContent(subject, semester);
                });
            });
            contentDiv.innerHTML = contentHTML;
        }

        document.addEventListener('DOMContentLoaded', generateAllContent);

        // --- END OF topics.js ---
    </script>

    <script>
        // --- START OF questions.js ---

        // --- Global State ---
        let quizState = {
            currentQuestionIndex: 0,
            correctAnswers: 0,
            totalQuestions: 0,
            startTime: null,
            endTime: null,
            selectedAnswers: [], // User's response structure for each question
            questions: [],       // Current SHUFFLED list of questions for the quiz
            originalQuestions: [], // Original, unshuffled list for redo reference
            subject: '',
            unit: '',
            lesson: '',
            matchingState: { selectedPromptElement: null, userPairs: {} }
        };

        // --- DOM Element References ---
        let contentElement, quizViewElement, quizTitleElement, quizContainerElement,
            feedbackContainerElement, quizButtonsContainerElement, matchingSvgElement,
            navSectionElement; // Added reference for nav section
        let matchingArrowObserver = null;
        let resizeTimeout = null;

        // --- Utility Functions ---
        function shuffleArray(array) {
             // Creates a new shuffled array (doesn't modify original)
             const newArray = [...array];
             for (let i = newArray.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
             }
             return newArray;
         }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }
        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('quizTheme', newTheme); // Save preference
        }


        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign element references
            contentElement = document.getElementById('content');
            quizViewElement = document.getElementById('quiz-view');
            quizTitleElement = document.getElementById('quiz-title');
            quizContainerElement = document.getElementById('quiz-container');
            feedbackContainerElement = document.getElementById('feedback-container');
            quizButtonsContainerElement = document.getElementById('quiz-buttons-container');
            navSectionElement = document.querySelector('.nav-section'); // Get nav section reference

            // Theme Toggle Listener
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', toggleTheme);
            }
            // Apply saved theme on load
            const savedTheme = localStorage.getItem('quizTheme') || 'light'; // Default to light
            applyTheme(savedTheme);


            // Nav button listeners with confirmation
            document.querySelectorAll('.nav-btn[data-subject]').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress lost.")) return;
                    showTopicList(); // Ensure nav is visible before updating content
                    document.querySelectorAll('.nav-btn[data-subject]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });
            document.querySelectorAll('.semester-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress lost.")) return;
                    showTopicList();
                    document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });

            window.addEventListener('resize', debounce(updateAllArrowPositions, 250));
            updateContent(); // Initial topic list load
        });

        // --- View Management ---
        function showTopicList() {
            if (contentElement && quizViewElement && navSectionElement) {
                contentElement.classList.remove('hidden');
                quizViewElement.classList.add('hidden');
                navSectionElement.classList.remove('hidden'); // *** SHOW Nav Section ***
                if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; }
                if(matchingSvgElement) matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)"/></marker></defs>'; // Use variable
                quizState = { // Reset state fully
                    currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null,
                    selectedAnswers: [], questions: [], originalQuestions: [], subject: '', unit: '', lesson: '',
                    matchingState: { selectedPromptElement: null, userPairs: {} }
                };
            }
        }
        function showQuizView() {
             if (contentElement && quizViewElement && navSectionElement) {
                 contentElement.classList.add('hidden');
                 quizViewElement.classList.remove('hidden');
                 navSectionElement.classList.add('hidden'); // *** HIDE Nav Section ***
                 quizViewElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
        }

        // --- Core Functions ---
        function updateContent() { // Updates topic list view
            const activeSubjectBtn = document.querySelector('.nav-btn[data-subject].active');
            const activeSemesterBtn = document.querySelector('.semester-btn.active');
            if (!activeSubjectBtn || !activeSemesterBtn || !contentElement) return;
            const activeSubject = activeSubjectBtn.dataset.subject;
            const activeSemester = activeSemesterBtn.dataset.semester;
            contentElement.querySelectorAll('.semester-content').forEach(c => c.classList.remove('active'));
            const contentId = `${activeSubject}-${activeSemester}`;
            const semesterContentElement = contentElement.querySelector(`#${contentId}`);
            if (semesterContentElement) {
                semesterContentElement.classList.add('active');
                // Re-attach listeners to lesson boxes
                semesterContentElement.querySelectorAll('.section-content').forEach(lessonBox => {
                    const newLessonBox = lessonBox.cloneNode(true);
                    lessonBox.parentNode.replaceChild(newLessonBox, lessonBox);
                    newLessonBox.addEventListener('click', () => handleSectionClick(newLessonBox.dataset.subject, newLessonBox.dataset.unit, newLessonBox.dataset.lesson));
                });
            } else { console.warn(`Semester content ID "${contentId}" not found.`); }
        }

        function handleSectionClick(subject, unit, lesson) { // Starts quiz if questions found
             if (!subject || !unit || !lesson) { alert("Error identifying topic."); return; }
            try {
                const originalQuestions = getQuestions(subject, unit, lesson); // Get original order
                if (originalQuestions?.length) {
                    startQuiz(subject, unit, lesson, originalQuestions); // Pass original list
                } else { showError(subject, unit, lesson); } // Show error in quiz view
            } catch (error) {
                console.error("Section click error:", error);
                showError(subject, unit, lesson, "Error loading questions.");
            }
        }

        // Start/Redo Quiz - SHUFFLES questions
        function startQuiz(subject, unit, lesson, originalQuestions) {
            const shuffledQuestions = shuffleArray(originalQuestions); // Shuffle for this attempt

            quizState = { // Reset state for new/redo quiz
                currentQuestionIndex: 0,
                correctAnswers: 0,
                totalQuestions: shuffledQuestions.length,
                startTime: new Date(),
                endTime: null,
                selectedAnswers: new Array(shuffledQuestions.length).fill(null),
                questions: shuffledQuestions,       // Use shuffled list for quiz flow
                originalQuestions: originalQuestions, // Store original list for redo
                subject: subject,
                unit: unit,
                lesson: lesson,
                matchingState: { selectedPromptElement: null, userPairs: {} }
            };

            if (quizTitleElement) quizTitleElement.textContent = `${lesson}`;
            showQuizView();
            displayQuestion(); // Display the first (shuffled) question
        }

        // Display the current question
        function displayQuestion() {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement) return;
             const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
             if (!currentQuestion) { displayResults(); return; } // End quiz if no more questions

             // Clear previous content and state
             quizContainerElement.innerHTML = '';
             feedbackContainerElement.innerHTML = '';
             feedbackContainerElement.classList.add('hidden');
             quizButtonsContainerElement.innerHTML = '';
             if (matchingSvgElement) matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)"/></marker></defs>'; // Reset SVG, keep defs
             if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; } // Disconnect old observer

             // --- Render Question Structure ---
             const questionWrapper = document.createElement('div');
             questionWrapper.className = 'question-display-wrapper';

             const progressText = document.createElement('div');
             progressText.className = 'question-progress';
             progressText.textContent = `Question ${quizState.currentQuestionIndex + 1} of ${quizState.totalQuestions}`;
             questionWrapper.appendChild(progressText);

             const questionText = document.createElement('p');
             questionText.className = 'question-text';
             questionText.innerHTML = `<strong>Q:</strong> ${currentQuestion.question || 'Missing question text'}`;
             questionWrapper.appendChild(questionText);

             const typeWrapper = document.createElement('div');
             typeWrapper.className = 'question-type-wrapper';

             // --- Render Question Content by Type ---
             try {
                  switch (currentQuestion.type) {
                      case "matching":
                          renderMatching(currentQuestion, typeWrapper);
                          setupArrowObserver(); // Setup observer AFTER elements exist
                          break;
                      case "ordering":
                          renderOrdering(currentQuestion, typeWrapper);
                          break;
                      case "multiple_choice":
                      default:
                          renderMultipleChoice(currentQuestion, typeWrapper);
                          break;
                  }
             } catch (renderError) {
                 console.error("Render error:", renderError);
                 typeWrapper.innerHTML = `<p style="color:red;">Error displaying question.</p>`;
             }
             questionWrapper.appendChild(typeWrapper);
             quizContainerElement.appendChild(questionWrapper);

             // --- Render Buttons ---
             const submitBtn = document.createElement('button');
             submitBtn.className = 'btn submit-btn';
             submitBtn.id = 'submit-btn';
             submitBtn.textContent = 'Submit Answer';
             submitBtn.onclick = checkAnswer;

             const nextBtn = document.createElement('button');
             nextBtn.className = 'btn next-btn hidden'; // Always start hidden
             nextBtn.id = 'next-btn';
             nextBtn.textContent = quizState.currentQuestionIndex === quizState.totalQuestions - 1 ? 'See Results' : 'Next Question';
             nextBtn.onclick = nextQuestion;

             quizButtonsContainerElement.appendChild(submitBtn);
             quizButtonsContainerElement.appendChild(nextBtn);

             // --- Set Initial Button State ---
             submitBtn.disabled = true; // Start disabled
             // Enable logic is within specific renderers or handleMatchingClick
             if (currentQuestion.type !== 'multiple_choice' && currentQuestion.type !== 'ordering' && currentQuestion.type !== 'matching') {
                 // If it's an unknown type or one not needing selection, enable immediately
                 submitBtn.disabled = false;
             }
        }


        // --- Rendering Functions ---
        function renderMultipleChoice(question, container) {
            if (!question.options?.length) { container.textContent = 'Err: Options invalid.'; return; }
            const optionsDiv = document.createElement('div'); optionsDiv.className = 'options-container'; optionsDiv.id = 'options-list';
            question.options.forEach((option, index) => {
                const id = `option-${index}`, lbl = document.createElement('label'); lbl.className = 'option-label'; lbl.htmlFor = id;
                const inp = document.createElement('input'); inp.type = 'radio'; inp.name = 'question-option'; inp.value = index; inp.id = id; inp.className = 'option-input';
                // Enable submit button when an option is chosen
                inp.addEventListener('change', () => {
                    const submitBtn = document.getElementById('submit-btn');
                    if (submitBtn) submitBtn.disabled = false;
                });
                const txt = document.createElement('span'); txt.className = 'option-text'; txt.textContent = option;
                lbl.append(inp, txt); optionsDiv.appendChild(lbl);
            }); container.appendChild(optionsDiv);
        }
        function renderMatching(question, container) {
             if (!question.prompts?.length || !question.matches?.length || question.prompts.length !== question.matches.length) { container.textContent = 'Err: Match data invalid.'; return; }
             quizState.matchingState.userPairs = {}; // Reset internal state
             const instr = document.createElement('p'); instr.className = 'matching-instructions'; instr.textContent = 'Click left item, then right item. Click matched item to deselect.'; container.appendChild(instr);
             const outer = document.createElement('div'); outer.style.position = 'relative'; // Outer container for relative positioning
             const matchCont = document.createElement('div'); matchCont.className = 'matching-container'; matchCont.id = 'matching-cols'; // Container for the two columns
             const promCol = document.createElement('div'); promCol.className = 'matching-column'; promCol.id = 'prompts-column'; promCol.innerHTML = '<h4>Items</h4>'; // Left column
             const matCol = document.createElement('div'); matCol.className = 'matching-column'; matCol.id = 'matches-column'; matCol.innerHTML = '<h4>Matches</h4>'; // Right column

             // SVG layer for arrows
             matchingSvgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
             matchingSvgElement.id = 'matching-arrow-svg';
             matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)"/></marker></defs>'; // Arrowhead definition using CSS var
             outer.appendChild(matchingSvgElement); // Add SVG layer first (behind columns)

             // Shuffle matches but keep track of original index
             const shuffled = question.matches.map((t, i) => ({ text: t, originalIndex: i })).sort(() => 0.5 - Math.random());

             // Render prompts (left side)
             question.prompts.forEach((t, i) => {
                 const it = document.createElement('div'); it.className = 'matching-item prompt-item'; it.textContent = t; it.dataset.index = i; it.id=`prompt-${i}`; it.onclick = handleMatchingClick; promCol.appendChild(it);
             });
             // Render shuffled matches (right side)
             shuffled.forEach(o => {
                 const it = document.createElement('div'); it.className = 'matching-item match-item'; it.textContent = o.text; it.dataset.index = o.originalIndex; it.id=`match-${o.originalIndex}`; it.onclick = handleMatchingClick; matCol.appendChild(it);
             });

             matchCont.append(promCol, matCol); // Add columns to their container
             outer.appendChild(matchCont); // Add column container on top of SVG
             container.appendChild(outer); // Add the whole structure
         }
        function renderOrdering(question, container) {
            if (!question.items?.length) { container.textContent = 'Err: Ordering data invalid.'; return; }
            const num = question.items.length;
            const instr = document.createElement('p'); instr.className = 'ordering-instructions'; instr.textContent = `Select order number (1-${num}) for each.`; container.appendChild(instr);
            const orderCont = document.createElement('div'); orderCont.className = 'ordering-container'; orderCont.id = 'ordering-list';
            // Function to check if all dropdowns have a valid selection
            const checkAllSelected = () => {
                const allSelects = orderCont.querySelectorAll('.ordering-select');
                const allSelectedWithValue = Array.from(allSelects).every(s => s.value !== "");
                const submitBtn = document.getElementById('submit-btn');
                if(submitBtn) submitBtn.disabled = !allSelectedWithValue;
            };
            question.items.forEach((t, i) => {
                const div = document.createElement('div'); div.className = 'ordering-item'; div.dataset.originalIndex = i;
                const sel = document.createElement('select'); sel.className = 'ordering-select'; sel.dataset.itemIndex = i;
                // Default blank option
                const defOpt = document.createElement('option'); defOpt.value = ""; defOpt.textContent = "-"; defOpt.selected = true; defOpt.disabled = true; sel.appendChild(defOpt);
                // Numbered options
                for (let j = 1; j <= num; j++) { const opt = document.createElement('option'); opt.value = j; opt.textContent = j; sel.appendChild(opt); }
                sel.addEventListener('change', checkAllSelected); // Check completion on change
                const span = document.createElement('span'); span.className = 'ordering-text'; span.textContent = t;
                div.append(sel, span); orderCont.appendChild(div);
            }); container.appendChild(orderCont);
            // Ensure submit is initially disabled for ordering questions
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) submitBtn.disabled = true;
         }

        // --- Interaction Handlers ---
        function handleMatchingClick(event) { // Includes deselect logic
             const clicked = event.target; if (!clicked.classList.contains('matching-item')) return; // Ensure it's an item
             const isPrompt = clicked.classList.contains('prompt-item'), isMatched = clicked.classList.contains('matched');
             let currentSel = quizState.matchingState.selectedPromptElement; const idx = clicked.dataset.index;

             // --- Deselection Logic ---
             if (isMatched) {
                 let pIdx = -1, mIdx = -1;
                 // Figure out which pair this element belongs to
                 if (isPrompt) { // Clicked a matched prompt
                     pIdx = idx;
                     mIdx = quizState.matchingState.userPairs[pIdx]; // Get the match index it was paired with
                 } else { // Clicked a matched match-item
                     mIdx = idx;
                     // Find the prompt index this match was paired with
                     pIdx = Object.keys(quizState.matchingState.userPairs).find(key => quizState.matchingState.userPairs[key] == mIdx); // Use == for string/num compare
                 }

                 // If we found a valid pair to deselect
                 if (pIdx != -1 && mIdx !== undefined) {
                     const pEl = document.getElementById(`prompt-${pIdx}`), mEl = document.getElementById(`match-${mIdx}`);
                     // Remove visual 'matched' state and restore interactivity
                     if (pEl) { pEl.classList.remove('matched'); pEl.style.cursor = 'pointer'; /* pEl.style.pointerEvents = 'auto'; */ } // pointerEvents handled by class/css
                     if (mEl) { mEl.classList.remove('matched'); mEl.style.cursor = 'pointer'; /* mEl.style.pointerEvents = 'auto'; */ }
                     delete quizState.matchingState.userPairs[pIdx]; // Remove from stored answers
                     removeArrow(pIdx); // Remove the connecting arrow

                     // If a prompt was somehow selected before clicking the matched item, clear that selection
                     if (currentSel) currentSel.classList.remove('selected');
                     quizState.matchingState.selectedPromptElement = null;

                     document.getElementById('submit-btn').disabled = true; // Must disable submit, as it's no longer complete
                     return; // Stop processing here for deselect
                 }
             }

             // --- Selection / Matching Logic (Only if not matched) ---
             if (isPrompt) { // Clicked a prompt (that wasn't matched)
                 if (clicked === currentSel) { // Clicked the currently selected prompt again
                     clicked.classList.remove('selected'); // Deselect it
                     quizState.matchingState.selectedPromptElement = null;
                 } else { // Clicked a new, available prompt
                     if (currentSel) currentSel.classList.remove('selected'); // Deselect any previous prompt
                     clicked.classList.add('selected'); // Select the new one
                     quizState.matchingState.selectedPromptElement = clicked;
                 }
             }
             else { // Clicked a match-item (that wasn't matched)
                 if (currentSel) { // And a prompt IS currently selected
                     const pIdx = currentSel.dataset.index; // Prompt index from selected element
                     const mIdx = idx; // Match index from clicked element

                     quizState.matchingState.userPairs[pIdx] = parseInt(mIdx, 10); // Store the new pair

                     // Update visuals: mark both as matched, remove prompt selection
                     currentSel.classList.remove('selected');
                     currentSel.classList.add('matched');
                     clicked.classList.add('matched');
                     // No need to change cursor/pointerEvents if CSS handles .matched state

                     drawArrow(currentSel, clicked, pIdx); // Draw the connecting arrow

                     quizState.matchingState.selectedPromptElement = null; // Clear prompt selection

                     // Check if all prompts are now matched to enable submit
                     const total = document.querySelectorAll('.prompt-item').length;
                     const matchedCount = document.querySelectorAll('.prompt-item.matched').length;
                     if (total === matchedCount && total > 0) { // Check total > 0
                         document.getElementById('submit-btn').disabled = false;
                     }
                 }
                 // Else: Clicking an available match-item with no prompt selected does nothing.
             }
         }


        // --- Arrow Drawing ---
        function drawArrow(promptEl, matchEl, promptIndex) {
            if (!matchingSvgElement || !promptEl || !matchEl) return;
            const svgRect = matchingSvgElement.getBoundingClientRect();
            const promptRect = promptEl.getBoundingClientRect();
            const matchRect = matchEl.getBoundingClientRect();

            const startX = promptRect.right - svgRect.left + window.scrollX; // Include scroll offsets
            const startY = promptRect.top + promptRect.height / 2 - svgRect.top + window.scrollY;
            const endX = matchRect.left - svgRect.left + window.scrollX;
            const endY = matchRect.top + matchRect.height / 2 - svgRect.top + window.scrollY;

            let line = matchingSvgElement.querySelector(`#arrow-${promptIndex}`);
            if (!line) {
                line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.id = `arrow-${promptIndex}`;
                matchingSvgElement.appendChild(line);
            }

            line.setAttribute('x1', startX); line.setAttribute('y1', startY);
            line.setAttribute('x2', endX); line.setAttribute('y2', endY);
            line.style.opacity = '1';
        }
        function removeArrow(promptIndex) {
            if (!matchingSvgElement) return; const line = matchingSvgElement.querySelector(`#arrow-${promptIndex}`);
            if (line) { line.style.opacity = '0'; setTimeout(() => line.remove(), 300); }
        }
        function updateAllArrowPositions() {
             if (!matchingSvgElement || !quizState || quizState.questions[quizState.currentQuestionIndex]?.type !== 'matching') return;
             const pairs = quizState.matchingState.userPairs;
             for (const pIdx in pairs) {
                 if (pairs.hasOwnProperty(pIdx)) {
                     const mIdx = pairs[pIdx];
                     const pEl = document.getElementById(`prompt-${pIdx}`), mEl = document.getElementById(`match-${mIdx}`);
                     if (pEl && mEl) drawArrow(pEl, mEl, pIdx); // Redraw
                 }
             }
         }
        function setupArrowObserver() {
            const target = document.getElementById('matching-cols'); if (!target) return;
            const config = { attributes: true, childList: true, subtree: true, characterData: true };
            const callback = debounce(updateAllArrowPositions, 100); // Debounce updates
            matchingArrowObserver = new MutationObserver(callback);
            matchingArrowObserver.observe(target, config);
            // Initial draw might need slight delay if layout isn't final instantly
            setTimeout(updateAllArrowPositions, 50);
        }

        // --- Answer Checking ---
        function checkAnswer() {
            if (!feedbackContainerElement || !quizButtonsContainerElement) return;
            if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; } // Disconnect observer
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
            let result = { isCorrect: false, feedback: '', userResponse: null, scoreIncrement: 0 };
            try {
                switch (currentQuestion.type) {
                    case "matching": result = checkMatching(currentQuestion); break;
                    case "ordering": result = checkOrdering(currentQuestion); break;
                    case "multiple_choice": default: result = checkMultipleChoice(currentQuestion); break;
                }
            } catch (error) {
                console.error("Check answer error:", error);
                result = { isCorrect: false, feedback: '<div class="incorrect-feedback">Error checking answer.</div>', userResponse: null, scoreIncrement: 0 };
            }
            quizState.selectedAnswers[quizState.currentQuestionIndex] = result.userResponse;
            // Correct answers count only full points
            if (result.isCorrect && result.scoreIncrement > 0) {
                 quizState.correctAnswers += result.scoreIncrement;
            }
            feedbackContainerElement.innerHTML = result.feedback;
            feedbackContainerElement.classList.remove('hidden');
            disableInputs();
            const submitBtn = quizButtonsContainerElement.querySelector('#submit-btn'), nextBtn = quizButtonsContainerElement.querySelector('#next-btn');
            if(submitBtn) submitBtn.classList.add('hidden');
            if(nextBtn) nextBtn.classList.remove('hidden');
        }
        function checkMultipleChoice(question) {
            const sel=document.querySelector('input[name="question-option"]:checked');if(!sel)return{isCorrect:!1,feedback:'<div class="incorrect-feedback">Select answer.</div>',userResponse:null,scoreIncrement:0};const idx=parseInt(sel.value,10),cTxt=question.answer,sTxt=question.options?.[idx],isOk=sTxt===cTxt;document.querySelectorAll('.option-label').forEach((l,i)=>{const n=l.querySelector('input');question.options?.[i]===cTxt&&l.classList.add('correct-option'),n&&parseInt(n.value,10)===idx&&!isOk&&l.classList.add('incorrect-option')});const fb=isOk?'<div class="correct-feedback">Correct! ✓</div>':`<div class="incorrect-feedback">Incorrect. <span>Correct: ${cTxt||'N/A'}</span></div>`;return{isCorrect:isOk,feedback:fb,userResponse:idx,scoreIncrement:isOk?1:0};
        }
        function checkMatching(question) {
             const userPairs=quizState.matchingState.userPairs,correct=question.answer||{},total=Object.keys(correct).length;let ct=0;if(0===total)return{isCorrect:!0,feedback:'<div class="correct-feedback">N/A</div>',userResponse:userPairs,scoreIncrement:0};for(const pIdx in correct)userPairs.hasOwnProperty(pIdx)&&userPairs[pIdx]===correct[pIdx]&&ct++;const isFull=ct===total;let fb="";isFull?fb=`<div class="correct-feedback">Correct! ✓ (${ct}/${total})</div>`:ct>0?fb=`<div class="partial-feedback">Partial. Matched ${ct}/${total}.</div>`:fb=`<div class="incorrect-feedback">Incorrect. Matched 0/${total}.</div>`;return{isCorrect:isFull,feedback:fb,userResponse:userPairs,scoreIncrement:isFull?1:0};
        }
        function checkOrdering(question) {
            const items=question.items||[],correctOrder=question.answer||[],num=items.length;if(0===num||!Array.isArray(correctOrder)||num!==correctOrder.length)return console.error("Invalid ordering data:",question),{isCorrect:!1,feedback:'<div class="incorrect-feedback">Err: Invalid setup.</div>',userResponse:null,scoreIncrement:0};const userMap={},selNums=new Set;let allSel=!0,hasDup=!1;const selects=document.querySelectorAll("#ordering-list .ordering-select");if(selects.length!==num)return console.error("Select count mismatch"),{isCorrect:!1,feedback:'<div class="incorrect-feedback">Err processing form.</div>',userResponse:null,scoreIncrement:0};selects.forEach(sel=>{const idx=parseInt(sel.dataset.itemIndex,10),val=sel.value;if(""===val)allSel=!1;else{const n=parseInt(val,10);if(isNaN(n)||n<1||n>num)return void(allSel=!1);userMap[idx]=n,selNums.has(n)&&(hasDup=!0),selNums.add(n)}});if(!allSel)return{isCorrect:!1,feedback:'<div class="incorrect-feedback">Select order for all.</div>',userResponse:userMap,scoreIncrement:0};if(hasDup||selNums.size!==num)return{isCorrect:!1,feedback:`<div class="incorrect-feedback">Use each number (1-${num}) once.</div>`,userResponse:userMap,scoreIncrement:0};const userItems=new Array(num).fill(null);let ok=!0;for(const idxStr in userMap)if(userMap.hasOwnProperty(idxStr)){const idx=parseInt(idxStr,10),txt=items[idx],pos=userMap[idx]-1;if(void 0===txt||pos<0||pos>=num||null!==userItems[pos]){ok=!1;break}userItems[pos]=txt}if(!ok||userItems.some(i=>null===i))return console.error("Construction Fail:",userMap,userItems),{isCorrect:!1,feedback:'<div class="incorrect-feedback">Err processing sequence.</div>',userResponse:userItems,scoreIncrement:0};const isOk=JSON.stringify(userItems)===JSON.stringify(correctOrder);let fb="";isOk?fb='<div class="correct-feedback">Correct! ✓</div>':fb=`<div class="incorrect-feedback">Incorrect. <span>Correct: ${correctOrder.join(" → ")}</span></div>`;selects.forEach(sel=>{const idx=parseInt(sel.dataset.itemIndex,10),userN=userMap[idx],corrN=correctOrder.indexOf(items[idx])+1;sel.style.borderColor=userN===corrN?"var(--correct-border)":"var(--incorrect-border)",sel.style.borderWidth="2px"});return{isCorrect:isOk,feedback:fb,userResponse:userItems,scoreIncrement:isOk?1:0};
        }
        function disableInputs() {
             document.querySelectorAll('input[name="question-option"], .ordering-select').forEach(i => i.disabled = true);
             document.querySelectorAll('.option-label').forEach(l => l.style.cursor = 'default');
             document.querySelectorAll('.matching-item').forEach(i => { i.style.pointerEvents = 'none'; i.style.cursor = 'default'; }); // Disable matching items
         }

        // --- Navigation and Results ---
        function nextQuestion() {
            quizState.currentQuestionIndex++;
            if (quizState.currentQuestionIndex < quizState.totalQuestions) {
                displayQuestion();
            } else {
                quizState.endTime = new Date();
                displayResults();
            }
        }
        function displayResults() {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             quizTitleElement.textContent = 'Quiz Results';

             const time = quizState.endTime && quizState.startTime ? (quizState.endTime - quizState.startTime)/1000 : 0; const mins = Math.floor(time/60), secs = Math.floor(time % 60); const timeStr = time > 0 ? `${mins}m ${secs}s` : 'N/A';
             const score = quizState.totalQuestions > 0 ? (quizState.correctAnswers / quizState.totalQuestions) * 100 : 0;
             let msg = ''; if (quizState.totalQuestions === 0) msg = 'No questions.'; else if (score >= 90) msg = 'Excellent! 🎉'; else if (score >= 70) msg = 'Good work! 👍'; else if (score >= 50) msg = 'Not bad! 💪'; else msg = 'Needs practice. 📚';

             const resultsDiv = document.createElement('div'); resultsDiv.className = 'results-container';
             resultsDiv.innerHTML = `<h2 class="results-header">${msg}</h2><div class="results-score"><div class="score-circle"><span class="score-number">${score.toFixed(0)}</span><span class="score-percent-sign">%</span></div></div><div class="results-details"><p><strong>Subject:</strong> ${quizState.subject||'N/A'}</p><p><strong>Unit:</strong> ${quizState.unit||'N/A'}</p><p><strong>Lesson:</strong> ${quizState.lesson||'N/A'}</p><p><strong>Correct:</strong> ${quizState.correctAnswers}/${quizState.totalQuestions}</p><p><strong>Time:</strong> ${timeStr}</p></div>`;
             quizContainerElement.appendChild(resultsDiv);

             // Results Buttons
             const actionsDiv = document.createElement('div'); actionsDiv.className = 'results-actions quiz-buttons';
             const redoBtn = document.createElement('button'); redoBtn.className = 'btn redo-btn'; redoBtn.textContent = 'Redo Quiz';
             redoBtn.onclick = () => { startQuiz(quizState.subject, quizState.unit, quizState.lesson, quizState.originalQuestions); };
             actionsDiv.appendChild(redoBtn); // Redo Button

             if (quizState.totalQuestions > 0) { const revBtn = document.createElement('button'); revBtn.id = 'review-btn'; revBtn.className = 'btn review-btn'; revBtn.textContent = 'Review Answers'; revBtn.onclick = reviewAnswers; actionsDiv.appendChild(revBtn); }
             const backTopicsBtn = document.createElement('button'); backTopicsBtn.className = 'btn back-to-topics-btn'; backTopicsBtn.textContent = 'Back to Topics'; backTopicsBtn.onclick = showTopicList;
             actionsDiv.appendChild(backTopicsBtn);
             quizButtonsContainerElement.appendChild(actionsDiv);
         }

        // --- Answer Review ---
        function reviewAnswers() {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             quizTitleElement.textContent = `Review: ${quizState.lesson}`;

             const reviewDiv = document.createElement('div'); reviewDiv.className = 'review-container';
             quizState.questions.forEach((q, i) => {
                 const box = document.createElement('div'); const userAns = quizState.selectedAnswers[i]; let { correctnessClass, statusText } = calculateReviewStatus(q, userAns); box.className = `question-review ${correctnessClass}`;
                 box.innerHTML = `<div class="review-question-header"><span class="review-question-number">Q ${i + 1} (${q.type.replace('_',' ')})</span><span class="review-status">${statusText}</span></div><p class="review-question-text">${q.question||'?'}</p><div id="review-answer-content-${i}"></div>`; reviewDiv.appendChild(box);
                 const contentArea = box.querySelector(`#review-answer-content-${i}`); if (contentArea) { try { switch(q.type){ case "matching": reviewMatchingReview(q, userAns, contentArea); break; case "ordering": reviewOrderingReview(q, userAns, contentArea); break; case "multiple_choice": default: reviewMultipleChoiceReview(q, userAns, contentArea); break; } } catch(e){ console.error("Review render err:", e); contentArea.innerHTML = `<p style="color:red;">Err display.</p>`; } }
             });
             quizContainerElement.appendChild(reviewDiv);

             // Review Buttons
             const actionsDiv = document.createElement('div'); actionsDiv.className = 'review-actions quiz-buttons';
             const backResultsBtn = document.createElement('button'); backResultsBtn.className = 'btn back-btn'; backResultsBtn.textContent = '← Back to Results'; backResultsBtn.onclick = displayResults; actionsDiv.appendChild(backResultsBtn);
             const backTopicsBtn = document.createElement('button'); backTopicsBtn.className = 'btn back-to-topics-btn'; backTopicsBtn.textContent = 'Back to Topics'; backTopicsBtn.onclick = showTopicList; actionsDiv.appendChild(backTopicsBtn);
             quizButtonsContainerElement.appendChild(actionsDiv);
         }
        function calculateReviewStatus(question, userAnswer) {
            let cl='incorrect',st='✗ Incorrect',ok=!1;try{switch(question.type){case"matching":const cp=question.answer||{},tot=Object.keys(cp).length;let ct=0;if(tot>0&&userAnswer&&"object"==typeof userAnswer)for(const pIdx in cp)userAnswer.hasOwnProperty(pIdx)&&userAnswer[pIdx]===cp[pIdx]&&ct++;ok=tot>0&&ct===tot,ok?(cl="correct",st="✓ Correct"):ct>0&&(cl="partial",st=`~ Partial (${ct}/${tot})`);break;case"ordering":userAnswer&&Array.isArray(userAnswer)&&question.answer&&Array.isArray(question.answer)&&(ok=JSON.stringify(userAnswer)===JSON.stringify(question.answer)),cl=ok?"correct":"incorrect",st=ok?"✓ Correct":"✗ Incorrect";break;case"multiple_choice":default:null!==userAnswer&&question.options&&question.answer&&(ok=question.options[userAnswer]===question.answer),cl=ok?"correct":"incorrect",st=ok?"✓ Correct":"✗ Incorrect"}}catch(e){console.error("CalcReviewStatus Error:",e)}return{correctnessClass:cl,statusText:st};
         }
        function reviewMultipleChoiceReview(question, userAnswerIndex, container) {
            const div=document.createElement("div");div.className="review-mc-answer";const userTxt=null!==userAnswerIndex&&question.options?.[userAnswerIndex]!==void 0?question.options[userAnswerIndex]:"No answer",isOk=null!==userAnswerIndex&&userTxt===question.answer;div.innerHTML=`<p><strong>Your answer:</strong> <span class="user-answer-text ${isOk?"correct":null!==userAnswerIndex?"incorrect":""}">${userTxt}</span></p>${isOk?"":`<p><strong>Correct answer:</strong> <span class="correct-answer-text">${question.answer||"N/A"}</span></p>`}`,container.appendChild(div);
         }
        function reviewMatchingReview(question, userPairs, container) {
             const div=document.createElement("div");div.className="review-matching-answer",div.innerHTML="<p><strong>Matching Review:</strong></p>";const grid=document.createElement("div");grid.className="review-matching-grid";const pCol=document.createElement("div");pCol.className="review-matching-column";const mCol=document.createElement("div");mCol.className="review-matching-column";const correct=question.answer||{};(question.prompts||[]).forEach((pTxt,pIdx)=>{const userMIdx=userPairs?userPairs[pIdx]:null,correctMIdx=correct[pIdx],isPairOk=null!==userMIdx&&userMIdx===correctMIdx,pDiv=document.createElement("div");pDiv.textContent=pTxt;const mDiv=document.createElement("div"),userMTxt=null!==userMIdx&&question.matches?.[userMIdx]?question.matches[userMIdx]:"(No match)",correctMTxt=void 0!==correctMIdx&&question.matches?.[correctMIdx]?question.matches[correctMIdx]:"(N/A)";isPairOk?(pDiv.className="review-matched-pair-correct",mDiv.textContent=correctMTxt,mDiv.className="review-matched-pair-correct"):(pDiv.className="review-matched-pair-incorrect",mDiv.innerHTML=`<span style="text-decoration: line-through; color: var(--incorrect-text);">${userMTxt}</span> <span style="color: var(--correct-text);">(${correctMTxt})</span>`,mDiv.className="review-matched-pair-incorrect"),pCol.appendChild(pDiv),mCol.appendChild(mDiv)}),grid.append(pCol,mCol),div.appendChild(grid),container.appendChild(div);
         }
        function reviewOrderingReview(question, userOrderedItems, container) {
             const div=document.createElement("div");div.className="review-ordering-answer";const correctOrd=question.answer||[],isOk=userOrderedItems&&JSON.stringify(userOrderedItems)===JSON.stringify(correctOrd);div.innerHTML="<p><strong>Ordering Review:</strong></p>";const list=document.createElement("div");list.className="review-ordering-list",correctOrd.forEach((corrTxt,corrIdx)=>{const item=document.createElement("div");item.className="review-ordering-list-item";const userIdx=userOrderedItems?userOrderedItems.indexOf(corrTxt):-1,userNum=-1!==userIdx?userIdx+1:null,correctNum=corrIdx+1;let numSpan="";numSpan=userNum===correctNum?`<span class="review-order-number review-order-correct">${userNum}.</span>`:null!==userNum?`<span class="review-order-number review-order-incorrect">${userNum}.</span> <span class="review-order-number review-order-correct">(${correctNum}.)</span>`:`<span class="review-order-number review-order-incorrect">(N/P)</span> <span class="review-order-number review-order-correct">(${correctNum}.)</span>`,item.innerHTML=`${numSpan} ${corrTxt}`,list.appendChild(item)}),div.appendChild(list),!isOk&&userOrderedItems&&(div.innerHTML+=`<p style="margin-top:10px;"><strong>Your Order:</strong> ${userOrderedItems.join(" → ")}</p>`),container.appendChild(div);
         }

        // --- Error Display ---
        function showError(subject, unit, lesson, message = '') { // Renders error into quiz container
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             showQuizView(); quizTitleElement.textContent = 'Error';
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             const msg = message || `Sorry, no questions available for ${lesson} in ${unit}.`;
             const errDiv = document.createElement('div'); errDiv.className = 'error-display'; errDiv.innerHTML = `<div class="error-message">${msg}</div>`;
             const backBtn = document.createElement('button'); backBtn.className = 'btn back-to-topics-btn'; backBtn.textContent = 'Back to Topics'; backBtn.onclick = showTopicList; errDiv.appendChild(backBtn);
             quizContainerElement.appendChild(errDiv);
        }

        // --- Get Questions Data ---
        function getQuestions(subject, unitTitle, lessonTitle) { // Adds default type if missing
             const semBtn = document.querySelector('.semester-btn.active'); if (!semBtn) { console.error("No active semester."); return []; } const sem = semBtn.dataset.semester;
             if (!subject || !unitTitle || !lessonTitle || !sem) { console.error("Missing params for getQuestions."); return []; }
             try {
                 const semData = topicsData[subject]?.[sem]; const units = semData?.units; if (!units) { console.warn(`Data missing: ${subject} -> ${sem}`); return []; }
                 const unit = units.find(u => u?.title === unitTitle); const lessons = unit?.lessons; if (!lessons) { console.warn(`Unit "${unitTitle}" or lessons missing.`); return []; }
                 const lesson = lessons.find(l => l?.title === lessonTitle); if (!lesson) { console.warn(`Lesson "${lessonTitle}" missing.`); return []; }
                 if (lesson.questions?.length) { return lesson.questions.map(q => ({ ...(q.type ? {} : {type: 'multiple_choice'}), ...q })); } else { return []; } // Default to MC if type missing
             } catch (e) { console.error("Error finding questions:", e); return []; }
         }

        // --- END OF questions.js ---
    </script>

</body>
</html>
