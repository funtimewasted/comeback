<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Question Bank</title>
    <style>
        /* --- START OF styles.css --- */
        :root {
            /* Light Theme Variables */
            --body-bg: #f8fafc;
            --container-bg: #ffffff;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --text-heading: #0f172a;
            --border-color: #e2e8f0;
            --border-color-hover: #cbd5e1;
            --accent-color: #2563eb;
            --accent-color-dark: #1d4ed8;
            --accent-color-light: #dbeafe;
            --button-bg: #ffffff;
            --button-border: #e0e0e0;
            --button-text: #334155;
            --button-hover-bg: #f1f5f9;
            --button-active-bg: #0f172a;
            --button-active-text: #ffffff;
            --button-secondary-bg: #64748b;
            --button-secondary-hover-bg: #475569;
            --button-disabled-bg: #94a3b8;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --feedback-bg: #f1f5f9;
            --feedback-border: #e2e8f0;
            --correct-bg: #dcfce7;
            --correct-border: #16a34a;
            --correct-text: #065f46;
            --incorrect-bg: #fee2e2;
            --incorrect-border: #ef4444;
            --incorrect-text: #b91c1c;
            --partial-bg: #fef9c3;
            --partial-border: #f59e0b;
            --partial-text: #854d0e;
            --shadow-color: rgba(0,0,0,0.05);
            --matched-item-bg: #e5e7eb;
            --matched-item-border: #9ca3af;
            --modal-overlay-bg: rgba(15, 23, 42, 0.6); /* Dark blue overlay */
            --modal-bg: #ffffff;
            --lesson-stat-text: #475569;
            --lesson-perfect-bg: #e0fadf; /* Lighter green */
            --lesson-perfect-border: #54c780;
            --lesson-perfect-text: #065f46;
            --lesson-imperfect-bg: #ffe9e9; /* Lighter red */
            --lesson-imperfect-border: #f79494;
            --lesson-imperfect-text: #b91c1c;
        }

        body.dark-theme {
            /* Dark Theme Variable Overrides */
            --body-bg: #0f172a; /* Dark blue */
            --container-bg: #1e293b; /* Slightly lighter blue */
            --text-color: #cbd5e1; /* Lighter gray */
            --text-muted: #94a3b8; /* Medium gray */
            --text-heading: #f1f5f9; /* Off-white */
            --border-color: #334155; /* Darker gray-blue */
            --border-color-hover: #475569;
            --accent-color: #3b82f6; /* Brighter blue for dark */
            --accent-color-dark: #2563eb;
            --accent-color-light: #1e3a8a; /* Darker blue for selection */
            --button-bg: #334155;
            --button-border: #475569;
            --button-text: #e2e8f0;
            --button-hover-bg: #475569;
            --button-active-bg: #f1f5f9;
            --button-active-text: #0f172a;
            --button-secondary-bg: #475569;
            --button-secondary-hover-bg: #52525b; /* Zinc */
            --button-disabled-bg: #334155;
            --input-bg: #0f172a;
            --input-border: #475569;
            --feedback-bg: #1e293b;
            --feedback-border: #334155;
            --correct-bg: #064e3b; /* Dark green */
            --correct-border: #10b981;
            --correct-text: #a7f3d0;
            --incorrect-bg: #7f1d1d; /* Dark red */
            --incorrect-border: #f87171;
            --incorrect-text: #fecaca;
            --partial-bg: #713f12; /* Dark amber */
            --partial-border: #fbbf24;
            --partial-text: #fef08a;
            --shadow-color: rgba(0,0,0,0.2);
            --matched-item-bg: #475569;
            --matched-item-border: #64748b;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7); /* Darker overlay */
            --modal-bg: #1e293b;
            --lesson-stat-text: #94a3b8;
            --lesson-perfect-bg: #064e3b; /* Dark Green */
            --lesson-perfect-border: #10b981;
            --lesson-perfect-text: #a7f3d0;
            --lesson-imperfect-bg: #7f1d1d; /* Dark Red */
            --lesson-imperfect-border: #f87171;
            --lesson-imperfect-text: #fecaca;
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0; /* Remove body padding */
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Welcome View --- */
        #welcome-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            background-color: var(--body-bg);
            color: var(--text-color);
            padding: 40px 20px;
        }
        #welcome-view h1 { font-size: 28px; color: var(--text-heading); margin-bottom: 15px; }
        #welcome-view p { font-size: 16px; color: var(--text-muted); max-width: 600px; line-height: 1.6; margin-bottom: 25px; }
        #welcome-view .info-section { margin-bottom: 20px; font-size: 14px; }
        #welcome-view .info-section strong { display: block; margin-bottom: 5px; color: var(--text-heading); }
        #welcome-view .get-started-btn { margin-top: 30px; }

        /* --- Main Container --- */
        .container {
            max-width: 1200px; margin: 20px auto; background-color: var(--container-bg);
            padding: 20px 30px; border-radius: 12px; box-shadow: 0 2px 10px var(--shadow-color);
            border: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.5s ease;
            opacity: 1;
        }
        .container.initially-hidden { opacity: 0; pointer-events: none; }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            text-align: left; margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 { font-size: 24px; margin: 0; color: var(--text-heading); }

        /* --- Settings Button --- */
        #settings-btn {
            background: none; border: 1px solid var(--button-border); color: var(--text-muted);
            padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 20px;
            line-height: 1; transition: all 0.2s ease;
        }
        #settings-btn:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); color: var(--text-color); }

        /* Nav Section */
        .nav-section {
            display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;
            transition: opacity 0.3s ease, max-height 0.3s ease, visibility 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            overflow: hidden; max-height: 500px; opacity: 1; visibility: visible;
        }
        .nav-section.hidden { max-height: 0; opacity: 0; margin-bottom: 0; padding: 0; border: none; visibility: hidden; }
        .subjects { display: flex; flex-wrap: wrap; gap: 10px; }
        .secondary-nav { display: flex; gap: 10px; align-items: center; }
        .nav-btn {
            padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;
            display: flex; align-items: center; gap: 6px; background-color: var(--button-bg);
            border: 1px solid var(--button-border); transition: all 0.2s ease; color: var(--button-text);
        }
        .nav-btn:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .nav-btn.active { background-color: var(--button-active-bg); color: var(--button-active-text); border-color: var(--button-active-bg); }
        .nav-btn.active span {
            body.dark-theme & { filter: none; }
            body:not(.dark-theme) & { filter: brightness(0) invert(1); }
        }
        .semester-toggle { display: flex; gap: 5px; background-color: var(--feedback-bg); padding: 4px; border-radius: 6px; border: 1px solid var(--button-border); }
        .semester-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; background: none; color: var(--text-muted); transition: all 0.2s ease; }
        .semester-btn.active { background-color: var(--container-bg); color: var(--text-heading); box-shadow: 0 1px 3px var(--shadow-color); }

        /* --- Topic List Styles (#content) --- */
        #content { /* remains visible */ }
        .semester-title-container { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .unit-title { font-size: 20px; font-weight: 600; color: var(--text-heading); margin: 0; }
        .section { background-color: var(--container-bg); border-radius: 12px; padding: 20px 25px; box-shadow: 0 1px 3px var(--shadow-color); border: 1px solid var(--border-color); margin-bottom: 20px; }
        .semester-content > .section:last-of-type { margin-bottom: 0; }
        .section-title { font-size: 17px; font-weight: 600; margin-bottom: 15px; color: var(--text-heading); }
        .section-content { /* Lesson Box */
            padding: 12px 15px; /* Adjusted padding */ background-color: var(--button-bg); border-radius: 8px;
            border: 1px solid var(--button-border); margin-bottom: 10px; cursor: pointer;
            transition: all 0.2s ease; font-size: 15px; color: var(--button-text);
            display: flex; justify-content: space-between; align-items: center; text-align: left;
            position: relative; /* For absolute positioned stats maybe */
            overflow: hidden; /* Ensure border-radius applies */
            border-left-width: 4px; /* Add space for status color */
            border-left-color: transparent; /* Default */
        }
        .section-content:last-child { margin-bottom: 0; }
        .section-content:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); transform: translateY(-1px); }

        /* Lesson Box Status Styling */
        .section-content.lesson-complete-perfect {
            background-color: var(--lesson-perfect-bg);
            border-color: var(--lesson-perfect-border);
            border-left-color: var(--lesson-perfect-border); /* Colored left border */
        }
        .section-content.lesson-complete-perfect span, /* Target spans inside */
        .section-content.lesson-complete-perfect .lesson-stats-display {
            color: var(--lesson-perfect-text);
        }
        .section-content.lesson-complete-imperfect {
            background-color: var(--lesson-imperfect-bg);
            border-color: var(--lesson-imperfect-border);
            border-left-color: var(--lesson-imperfect-border); /* Colored left border */
        }
        .section-content.lesson-complete-imperfect span, /* Target spans inside */
        .section-content.lesson-complete-imperfect .lesson-stats-display {
             color: var(--lesson-imperfect-text);
        }

        .lesson-title-text { /* Wrap lesson title for flex control */
             flex-grow: 1; margin-right: 15px;
        }
        .lesson-q-count, .lesson-stats-display {
            font-size: 0.8em; color: var(--lesson-stat-text); /* Use variable */
            font-weight: 400; white-space: nowrap; flex-shrink: 0;
        }
        .lesson-q-count { margin-left: 10px; } /* Add some space */
        .lesson-stats-display { margin-left: 10px; font-weight: 500; } /* Stats slightly bolder */

        .semester-content { display: none; }
        .semester-content.active { display: block; }

        /* --- Quiz View Styles (#quiz-view) --- */
        #quiz-view { padding: 20px 0; }
        #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        #quiz-title { font-size: 20px; font-weight: 600; color: var(--text-heading); }
        #quiz-container { margin-bottom: 20px; }
        .question-type-wrapper { padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--container-bg); margin-bottom: 20px; box-shadow: 0 1px 2px var(--shadow-color); }
        .question-progress { font-size: 14px; color: var(--text-muted); margin-bottom: 15px; text-align: right; }
        .question-text { font-size: 18px; margin-bottom: 25px; line-height: 1.6; color: var(--text-color); }
        .question-text strong { font-weight: 600; margin-right: 5px; }

        /* --- MC Specific --- */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 0; }
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background-color: var(--input-bg); }
        .option-label:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .option-label input:checked + .option-text { font-weight: 500; color: var(--accent-color); }
        .option-label input:checked { accent-color: var(--accent-color); }
        .option-input { margin-right: 15px; flex-shrink: 0; }
        .option-text { flex-grow: 1; font-size: 16px; color: var(--text-color); }

        /* --- Matching Specific --- */
        .matching-instructions { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
        .matching-container { position: relative; display: flex; justify-content: space-between; gap: 5%; margin-bottom: 0; }
        .matching-column { flex-basis: 47%; display: flex; flex-direction: column; gap: 10px; }
        .matching-column h4 { margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .matching-item { padding: 10px 15px; border: 1px solid var(--input-border); background-color: var(--input-bg); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; display: flex; align-items: center; min-height: 30px; color: var(--text-color); }
        .matching-item:hover { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); }
        .matching-item.selected { background-color: var(--accent-color-light); border-color: var(--accent-color); font-weight: 500; }
        .matching-item.matched { background-color: var(--matched-item-bg); border-color: var(--matched-item-border); cursor: pointer; opacity: 1.0; }
        #matching-arrow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 1; }
        #matching-arrow-svg line { stroke: var(--accent-color); stroke-width: 2; transition: all 0.3s ease; marker-end: url(#arrowhead); }
        #matching-arrow-svg #arrowhead polygon { fill: var(--accent-color); }

        /* --- Ordering Specific --- */
        .ordering-instructions { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
        .ordering-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 0; }
        .ordering-item { display: flex; align-items: center; padding: 10px 15px; border: 1px solid var(--border-color); background-color: var(--input-bg); border-radius: 6px; }
        .ordering-select { margin-right: 15px; padding: 5px 8px; border-radius: 4px; border: 1px solid var(--input-border); font-size: 14px; min-width: 60px; background-color: var(--input-bg); color: var(--text-color); }
        .ordering-text { flex-grow: 1; font-size: 16px; color: var(--text-color); }

        /* --- Feedback & Buttons --- */
        #feedback-container { padding: 15px; margin-top: 20px; border-radius: 6px; background-color: var(--feedback-bg); border: 1px solid var(--feedback-border); }
        #feedback-container.hidden { display: none; }
        .correct-feedback { color: var(--correct-text); font-weight: 600; font-size: 16px; }
        .incorrect-feedback { color: var(--incorrect-text); font-weight: 600; font-size: 16px; }
        .incorrect-feedback span { display: block; font-weight: 500; margin-top: 8px; font-size: 15px; color: var(--text-muted); line-height: 1.5; }
        .partial-feedback { color: var(--partial-text); font-weight: 600; font-size: 16px; }

        /* Highlighting */
        .correct-option { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; }
        .correct-option .option-text { color: var(--correct-text) !important; }
        .incorrect-option { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; }
        .incorrect-option .option-text { color: var(--incorrect-text) !important; }

        /* --- Button container --- */
        #quiz-buttons-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .results-actions, .review-actions { justify-content: space-between; width: 100%; } /* Ensure full width */
        .results-actions { flex-wrap: wrap; justify-content: center; gap: 15px; /* Added gap */ }
        .results-actions .back-to-topics-btn { margin-left: auto; /* Pushes to right */ }
        .review-actions .back-to-topics-btn { margin-left: auto; /* Pushes to right */}
        @media (max-width: 550px) { /* Adjust breakpoint */
            .results-actions, .review-actions { justify-content: center; } /* Center on smaller screens */
            .results-actions .back-to-topics-btn,
            .review-actions .back-to-topics-btn { margin-left: 0; }
        }

        /* --- Buttons --- */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s ease; line-height: 1.5; background-color: var(--button-bg); color: var(--button-text); border: 1px solid var(--button-border); display: inline-flex; align-items: center; gap: 6px; /* For icons */ }
        .btn:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--border-color-hover); transform: translateY(-1px); }
        .submit-btn { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .submit-btn:hover:not(:disabled) { background-color: var(--accent-color-dark); border-color: var(--accent-color-dark); }
        .submit-btn:disabled { background-color: var(--button-disabled-bg); border-color: var(--button-disabled-bg); color: var(--text-muted); cursor: not-allowed; transform: none; }
        .next-btn { background-color: var(--correct-border); color: var(--correct-text); border-color: var(--correct-border); }
        body.dark-theme .next-btn { color: white; }
        .next-btn:hover { filter: brightness(1.1); }
        .review-btn { background-color: var(--correct-border); color: var(--correct-text); border-color: var(--correct-border); }
        body.dark-theme .review-btn { color: white; }
        .review-btn:hover { filter: brightness(1.1); }
        .redo-btn { background-color: #f97316; color: white; border-color: #f97316; }
        .redo-btn:hover { background-color: #ea580c; border-color: #ea580c; }
        .close-btn, .back-to-topics-btn, .back-btn { background-color: var(--button-secondary-bg); color: white; border-color: var(--button-secondary-bg); }
        .close-btn:hover, .back-to-topics-btn:hover, .back-btn:hover { background-color: var(--button-secondary-hover-bg); border-color: var(--button-secondary-hover-bg); }
        .reset-data-btn { background-color: var(--incorrect-border); color: var(--incorrect-text); border-color: var(--incorrect-border); }
        body.dark-theme .reset-data-btn { color: white; }
        .reset-data-btn:hover { filter: brightness(1.1); }


        .hidden { display: none !important; }

        /* --- Error Message Styles --- */
        .error-display { padding: 30px; text-align: center; background-color: var(--incorrect-bg); border: 1px solid var(--incorrect-border); border-radius: 8px; }
        .error-message { color: var(--incorrect-text); font-weight: 500; margin-bottom: 20px; }

        /* --- Results Styles (IMPROVED) --- */
        .results-container { padding: 20px 0; text-align: center; }
        .results-header { font-size: 28px; font-weight: 600; margin-bottom: 30px; color: var(--text-heading); }
        .results-score { margin: 30px 0 40px 0; }
        .score-circle {
            width: 150px; height: 150px; border-radius: 50%; background-color: var(--feedback-bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto; border: 8px solid var(--accent-color);
            box-shadow: 0 0 20px color-mix(in srgb, var(--accent-color) 25%, transparent), inset 0 0 10px color-mix(in srgb, var(--accent-color) 15%, transparent);
            transition: border-color 0.3s ease;
        }
        .score-number { font-size: 44px; font-weight: bold; color: var(--text-heading); line-height: 1; }
        .score-percent-sign { font-size: 20px; font-weight: 500; color: var(--text-muted); margin-top: 4px; }
        .results-details {
            max-width: 500px; margin: 0 auto 35px auto; text-align: left;
            background-color: var(--feedback-bg); padding: 20px 30px; border-radius: 10px;
            border: 1px solid var(--feedback-border); box-shadow: 0 2px 5px var(--shadow-color);
        }
        .results-details p { margin: 12px 0; font-size: 16px; color: var(--text-color); display: flex; align-items: center; gap: 10px; }
        .results-details p strong { color: var(--text-heading); min-width: 80px; display: inline-block; font-weight: 600; }
        .results-details p .detail-value { color: var(--text-muted); font-weight: 500; }
        .results-details p .detail-icon { font-size: 18px; color: var(--accent-color); width: 20px; text-align: center; }

        /* --- Review Answers Styles --- */
        .review-container { padding: 10px 0; }
        .question-review { padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color); border-left-width: 5px; background-color: var(--container-bg); }
        .question-review.correct { border-left-color: var(--correct-border); }
        .question-review.incorrect { border-left-color: var(--incorrect-border); }
        .question-review.partial { border-left-color: var(--partial-border); }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .review-question-number { font-weight: 600; color: var(--text-heading); font-size: 16px; }
        .review-status { font-weight: 600; font-size: 14px; padding: 3px 8px; border-radius: 4px; text-align: center; }
        .question-review.correct .review-status { color: var(--correct-text); background-color: var(--correct-bg); }
        .question-review.incorrect .review-status { color: var(--incorrect-text); background-color: var(--incorrect-bg); }
        .question-review.partial .review-status { color: var(--partial-text); background-color: var(--partial-bg); }
        .review-question-text { margin-bottom: 15px; font-size: 16px; color: var(--text-color); }

        /* Review specific content */
        .review-mc-answer, .review-matching-answer, .review-ordering-answer { background-color: var(--feedback-bg); padding: 15px; border-radius: 6px; border: 1px solid var(--feedback-border); margin-top: 15px; }
        .review-mc-answer p, .review-matching-answer p, .review-ordering-answer p { margin: 8px 0; font-size: 15px; color: var(--text-color); }
        .review-mc-answer p strong, .review-matching-answer p strong, .review-ordering-answer p strong { color: var(--text-heading); margin-right: 5px; display: inline-block; min-width: 110px; }
        .review-mc-answer .correct-answer-text, .review-matching-answer .correct-answer-text, .review-ordering-answer .correct-answer-text { color: var(--correct-text); font-weight: 500; }
        .review-mc-answer .user-answer-text.incorrect { color: var(--incorrect-text); text-decoration: line-through; }
        .review-mc-answer .user-answer-text.correct { color: var(--correct-text); font-weight: 500; }

        /* Review Matching */
        .review-matching-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .review-matching-column { flex: 1; min-width: 200px;}
        .review-matching-column div { padding: 5px 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); }
        .review-matched-pair-correct { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; color: var(--correct-text) !important; }
        .review-matched-pair-incorrect { background-color: var(--incorrect-bg) !important; border-color: var(--incorrect-border) !important; /* Color handled by spans inside */}
        body.dark-theme .review-matched-pair-incorrect span { color: var(--incorrect-text) !important; opacity: 0.7; }
        body.dark-theme .review-matched-pair-incorrect span + span { color: var(--correct-text) !important; opacity: 1; }
        body:not(.dark-theme) .review-matched-pair-incorrect span { color: var(--incorrect-text) !important; opacity: 0.7; }
        body:not(.dark-theme) .review-matched-pair-incorrect span + span { color: var(--correct-text) !important; opacity: 1; }


        /* Review Ordering */
        .review-ordering-list { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .review-ordering-list-item { display: flex; align-items: center; padding: 6px 10px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); }
        .review-order-number { font-weight: 600; margin-right: 8px; }
        .review-order-correct { color: var(--correct-text); }
        .review-order-incorrect { color: var(--incorrect-text); text-decoration: line-through; opacity: 0.8; }


        /* --- Settings Modal --- */
        #settings-modal {
            position: fixed; inset: 0; background-color: var(--modal-overlay-bg);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #settings-modal.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--modal-bg); padding: 25px 30px; border-radius: 12px;
            box-shadow: 0 5px 20px var(--shadow-color); width: 90%; max-width: 400px;
            border: 1px solid var(--border-color); position: relative;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        #settings-modal.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 20px; font-weight: 600; color: var(--text-heading); }
        .modal-close-btn { font-size: 24px; background: none; border: none; color: var(--text-muted); cursor: pointer; line-height: 1; padding: 0 5px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h4 { font-size: 16px; font-weight: 500; color: var(--text-heading); margin: 0 0 12px 0; }
        .theme-options label { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; font-size: 15px; color: var(--text-color); }
        .theme-options input[type="radio"] { accent-color: var(--accent-color); }
        .modal-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: right; }

        /* --- END OF styles.css --- */
    </style>
</head>
<body>

    <!-- Welcome View (Shows First) -->
    <div id="welcome-view">
        <h1>Welcome to the Interactive Question Bank!</h1>
        <p>Your place to practice and master course material.</p>
        <div class="info-section"><strong>Created By:</strong><span>[Your Name / Group Name Here]</span></div>
        <div class="info-section"><strong>Testers:</strong><span>[Tester Name 1], [Tester Name 2]</span></div>
        <div class="info-section"><strong>Honorable Mentions:</strong><span>[Mention Anyone Else Here]</span></div>
        <button class="btn submit-btn get-started-btn">Get Started</button>
    </div>

    <!-- Main Application Container -->
    <div class="container initially-hidden">
        <div class="header">
            <h1>Interactive Question Bank</h1>
            <button id="settings-btn" title="Settings">⚙️</button>
        </div>

        <!-- Navigation -->
        <div class="nav-section">
             <div class="subjects">
                 <button class="nav-btn" data-subject="اللغة العربية"><span>📚</span> اللغة العربية</button>
                 <button class="nav-btn active" data-subject="english"><span>🌎</span> English</button>
                 <button class="nav-btn" data-subject="التاريخ"><span>📜</span> التاريخ</button>
                 <button class="nav-btn" data-subject="دين"><span>📖</span> دين</button>
             </div>
             <div class="secondary-nav">
                 <div class="semester-toggle">
                     <button class="semester-btn active" data-semester="first">First Semester</button>
                     <button class="semester-btn" data-semester="second">Second Semester</button>
                 </div>
             </div>
        </div>

        <!-- Content Area for Topic Lists -->
        <div id="content">
            <!-- Topic lists loaded by JS -->
        </div>

        <!-- Quiz View Area (Initially Hidden) -->
        <div id="quiz-view" class="hidden">
            <div id="quiz-header">
                <h2 id="quiz-title">Quiz Title</h2>
                <button class="btn back-to-topics-btn" onclick="showTopicList()">⬅️ Back to Topics</button>
            </div>
            <div id="quiz-container"></div>
             <div id="feedback-container" class="feedback-container hidden"></div>
             <div id="quiz-buttons-container" class="quiz-buttons"></div>
        </div>
    </div> <!-- End of .container -->

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close-btn" onclick="toggleSettingsModal(false)" title="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h4>Theme</h4>
                    <div class="theme-options">
                        <label><input type="radio" name="theme" value="light"> Light Mode ☀️</label>
                        <label><input type="radio" name="theme" value="dark"> Dark Mode 🌙</label>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Data Management</h4>
                    <button class="btn reset-data-btn" id="reset-data-button">Reset Saved Data</button>
                     <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Clears theme, welcome screen status, and all saved lesson statistics.</p>
                </div>
            </div>
            <div class="modal-footer">
                 <button class="btn close-btn" onclick="toggleSettingsModal(false)">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- START OF topics.js ---

        // FULL Topics data structure
        const topicsData = {
            "english": { /* ... L1 data ... */
                "first": {
                    "title": "First Semester",
                    "units": [ { "title": "Unit 1", "lessons": [ { "title": "Vocabulary & Grammar Basics", "questions": [ { "type": "multiple_choice", "question": "Device in 'curtain of night fell'?", "options": ["Simile", "Metaphor", "Alliteration", "Hyperbole"], "answer": "Metaphor" }, { "type": "multiple_choice", "question": "'Ambiguous' means:", "options": ["Clear", "Uncertain", "Definite", "Determined"], "answer": "Uncertain" }, { "type": "ordering", "question": "Order alphabetically:", "items": ["Banana", "Apple", "Cherry", "Date", "Fig"], "answer": ["Apple", "Banana", "Cherry", "Date", "Fig"] }, { "type": "matching", "question": "Match country and capital:", "prompts": ["France", "Japan", "Egypt", "Brazil", "Canada"], "matches": ["Cairo", "Tokyo", "Paris", "Brasília", "Ottawa"], "answer": { "0": 2, "1": 1, "2": 0, "3": 3, "4": 4 } }, { "type": "ordering", "question": "Order tea steps:", "items": ["Add tea bag", "Boil water", "Pour water"], "answer": ["Boil water", "Add tea bag", "Pour water"] } ] }, { "title": "Past & Present Tenses & Question Tags", "questions": [ { "type": "multiple_choice", "question": "Correct tense: 'She ___ school.'", "options": ["go", "goes", "going", "went"], "answer": "goes" }, { "type": "multiple_choice", "question": "Correct tag: 'You're coming, ___?'", "options": ["aren't you", "don't you", "isn't you", "won't you"], "answer": "aren't you" } ] } ] }, { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Future Forms", "questions": [] } ] }, { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Habits & Clauses", "questions": [] } ] }, { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Narration & Inversion", "questions": [] } ] } ] }, "second": { "title": "Second Semester", "units": [ { "title": "Unit 1", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modal & Related & Articles", "questions": [] } ] }, { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Reported Speech & Reporting Verbs", "questions": [] } ] }, { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "The Passive", "questions": [] } ] }, { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Conditionals & Modals", "questions": [] } ] }, { "title": "Unit 5", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modals & Clauses", "questions": [] } ] } ] } },
            "اللغة العربية": { /* ... L1 data ... */
                "first": { "title": "الفصل الأول", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "من القيم الإنسانية في القرآن", "questions": [] }, { "title": "اسلوب الطلب وجوابه المجزوم والتشبيه المفرد", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "عمانيات", "questions": [] }, { "title": "صور الفاعل والتشبيه التمثيلي", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "الزهايمر-الخرف المبكر", "questions": [] }, { "title": "صور المبتدأ والخبر والجملة الخبرية والإنشائية", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "الإعلام ومشروع النهوض باللغة العربية", "questions": [] }, { "title": "المفعول معه والأمر", "questions": [] } ] }, { "title": "الوحدة الخامسة", "lessons": [ { "title": "التعليم التقني بوابة المستقبل في عالم متغير", "questions": [] }, { "title": "انواع ما والإستفهام", "questions": [] } ] } ] }, "second": { "title": "الفصل الثاني", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "في فتح القدس", "questions": [] }, { "title": "معاني حروف الجر والتشخيص", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "قصة-حفنة تمر", "questions": [] }, { "title": "اسم الفاعل واسم المفعول والطباق والمقابلة", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "شاعرات من بلدي", "questions": [] }, { "title": "اسم الزمان واسم المكان وجمع التكسير (القلة والكثرة)", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "من مقامات بديع الزمان الهمذاني", "questions": [] }, { "title": "مصدر المرة ومصدر الهيئة والبحر المتدارك", "questions": [] } ] }, { "title": "الوحدة الخامسة", "lessons": [ { "title": "الذكاء الاصطناعي-عالم جديد", "questions": [] }, { "title": "اسم الآلة", "questions": [] } ] } ] } },
             "التاريخ": { /* ... L1 data ... */
                 "first": { "title": "الفصل الأول", "units": [ { "title": "الأردن في العصور القديمة", "lessons": [ { "title": "الأردن في العصور الحجرية", "questions": [] }, { "title": "الأردن في العصر الحديدي", "questions": [] }, { "title": "مملكة الأنباط", "questions": [] }, { "title": "مظاهر الحضارة اليونانية في الأردن", "questions": [] }, { "title": "مظاهر الحضارة الرومانية-البيزنطية في الأردن", "questions": [] } ] }, { "title": "الأردن في صدر الإسلام", "lessons": [ { "title": "الأردن في صدر الإسلام", "questions": [] }, { "title": "الأردن في العصر الأموي", "questions": [] }, { "title": "الأردن في العصر العباسي", "questions": [] }, { "title": "الأردن خلال حملات الفرنجة", "questions": [] }, { "title": "الأردن في العصر الأيوبي", "questions": [] }, { "title": "الأردن في العصر المملوكي", "questions": [] } ] }, { "title": "الأردن في العصر الحديث", "lessons": [ { "title": "الأوضاع السياسية والإدارية في الأردن في العهد العثماني", "questions": [] }, { "title": "الأوضاع الإجتماعية والإقتصادية الأردن في العهد العثماني", "questions": [] }, { "title": "الثورة العربية الكبرى", "questions": [] }, { "title": "الأردن في عهد المملكة العربية السورية والحكومات المحلية", "questions": [] } ] } ] }, "second": { "title": "الفصل الثاني", "units": [ { "title": "الحياة السياسية في الأردن", "lessons": [ { "title": "تأسيس الإمارة الأردنية", "questions": [] }, { "title": "استقلال المملكة الأردنية الهاشمية", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1948-1957)", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1958-1999)", "questions": [] }, { "title": "الحياة السياسية في الأردن منذ 1999", "questions": [] }, { "title": "الأردن والعلاقات العربية والدولية", "questions": [] }, { "title": "القوات المسلحة الأردنية - الجيش العربي", "questions": [] }, { "title": "الأجهزة الأمنية الأردنية", "questions": [] } ] }, { "title": "الحياة الاقتصادية في الأردن", "lessons": [ { "title": "الحياة الاقتصادية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1951-1967)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1968-1999)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن منذ عام 1999", "questions": [] } ] }, { "title": "الحياة الاجتماعية في الأردن", "lessons": [ { "title": "الحياة الاجتماعية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن بين عامي (1951-1999)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن منذ عام 1999", "questions": [] } ] }, { "title": "التعليم والثقافة في الأردن", "lessons": [ { "title": "التعليم العام في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1951-1987)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1988-2024)", "questions": [] }, { "title": "التعليم العالي والبحث العلمي في الأردن منذ عام 1951", "questions": [] }, { "title": "الحياة الثقافية في الأردن في عهد الإمارة", "questions": [] }, { "title": "الحياة الثقافية في الأردن منذ عام 1946", "questions": [] } ] }, { "title": "الأردن والقضية الفلسطينية", "lessons": [ { "title": "موقف الأردن من القضية الفلسطينية بين عامي (1916-1951)", "questions": [] }, { "title": "موقف الأردن من القضية الفلسطينية منذ عام 1951", "questions": [] }, { "title": "الوصاية والإعمار الهاشمي للمقدسات الدينية في القدس", "questions": [] } ] } ] } },
             "دين": { /* ... L1 data ... */
                 "first": { "title": "الفصل الأول", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة آل عمران (102-105)", "questions": [] }, { "title": "حديث اتقاء الشبهات", "questions": [] }, { "title": "من صور الضلال", "questions": [] }, { "title": "كرامة الإنسان في الشريعة", "questions": [] }, { "title": "الزواج-مشروعيته ومقدماته", "questions": [] }, { "title": "الجهاد في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "جهود علماء المسلمين في خدمة القرآن", "questions": [] }, { "title": "العزيمة والرخصة", "questions": [] }, { "title": "معركة مؤتة (8 هجري)", "questions": [] }, { "title": "المحرمات من النساء", "questions": [] }, { "title": "التعايش الإنساني", "questions": [] }, { "title": "الحقوق الإجتماعية للمرأة في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة آل عمران (169-174)", "questions": [] }, { "title": "حديث - رضا الله تعالى", "questions": [] }, { "title": "فتح مكة (8 هجري)", "questions": [] }, { "title": "من خصائص الشريعة - الإيجابية", "questions": [] }, { "title": "شروط صحة عقد الزواج", "questions": [] }, { "title": "الحقوق المالية للمرأة في الإسلام", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "سورة الروم (21-24)", "questions": [] }, { "title": "مكانة السنة النبوية في التشريع", "questions": [] }, { "title": "مراعاة الأعراف في الشريعة", "questions": [] }, { "title": "حقوق الزوجين", "questions": [] }, { "title": "تنظيم النسل وتحديده", "questions": [] }, { "title": "الأمن الغذائي في الإسلام", "questions": [] }, { "title": "الإسلام والوحدة الوطنية", "questions": [] } ] } ] }, "second": { "title": "الفصل الثاني", "units": [ { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة البقرة (284-286)", "questions": [] }, { "title": "دلائل وجود الله تعالى", "questions": [] }, { "title": "إعجاز القرآن الكريم", "questions": [] }, { "title": "الأمر بالمعروف والنهي عن المنكر", "questions": [] }, { "title": "اليوم الآخر - احداثه وآثار الإيمان به", "questions": [] }, { "title": "الإجتهاد في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثانية", "lessons": [ { "title": "سورة الأعراف (31-34)", "questions": [] }, { "title": "مراعاة المصالح في الشريعة", "questions": [] }, { "title": "جهود علماء المسلمين في الحفاظ على السنة النبوية", "questions": [] }, { "title": "حديث - منهج الإسلام في الحياة", "questions": [] }, { "title": "رسائل النبي الى الملوك والزعماء في عصره", "questions": [] }, { "title": "يوم تبوك (9 هجري)", "questions": [] }, { "title": "الحقوق السياسية للمرأة في الإسلام", "questions": [] } ] }, { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة الفرقان (63-77)", "questions": [] }, { "title": "الطلاق", "questions": [] }, { "title": "العدة", "questions": [] }, { "title": "الوصية في الشريعة", "questions": [] }, { "title": "الميراث في الشريعة", "questions": [] }, { "title": "من خصائص الشريعة - الوسطية", "questions": [] }, { "title": "مجالات الوقف ودورها في التنمية", "questions": [] } ] }, { "title": "الوحدة الرابعة", "lessons": [ { "title": "حديث - مفهوم الإفلاس بين الدنيا والآخرة", "questions": [] }, { "title": "مقاصد الشريعة", "questions": [] }, { "title": "منهج الإسلام في مكافحة الجريمة", "questions": [] }, { "title": "من وصايا النبي في حجة الوداع", "questions": [] }, { "title": "المسؤولية المجتمعية في الإسلام", "questions": [] }, { "title": "حقوق الإنسان بين الإسلام والإعلان العالمي لحقوق الإنسان", "questions": [] } ] } ] } }
        };

        // Function to generate HTML for topic lists including stats placeholders
        function generateSemesterContent(subject, semester) {
            const sanitizedSubject = subject.replace(/\s+/g, '-');
            const id = `${sanitizedSubject}-${semester}`;

            if (!topicsData[subject]?.[semester]) {
                console.error(`Data missing for ${subject}, ${semester}`);
                return `<div id="${id}" class="semester-content"><div class="section"><p>Content unavailable.</p></div></div>`;
            }
            const semesterData = topicsData[subject][semester];

            let html = `<div id="${id}" class="semester-content">`;
            html += `<div class="semester-title-container"><div class="unit-title">${semesterData.title}</div></div>`;

            if (!semesterData.units?.length) {
                 html += `<div class="section"><p>No units available.</p></div>`;
            } else {
                 semesterData.units.forEach(unit => {
                     if (unit?.title) {
                         html += `<div class="section"><div class="section-title">${unit.title}</div>`;
                         if (unit.lessons?.length) {
                             unit.lessons.forEach(lesson => {
                                 if (lesson?.title) {
                                     const qCount = lesson.questions?.length || 0;
                                     const countText = qCount === 1 ? "1 Q" : `${qCount} Qs`; // Shorter text
                                     // Add spans for title, stats, and count
                                     html += `<div class="section-content" data-subject="${subject}" data-semester="${semester}" data-unit="${unit.title}" data-lesson="${lesson.title}">
                                                 <span class="lesson-title-text">${lesson.title}</span>
                                                 <span class="lesson-stats-display"></span> <!-- Placeholder for stats -->
                                                 <span class="lesson-q-count">(${countText})</span>
                                               </div>`;
                                 } else { console.warn(`Invalid lesson title in unit: ${unit.title}`); }
                             });
                         } else {
                             html += `<p style="margin:10px 0 0 0; font-size:14px; color:var(--text-muted);">(No lessons)</p>`;
                         }
                         html += `</div>`; // End Unit section
                     } else { console.warn(`Invalid unit title in ${subject}, ${semester}`); }
                 });
            }
            html += `</div>`; // End semester content
            return html;
        }

        // Generate all content structure immediately
        function generateAllContent() {
            let contentHTML = '';
            const contentDiv = document.getElementById('content');
            if (!contentDiv) { console.error("#content not found!"); return; }
            Object.keys(topicsData).forEach(subject => {
                Object.keys(topicsData[subject]).forEach(semester => {
                    contentHTML += generateSemesterContent(subject, semester);
                });
            });
            contentDiv.innerHTML = contentHTML;
        }

        generateAllContent(); // Run topics.js content generation

        // --- END OF topics.js ---
    </script>

    <script>
        // --- START OF questions.js ---

        // --- Global State ---
        let quizState = { /* ... same as before ... */
            currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null,
            selectedAnswers: [], questions: [], originalQuestions: [], subject: '', unit: '', lesson: '', semester: '', // Added semester
            matchingState: { selectedPromptElement: null, userPairs: {} }
        };
        let allLessonStats = {}; // Holds stats loaded from localStorage

        // --- Constants for LocalStorage ---
        const LS_THEME_KEY = 'quizAppTheme';
        const LS_VISITED_KEY = 'quizAppVisited';
        const LS_STATS_KEY = 'quizAppLessonStats'; // Key for lesson statistics

        // --- DOM Element References ---
        let contentElement, quizViewElement, quizTitleElement, quizContainerElement,
            feedbackContainerElement, quizButtonsContainerElement, matchingSvgElement,
            navSectionElement, welcomeViewElement, mainContainerElement, settingsModalElement,
            settingsButtonElement;
        let matchingArrowObserver = null;
        let resizeTimeout = null;

        // --- Utility Functions ---
        function shuffleArray(array) { /* ... same as before ... */
             const newArray = [...array];
             for (let i = newArray.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[newArray[i], newArray[j]] = [newArray[j], newArray[i]];}
             return newArray;
        }
        function debounce(func, wait) { /* ... same as before ... */
            let timeout;
            return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); };
        }
        // Format time in seconds to "Xm Ys" or just "Ys"
        function formatTime(totalSeconds) {
            if (totalSeconds === null || totalSeconds < 0) return 'N/A';
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

       // --- Lesson Stats Management ---

        // Function to create a unique key for localStorage based on lesson details
        function getLessonStorageKey(subject, semester, unit, lesson) {
           // Simple concatenation, assumes titles don't contain delimiters used here.
           // Replace spaces in components to make the key more robust.
           const clean = (str) => str.replace(/\s+/g, '_').replace(/-/g, '__');
           return `${clean(subject)}-${clean(semester)}-${clean(unit)}-${clean(lesson)}`;
       }

        // Load all lesson stats from localStorage
        function loadLessonStats() {
            try {
                const storedStats = localStorage.getItem(LS_STATS_KEY);
                if (storedStats) {
                    allLessonStats = JSON.parse(storedStats);
                } else {
                    allLessonStats = {};
                }
            } catch (e) {
                console.error("Failed to load or parse lesson stats:", e);
                allLessonStats = {}; // Reset to empty object on error
            }
        }

        // Save stats for a completed lesson
        function saveLessonStats(subject, semester, unit, lesson, score, totalQuestions, timeSeconds) {
            const key = getLessonStorageKey(subject, semester, unit, lesson);
            const existingStats = allLessonStats[key];
            let shouldUpdate = false;

            if (!existingStats) {
                // First time completing this lesson
                allLessonStats[key] = {
                    bestScore: score,
                    totalQuestions: totalQuestions, // Store total for context
                    bestTime: timeSeconds
                };
                shouldUpdate = true;
            } else {
                // Compare with existing best score
                if (score > existingStats.bestScore) {
                    // New high score! Update score and time.
                    existingStats.bestScore = score;
                    existingStats.bestTime = timeSeconds;
                    existingStats.totalQuestions = totalQuestions; // Update total in case it changed
                    shouldUpdate = true;
                } else if (score === existingStats.bestScore && timeSeconds < existingStats.bestTime) {
                    // Same score, but faster time. Update time.
                    existingStats.bestTime = timeSeconds;
                    // No need to update totalQuestions if score is the same
                    shouldUpdate = true;
                }
                 // Also update total questions if it changed, even if score/time isn't better
                 if (totalQuestions !== existingStats.totalQuestions) {
                      existingStats.totalQuestions = totalQuestions;
                      shouldUpdate = true;
                 }
            }

            if (shouldUpdate) {
                try {
                    localStorage.setItem(LS_STATS_KEY, JSON.stringify(allLessonStats));
                } catch (e) {
                    console.error("Failed to save lesson stats:", e);
                }
            }
        }

         // Update the display of all visible lesson boxes
         function updateLessonBoxDisplays() {
             const activeSemesterContent = document.querySelector('.semester-content.active');
             if (!activeSemesterContent) return; // Only update visible semester

             const lessonBoxes = activeSemesterContent.querySelectorAll('.section-content');
             lessonBoxes.forEach(box => {
                 const subject = box.dataset.subject;
                 const semester = box.dataset.semester; // Get semester from box data
                 const unit = box.dataset.unit;
                 const lesson = box.dataset.lesson;
                 const statsDisplaySpan = box.querySelector('.lesson-stats-display');
                 const qCountSpan = box.querySelector('.lesson-q-count'); // Find question count span

                 if (!subject || !semester || !unit || !lesson || !statsDisplaySpan) {
                      // console.warn("Skipping box due to missing data attributes or span", box);
                      return; // Skip if essential data is missing
                 }


                 const key = getLessonStorageKey(subject, semester, unit, lesson);
                 const stats = allLessonStats[key];

                 // Reset styles first
                 box.classList.remove('lesson-complete-perfect', 'lesson-complete-imperfect');
                 statsDisplaySpan.textContent = '';
                 if(qCountSpan) qCountSpan.style.display = ''; // Ensure question count is visible initially

                 if (stats) {
                     // Format and display stats
                     const scoreText = `🏆 ${stats.bestScore}/${stats.totalQuestions}`;
                     const timeText = `⏱️ ${formatTime(stats.bestTime)}`;
                     statsDisplaySpan.textContent = `${scoreText} | ${timeText}`;

                     // Apply coloring based on score
                     if (stats.bestScore === stats.totalQuestions && stats.totalQuestions > 0) {
                         box.classList.add('lesson-complete-perfect');
                     } else {
                         box.classList.add('lesson-complete-imperfect');
                     }
                      // Optionally hide original question count if stats are shown
                      // if(qCountSpan) qCountSpan.style.display = 'none';
                 } else {
                     // No stats for this lesson
                     statsDisplaySpan.textContent = ''; // Ensure it's empty
                     // Ensure q-count is visible if stats aren't
                      if(qCountSpan) qCountSpan.style.display = '';
                 }
             });
         }


        // --- Theme Management ---
        function applyTheme(theme) { /* ... same as before ... */
            document.body.classList.toggle('dark-theme', theme === 'dark');
            const themeRadios = settingsModalElement?.querySelectorAll('input[name="theme"]');
            if(themeRadios) { themeRadios.forEach(radio => { radio.checked = radio.value === theme; }); }
        }
        function handleThemeChange(event) { /* ... same as before ... */
            const newTheme = event.target.value; applyTheme(newTheme); localStorage.setItem(LS_THEME_KEY, newTheme);
        }
        function loadAndApplyTheme() { /* ... same as before ... */
            const savedTheme = localStorage.getItem(LS_THEME_KEY); const currentTheme = savedTheme || 'dark';
            applyTheme(currentTheme); if (!savedTheme) { localStorage.setItem(LS_THEME_KEY, 'dark'); }
        }

        // --- Settings Modal ---
        function toggleSettingsModal(show) { /* ... same as before ... */
            if (!settingsModalElement) return;
            if (show) {
                const currentTheme = localStorage.getItem(LS_THEME_KEY) || 'dark';
                const themeRadios = settingsModalElement.querySelectorAll('input[name="theme"]');
                themeRadios.forEach(radio => { radio.checked = radio.value === currentTheme; });
                settingsModalElement.classList.remove('hidden');
                setTimeout(() => settingsModalElement.classList.add('visible'), 10);
            } else {
                settingsModalElement.classList.remove('visible');
                setTimeout(() => settingsModalElement.classList.add('hidden'), 300);
            }
        }
        function resetSavedData() { // Updated to clear stats
            if (confirm('Are you sure you want to reset ALL saved data?\n\nThis includes:\n- Theme preference\n- Welcome screen status\n- All saved lesson scores and times')) {
                localStorage.removeItem(LS_THEME_KEY);
                localStorage.removeItem(LS_VISITED_KEY);
                localStorage.removeItem(LS_STATS_KEY); // Clear lesson stats
                allLessonStats = {}; // Clear in-memory stats
                alert('Saved data has been reset. The page will now reload.');
                location.reload();
            }
        }

         // --- Welcome Screen Logic ---
         function handleWelcome() { /* ... same as before ... */
             if (!welcomeViewElement || !mainContainerElement) return;
             const hasVisited = localStorage.getItem(LS_VISITED_KEY);
             if (hasVisited) {
                 welcomeViewElement.classList.add('hidden');
                 mainContainerElement.classList.remove('initially-hidden');
                 setTimeout(() => { mainContainerElement.style.opacity = 1; }, 50);
             } else {
                 welcomeViewElement.classList.remove('hidden');
                 mainContainerElement.classList.add('initially-hidden');
                 mainContainerElement.style.opacity = 0;
                 const getStartedBtn = welcomeViewElement.querySelector('.get-started-btn');
                 if (getStartedBtn) {
                     getStartedBtn.addEventListener('click', () => {
                         localStorage.setItem(LS_VISITED_KEY, 'true');
                         welcomeViewElement.classList.add('hidden');
                         mainContainerElement.classList.remove('initially-hidden');
                        setTimeout(() => { mainContainerElement.style.opacity = 1; }, 50);
                     }, { once: true });
                 }
             }
         }


        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            welcomeViewElement = document.getElementById('welcome-view');           mainContainerElement = document.querySelector('.container');
            contentElement = document.getElementById('content');                    quizViewElement = document.getElementById('quiz-view');
            quizTitleElement = document.getElementById('quiz-title');               quizContainerElement = document.getElementById('quiz-container');
            feedbackContainerElement = document.getElementById('feedback-container'); quizButtonsContainerElement = document.getElementById('quiz-buttons-container');
            navSectionElement = document.querySelector('.nav-section');             settingsButtonElement = document.getElementById('settings-btn');
            settingsModalElement = document.getElementById('settings-modal');

            // --- Initial Setup ---
            loadAndApplyTheme();    // Load theme preference
            loadLessonStats();      // Load existing lesson stats
            handleWelcome();        // Handle welcome screen visibility

            // --- Event Listeners ---
            if (settingsButtonElement) { settingsButtonElement.addEventListener('click', () => toggleSettingsModal(true)); }
            if (settingsModalElement) {
                const themeRadios = settingsModalElement.querySelectorAll('input[name="theme"]');
                themeRadios.forEach(radio => radio.addEventListener('change', handleThemeChange));
                const resetBtn = document.getElementById('reset-data-button');
                if(resetBtn) resetBtn.addEventListener('click', resetSavedData);
                 settingsModalElement.addEventListener('click', (event) => { if (event.target === settingsModalElement) toggleSettingsModal(false); });
            }

            // Navigation Listeners
            document.querySelectorAll('.nav-btn[data-subject]').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress will be lost.")) return;
                    showTopicList(); // Will call updateContent which calls updateLessonBoxDisplays
                    document.querySelectorAll('.nav-btn[data-subject]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent(); // Update content view
                });
            });
            document.querySelectorAll('.semester-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress will be lost.")) return;
                    showTopicList(); // Will call updateContent which calls updateLessonBoxDisplays
                    document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent(); // Update content view
                });
            });

             // Topic Click Listener (Event Delegation)
             if (contentElement) {
                 contentElement.addEventListener('click', (event) => {
                     const lessonBox = event.target.closest('.section-content');
                     if (lessonBox) {
                        if (!quizViewElement.classList.contains('hidden')) { if (!confirm("Leave current quiz? Progress will be lost.")) { return; } showTopicList(); }
                         const subject = lessonBox.dataset.subject;
                         const semester = lessonBox.dataset.semester; // Get semester from clicked box
                         const unit = lessonBox.dataset.unit;
                         const lesson = lessonBox.dataset.lesson;
                         handleSectionClick(subject, semester, unit, lesson); // Pass semester
                     }
                 });
             }

            // Resize Listener
            window.addEventListener('resize', debounce(updateAllArrowPositions, 250));

            // Initial content display and stats update (if not on welcome screen)
            if (localStorage.getItem(LS_VISITED_KEY)) {
                 updateContent(); // This will also call updateLessonBoxDisplays
            }
        });

        // --- View Management ---
        function showTopicList() {
            if (contentElement && quizViewElement && navSectionElement && mainContainerElement) {
                mainContainerElement.classList.remove('hidden');
                contentElement.classList.remove('hidden');
                quizViewElement.classList.add('hidden');
                navSectionElement.classList.remove('hidden');
                updateContent(); // Ensure correct list AND update stats display

                // Cleanup Quiz specific things
                if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; }
                if(matchingSvgElement && matchingSvgElement.parentNode) { matchingSvgElement.remove(); matchingSvgElement = null; }
                quizState = { // Reset state
                    currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null,
                    selectedAnswers: [], questions: [], originalQuestions: [], subject: '', unit: '', lesson: '', semester: '',
                    matchingState: { selectedPromptElement: null, userPairs: {} }
                };
                 mainContainerElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        function showQuizView() { /* ... same as before ... */
             if (contentElement && quizViewElement && navSectionElement && mainContainerElement) {
                 mainContainerElement.classList.remove('hidden'); contentElement.classList.add('hidden');
                 quizViewElement.classList.remove('hidden'); navSectionElement.classList.add('hidden');
                 quizViewElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
        }

        // --- Core Functions ---
        function updateContent() { // Updates topic list view AND triggers stat display update
            const activeSubjectBtn = document.querySelector('.nav-btn[data-subject].active');
            const activeSemesterBtn = document.querySelector('.semester-btn.active');
            if (!activeSubjectBtn || !activeSemesterBtn || !contentElement) return;

            const activeSubject = activeSubjectBtn.dataset.subject;
            const activeSemester = activeSemesterBtn.dataset.semester;
            const sanitizedSubject = activeSubject.replace(/\s+/g, '-');

            contentElement.querySelectorAll('.semester-content').forEach(c => c.classList.remove('active'));

            const contentId = `${sanitizedSubject}-${activeSemester}`;
            const semesterContentElement = contentElement.querySelector(`#${contentId}`);

            if (semesterContentElement) {
                semesterContentElement.classList.add('active');
                updateLessonBoxDisplays(); // <--- Update stats display for the now active semester
            } else {
                console.warn(`Semester content ID "#${contentId}" not found.`);
            }
        }


        // Modified to accept and store semester
        function handleSectionClick(subject, semester, unit, lesson) {
             if (!subject || !semester || !unit || !lesson) { alert("Error identifying topic."); return; }
            try {
                showQuizView(); // Ensure quiz view is shown
                const originalQuestions = getQuestions(subject, semester, unit, lesson); // Pass semester
                if (originalQuestions?.length) {
                    startQuiz(subject, semester, unit, lesson, originalQuestions); // Pass semester
                } else { showError(subject, unit, lesson); } // semester not needed for error display message
            } catch (error) { console.error("Section click error:", error); showError(subject, unit, lesson, "Error loading questions."); }
        }

        // Modified to accept and store semester
        function startQuiz(subject, semester, unit, lesson, originalQuestions) {
            const shuffledQuestions = shuffleArray(originalQuestions);
            quizState = {
                currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: shuffledQuestions.length, startTime: new Date(), endTime: null,
                selectedAnswers: new Array(shuffledQuestions.length).fill(null), questions: shuffledQuestions, originalQuestions: originalQuestions,
                subject: subject, unit: unit, lesson: lesson, semester: semester, // Store semester
                matchingState: { selectedPromptElement: null, userPairs: {} }
            };
            if (quizTitleElement) quizTitleElement.textContent = `${lesson}`;
            displayQuestion();
        }

        function displayQuestion() { /* ... (same as before, no changes needed here) ... */
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement) return;
             const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
             if (!currentQuestion) { displayResults(); return; }
             quizContainerElement.innerHTML = ''; feedbackContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             if (matchingSvgElement && matchingSvgElement.parentNode) { matchingSvgElement.remove(); matchingSvgElement = null; }
             if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; }
             const qWrap = document.createElement('div'); qWrap.className = 'question-display-wrapper';
             const pTxt = document.createElement('div'); pTxt.className = 'question-progress'; pTxt.textContent = `Question ${quizState.currentQuestionIndex + 1}/${quizState.totalQuestions}`; qWrap.appendChild(pTxt);
             const qTxt = document.createElement('p'); qTxt.className = 'question-text'; qTxt.innerHTML = `<strong>Q:</strong> ${currentQuestion.question||'?'}`; qWrap.appendChild(qTxt);
             const typeWrap = document.createElement('div'); typeWrap.className = 'question-type-wrapper';
             try {
                  switch (currentQuestion.type) {
                      case "matching": renderMatching(currentQuestion, typeWrap); requestAnimationFrame(setupArrowObserver); break;
                      case "ordering": renderOrdering(currentQuestion, typeWrap); break;
                      case "multiple_choice": default: renderMultipleChoice(currentQuestion, typeWrap); break;
                  }
             } catch (e) { console.error("Render error:", e); typeWrap.innerHTML = `<p style="color:red;">Error displaying question.</p>`; }
             qWrap.appendChild(typeWrap); quizContainerElement.appendChild(qWrap);
             const subBtn = document.createElement('button'); subBtn.className = 'btn submit-btn'; subBtn.id = 'submit-btn'; subBtn.textContent = 'Submit'; subBtn.onclick = checkAnswer;
             const nxtBtn = document.createElement('button'); nxtBtn.className = 'btn next-btn hidden'; nxtBtn.id = 'next-btn'; nxtBtn.textContent = quizState.currentQuestionIndex === quizState.totalQuestions - 1 ? 'View Results' : 'Next Question'; nxtBtn.onclick = nextQuestion;
             quizButtonsContainerElement.append(subBtn, nxtBtn); subBtn.disabled = true;
             if (currentQuestion.type !== 'multiple_choice' && currentQuestion.type !== 'ordering' && currentQuestion.type !== 'matching') { subBtn.disabled = false; }
        }

        // --- Rendering Functions ---
        function renderMultipleChoice(question, container) { /* ... (same as before) ... */
            if (!question.options?.length) { container.textContent = 'Err: Options invalid.'; return; }
            const optionsDiv = document.createElement('div'); optionsDiv.className = 'options-container'; optionsDiv.id = 'options-list';
            question.options.forEach((option, index) => {
                const id = `option-${index}`; const lbl = document.createElement('label'); lbl.className = 'option-label'; lbl.htmlFor = id;
                const inp = document.createElement('input'); inp.type = 'radio'; inp.name = 'question-option'; inp.value = index; inp.id = id; inp.className = 'option-input';
                inp.addEventListener('change', () => { const submitBtn = document.getElementById('submit-btn'); if (submitBtn) submitBtn.disabled = false; });
                const txt = document.createElement('span'); txt.className = 'option-text'; txt.textContent = option; lbl.append(inp, txt); optionsDiv.appendChild(lbl);
            }); container.appendChild(optionsDiv);
        }
        function renderMatching(question, container) { /* ... (same as before) ... */
             if (!question.prompts?.length || !question.matches?.length || question.prompts.length !== question.matches.length) { container.textContent = 'Err: Match data invalid.'; return; }
             quizState.matchingState.userPairs = {}; const instr = document.createElement('p'); instr.className = 'matching-instructions'; instr.textContent = 'Click a left item, then its corresponding right item. Click a matched item again to deselect the pair.'; container.appendChild(instr);
             const outer = document.createElement('div'); outer.style.position = 'relative'; matchingSvgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); matchingSvgElement.id = 'matching-arrow-svg'; matchingSvgElement.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--accent-color)"/></marker></defs>'; outer.appendChild(matchingSvgElement);
             const matchCont = document.createElement('div'); matchCont.className = 'matching-container'; matchCont.id = 'matching-cols';
             const promCol = document.createElement('div'); promCol.className = 'matching-column'; promCol.id = 'prompts-column'; promCol.innerHTML = '<h4>Items</h4>';
             const matCol = document.createElement('div'); matCol.className = 'matching-column'; matCol.id = 'matches-column'; matCol.innerHTML = '<h4>Matches</h4>';
             const shuffledMatches = question.matches.map((text, originalIndex) => ({ text, originalIndex })).sort(() => 0.5 - Math.random());
             question.prompts.forEach((promptText, promptIndex) => { const item = document.createElement('div'); item.className = 'matching-item prompt-item'; item.textContent = promptText; item.dataset.index = promptIndex; item.id = `prompt-${promptIndex}`; item.onclick = handleMatchingClick; promCol.appendChild(item); });
             shuffledMatches.forEach(matchObject => { const item = document.createElement('div'); item.className = 'matching-item match-item'; item.textContent = matchObject.text; item.dataset.index = matchObject.originalIndex; item.id = `match-${matchObject.originalIndex}`; item.onclick = handleMatchingClick; matCol.appendChild(item); });
             matchCont.append(promCol, matCol); outer.appendChild(matchCont); container.appendChild(outer);
        }
        function renderOrdering(question, container) { /* ... (same as before) ... */
            if (!question.items?.length) { container.textContent = 'Err: Ordering data invalid.'; return; }
            const num = question.items.length; const instr = document.createElement('p'); instr.className = 'ordering-instructions'; instr.textContent = `Select the correct order number (1-${num}) for each item.`; container.appendChild(instr);
            const orderCont = document.createElement('div'); orderCont.className = 'ordering-container'; orderCont.id = 'ordering-list';
            const checkAllSelected = () => { const allSelects = orderCont.querySelectorAll('.ordering-select'); const allSelected = Array.from(allSelects).every(s => s.value !== ""); const submitBtn = document.getElementById('submit-btn'); if(submitBtn) submitBtn.disabled = !allSelected; };
            const shuffledItems = question.items.map((text, originalIndex) => ({ text, originalIndex })).sort(() => 0.5 - Math.random());
            shuffledItems.forEach(({ text, originalIndex }) => {
                const div = document.createElement('div'); div.className = 'ordering-item'; div.dataset.originalIndex = originalIndex; const sel = document.createElement('select'); sel.className = 'ordering-select'; sel.dataset.itemIndex = originalIndex;
                const defOpt = document.createElement('option'); defOpt.value = ""; defOpt.textContent = "-"; defOpt.selected = true; defOpt.disabled = true; sel.appendChild(defOpt);
                for (let j = 1; j <= num; j++) { const opt = document.createElement('option'); opt.value = j; opt.textContent = j; sel.appendChild(opt); }
                sel.addEventListener('change', checkAllSelected); const span = document.createElement('span'); span.className = 'ordering-text'; span.textContent = text; div.append(sel, span); orderCont.appendChild(div);
            }); container.appendChild(orderCont);
        }


        // --- Interaction Handlers ---
        function handleMatchingClick(event) { /* ... (same as before) ... */
             const clickedItem = event.target.closest('.matching-item'); if (!clickedItem) return;
             const isPrompt = clickedItem.classList.contains('prompt-item'); const isAlreadyMatched = clickedItem.classList.contains('matched'); const clickedIndex = clickedItem.dataset.index; let selectedPrompt = quizState.matchingState.selectedPromptElement;
             if (isAlreadyMatched) {
                 let promptIndexToClear = -1; let matchIndexToClear = -1;
                 if (isPrompt) { promptIndexToClear = clickedIndex; matchIndexToClear = quizState.matchingState.userPairs[promptIndexToClear]; }
                 else { matchIndexToClear = clickedIndex; promptIndexToClear = Object.keys(quizState.matchingState.userPairs).find(pIdx => quizState.matchingState.userPairs[pIdx] == matchIndexToClear); }
                 if (promptIndexToClear != -1 && matchIndexToClear !== undefined) {
                     const promptElement = document.getElementById(`prompt-${promptIndexToClear}`); const matchElement = document.getElementById(`match-${matchIndexToClear}`);
                     if (promptElement) { promptElement.classList.remove('matched', 'selected'); promptElement.style.cursor = 'pointer'; }
                     if (matchElement) { matchElement.classList.remove('matched'); matchElement.style.cursor = 'pointer'; }
                     delete quizState.matchingState.userPairs[promptIndexToClear]; removeArrow(promptIndexToClear);
                     if (selectedPrompt && selectedPrompt.dataset.index == promptIndexToClear) { quizState.matchingState.selectedPromptElement = null; }
                     const submitBtn = document.getElementById('submit-btn'); if (submitBtn) submitBtn.disabled = true;
                 } return;
             }
             if (isPrompt) {
                 if (clickedItem === selectedPrompt) { clickedItem.classList.remove('selected'); quizState.matchingState.selectedPromptElement = null; }
                 else { if (selectedPrompt) { selectedPrompt.classList.remove('selected'); } clickedItem.classList.add('selected'); quizState.matchingState.selectedPromptElement = clickedItem; }
             } else {
                 if (selectedPrompt) {
                     const promptIndex = selectedPrompt.dataset.index; const matchIndex = clickedIndex; quizState.matchingState.userPairs[promptIndex] = parseInt(matchIndex, 10);
                     selectedPrompt.classList.remove('selected'); selectedPrompt.classList.add('matched'); selectedPrompt.style.cursor = 'pointer'; clickedItem.classList.add('matched'); clickedItem.style.cursor = 'pointer';
                     drawArrow(selectedPrompt, clickedItem, promptIndex); quizState.matchingState.selectedPromptElement = null;
                     const totalPrompts = document.querySelectorAll('.prompt-item').length; const matchedCount = Object.keys(quizState.matchingState.userPairs).length; const submitBtn = document.getElementById('submit-btn');
                     if (submitBtn && totalPrompts > 0 && totalPrompts === matchedCount) { submitBtn.disabled = false; }
                 }
             }
         }


        // --- Arrow Drawing ---
        function drawArrow(promptEl, matchEl, promptIndex) { /* ... (same as before) ... */
            if (!matchingSvgElement || !promptEl || !matchEl) return; const svgRect = matchingSvgElement.getBoundingClientRect(); const scrollX = window.scrollX || window.pageXOffset; const scrollY = window.scrollY || window.pageYOffset;
            const promptRect = promptEl.getBoundingClientRect(); const matchRect = matchEl.getBoundingClientRect();
            const startX = promptRect.right - svgRect.left; const startY = promptRect.top + promptRect.height/2 - svgRect.top; const endX = matchRect.left - svgRect.left; const endY = matchRect.top + matchRect.height/2 - svgRect.top;
            let line = matchingSvgElement.querySelector(`#arrow-${promptIndex}`); if (!line) { line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); line.id = `arrow-${promptIndex}`; matchingSvgElement.appendChild(line); }
            line.setAttribute('x1', startX); line.setAttribute('y1', startY); line.setAttribute('x2', endX); line.setAttribute('y2', endY); line.setAttribute('stroke', 'var(--accent-color)'); line.setAttribute('stroke-width', '2'); line.setAttribute('marker-end', 'url(#arrowhead)'); line.style.opacity = '1';
         }
        function removeArrow(promptIndex) { /* ... (same as before) ... */
            if (!matchingSvgElement) return; const line = matchingSvgElement.querySelector(`#arrow-${promptIndex}`); if (line) { line.style.opacity = '0'; setTimeout(() => line.remove(), 300); }
         }
        function updateAllArrowPositions() { /* ... (same as before) ... */
             if (!matchingSvgElement || !quizState || !quizState.questions[quizState.currentQuestionIndex] || quizState.questions[quizState.currentQuestionIndex].type !== 'matching') return;
             const pairs = quizState.matchingState.userPairs;
             for (const pIdx in pairs) { if (pairs.hasOwnProperty(pIdx)) { const mIdx = pairs[pIdx]; const pEl = document.getElementById(`prompt-${pIdx}`); const mEl = document.getElementById(`match-${mIdx}`); if (pEl && mEl) { drawArrow(pEl, mEl, pIdx); } else { removeArrow(pIdx); } } }
         }
        function setupArrowObserver() { /* ... (same as before) ... */
            const target = document.getElementById('matching-cols'); if (!target || !matchingSvgElement) { console.warn("Cannot setup observer: Target or SVG missing."); return; }
            if (matchingArrowObserver) { matchingArrowObserver.disconnect(); }
            const config = { attributes: true, childList: true, subtree: true, characterData: true }; const callback = debounce(updateAllArrowPositions, 50); matchingArrowObserver = new MutationObserver(callback); matchingArrowObserver.observe(target, config);
            const quizContainerTarget = document.getElementById('quiz-container'); if (quizContainerTarget) { matchingArrowObserver.observe(quizContainerTarget, { attributes: true, subtree: false }); }
            setTimeout(updateAllArrowPositions, 100);
        }


        // --- Answer Checking ---
        function checkAnswer() { /* ... (same as before) ... */
            if (!feedbackContainerElement || !quizButtonsContainerElement) return; if (matchingArrowObserver) { matchingArrowObserver.disconnect(); matchingArrowObserver = null; }
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex]; let result = { isCorrect: false, feedback: '', userResponse: null, scoreIncrement: 0 };
            try { switch (currentQuestion.type) { case "matching": result = checkMatching(currentQuestion); break; case "ordering": result = checkOrdering(currentQuestion); break; case "multiple_choice": default: result = checkMultipleChoice(currentQuestion); break; } }
            catch (error) { console.error("Check answer error:", error); result = { isCorrect: false, feedback: '<div class="incorrect-feedback">Error checking answer.</div>', userResponse: null, scoreIncrement: 0 }; }
            quizState.selectedAnswers[quizState.currentQuestionIndex] = result.userResponse; if (result.scoreIncrement > 0) { quizState.correctAnswers += result.scoreIncrement; }
            feedbackContainerElement.innerHTML = result.feedback; feedbackContainerElement.classList.remove('hidden'); disableInputs();
            const submitBtn = quizButtonsContainerElement.querySelector('#submit-btn'), nextBtn = quizButtonsContainerElement.querySelector('#next-btn');
            if(submitBtn) submitBtn.classList.add('hidden'); if(nextBtn) nextBtn.classList.remove('hidden');
        }
        function checkMultipleChoice(question) { /* ... (same as before) ... */
            const selectedRadio = document.querySelector('input[name="question-option"]:checked'); if(!selectedRadio) { return {isCorrect:false, feedback:'<div class="incorrect-feedback">Please select an answer.</div>', userResponse:null, scoreIncrement:0}; }
            const selectedIndex = parseInt(selectedRadio.value, 10); const correctAnswerText = question.answer; const selectedAnswerText = question.options?.[selectedIndex]; const isCorrect = selectedAnswerText === correctAnswerText;
            document.querySelectorAll('.option-label').forEach((label, index) => { const input = label.querySelector('input'); if(question.options?.[index] === correctAnswerText) { label.classList.add('correct-option'); } if(input && input.checked && !isCorrect) { label.classList.add('incorrect-option'); } });
            const feedbackHTML = isCorrect ? '<div class="correct-feedback">Correct! ✓</div>' : `<div class="incorrect-feedback">Incorrect. <span>Correct answer: ${correctAnswerText || 'N/A'}</span></div>`;
            return {isCorrect: isCorrect, feedback: feedbackHTML, userResponse: selectedIndex, scoreIncrement: isCorrect ? 1 : 0};
        }
        function checkMatching(question) { /* ... (same as before) ... */
             const userPairs = quizState.matchingState.userPairs; const correctPairs = question.answer || {}; const totalCorrectPairs = Object.keys(correctPairs).length; let correctlyMatchedCount = 0;
             if (totalCorrectPairs === 0) { return {isCorrect: true, feedback: '<div class="correct-feedback">No matching required.</div>', userResponse: userPairs, scoreIncrement: 0}; }
             for (const promptIndex in correctPairs) { if (userPairs.hasOwnProperty(promptIndex) && userPairs[promptIndex] === correctPairs[promptIndex]) { correctlyMatchedCount++; } }
             const isFullyCorrect = correctlyMatchedCount === totalCorrectPairs && Object.keys(userPairs).length === totalCorrectPairs; const isPartiallyCorrect = correctlyMatchedCount > 0 && !isFullyCorrect;
             let feedbackHTML = ""; if (isFullyCorrect) { feedbackHTML = `<div class="correct-feedback">Correct! ✓ All pairs matched.</div>`; } else if (isPartiallyCorrect) { feedbackHTML = `<div class="partial-feedback">Partially Correct. Matched ${correctlyMatchedCount}/${totalCorrectPairs}.</div>`; } else { feedbackHTML = `<div class="incorrect-feedback">Incorrect. Matched 0/${totalCorrectPairs}.</div>`; }
             for (const promptIndex in userPairs) {
                 const userMatchIndex = userPairs[promptIndex]; const correctMatchIndex = correctPairs[promptIndex]; const line = matchingSvgElement?.querySelector(`#arrow-${promptIndex}`); const promptEl = document.getElementById(`prompt-${promptIndex}`); const userMatchEl = document.getElementById(`match-${userMatchIndex}`);
                 if (userMatchIndex === correctMatchIndex) { if(line) line.style.stroke = 'var(--correct-border)'; if(promptEl) promptEl.style.borderColor = 'var(--correct-border)'; if(userMatchEl) userMatchEl.style.borderColor = 'var(--correct-border)'; }
                 else { if(line) line.style.stroke = 'var(--incorrect-border)'; if(promptEl) promptEl.style.borderColor = 'var(--incorrect-border)'; if(userMatchEl) userMatchEl.style.borderColor = 'var(--incorrect-border)'; }
             }
             return { isCorrect: isFullyCorrect, feedback: feedbackHTML, userResponse: userPairs, scoreIncrement: isFullyCorrect ? 1 : 0 };
        }
        function checkOrdering(question) { /* ... (same as before) ... */
            const originalItems = question.items || []; const correctAnswerOrder = question.answer || []; const numItems = originalItems.length;
            if(numItems === 0 || !Array.isArray(correctAnswerOrder) || numItems !== correctAnswerOrder.length) { console.error("Invalid ordering data:", question); return {isCorrect:false, feedback:'<div class="incorrect-feedback">Error: Invalid question setup.</div>', userResponse:null, scoreIncrement:0}; }
            const userOrderMap = {}; const selectedPositions = new Set(); let allSelected = true; let hasDuplicates = false; const selectElements = document.querySelectorAll("#ordering-list .ordering-select");
            if(selectElements.length !== numItems) { console.error("Ordering Error: Select element count mismatch."); return {isCorrect:false, feedback:'<div class="incorrect-feedback">Error processing selections.</div>', userResponse:null, scoreIncrement:0}; }
            selectElements.forEach(select => {
                const itemIndex = parseInt(select.dataset.itemIndex, 10); const selectedValue = select.value; if (selectedValue === "") { allSelected = false; } else { const position = parseInt(selectedValue, 10); if (isNaN(position) || position < 1 || position > numItems) { allSelected = false; return; } userOrderMap[itemIndex] = position; if (selectedPositions.has(position)) { hasDuplicates = true; } selectedPositions.add(position); } });
            if (!allSelected) { return {isCorrect:false, feedback:'<div class="incorrect-feedback">Please select order for all items.</div>', userResponse: userOrderMap, scoreIncrement:0}; }
            if (hasDuplicates || selectedPositions.size !== numItems) { const numTxt = numItems > 1 ? `numbers 1-${numItems}` : 'number 1'; return {isCorrect:false, feedback:`<div class="incorrect-feedback">Please use each order ${numTxt} once.</div>`, userResponse: userOrderMap, scoreIncrement:0}; }
            const userOrderedItems = new Array(numItems).fill(null); let constructionOk = true;
            for (const itemIndexStr in userOrderMap) { if (userOrderMap.hasOwnProperty(itemIndexStr)) { const itemIndex = parseInt(itemIndexStr, 10); const itemText = originalItems[itemIndex]; const userPosition = userOrderMap[itemIndex] - 1; if (itemText === undefined || userPosition < 0 || userPosition >= numItems || userOrderedItems[userPosition] !== null) { constructionOk = false; break; } userOrderedItems[userPosition] = itemText; } }
            if (!constructionOk || userOrderedItems.some(item => item === null)) { console.error("Ordering Error: Construction fail.", userOrderMap, userOrderedItems); return {isCorrect:false, feedback:'<div class="incorrect-feedback">Error processing sequence.</div>', userResponse: userOrderedItems, scoreIncrement:0}; }
            const isCorrect = JSON.stringify(userOrderedItems) === JSON.stringify(correctAnswerOrder);
            const feedbackHTML = isCorrect ? '<div class="correct-feedback">Correct! ✓</div>' : `<div class="incorrect-feedback">Incorrect. <span>Correct order: ${correctAnswerOrder.join(" → ")}</span></div>`;
            selectElements.forEach(select => { const itemIndex = parseInt(select.dataset.itemIndex, 10); const itemText = originalItems[itemIndex]; const userSelectedPosition = userOrderMap[itemIndex]; const correctPosition = correctAnswerOrder.indexOf(itemText) + 1; if (userSelectedPosition === correctPosition) { select.style.borderColor = "var(--correct-border)"; select.style.backgroundColor = "var(--correct-bg)"; } else { select.style.borderColor = "var(--incorrect-border)"; select.style.backgroundColor = "var(--incorrect-bg)"; } select.style.borderWidth = "2px"; });
            return { isCorrect: isCorrect, feedback: feedbackHTML, userResponse: userOrderedItems, scoreIncrement: isCorrect ? 1 : 0 };
        }
        function disableInputs() { /* ... (same as before) ... */
             document.querySelectorAll('input[name="question-option"], .ordering-select').forEach(i => i.disabled = true); document.querySelectorAll('.option-label').forEach(l => l.style.cursor = 'default');
             document.querySelectorAll('.matching-item').forEach(i => { i.style.pointerEvents = 'none'; i.style.cursor = 'default'; });
         }


        // --- Navigation and Results ---
        function nextQuestion() { /* ... (same as before) ... */
            quizState.currentQuestionIndex++; if (quizState.currentQuestionIndex < quizState.totalQuestions) { displayQuestion(); } else { quizState.endTime = new Date(); displayResults(); }
        }
        function displayResults() { // Updated to save stats
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;

             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             quizTitleElement.textContent = 'Quiz Results';

             const timeTakenSeconds = quizState.endTime && quizState.startTime ? Math.round((quizState.endTime - quizState.startTime) / 1000) : 0;
             const timeString = formatTime(timeTakenSeconds);
             const score = quizState.totalQuestions > 0 ? (quizState.correctAnswers / quizState.totalQuestions) * 100 : 0;
             const scoreRounded = score.toFixed(0);

             // --- Save Stats ---
             if (quizState.totalQuestions > 0) {
                 saveLessonStats(
                     quizState.subject, quizState.semester, quizState.unit, quizState.lesson,
                     quizState.correctAnswers, quizState.totalQuestions, timeTakenSeconds
                 );
             }
             // --- End Save Stats ---

             let resultMessage = ''; if (quizState.totalQuestions === 0) { resultMessage = 'No questions.'; } else if (score >= 90) { resultMessage = 'Excellent! 🎉'; } else if (score >= 70) { resultMessage = 'Great Job! 👍'; } else if (score >= 50) { resultMessage = 'Good Effort! 💪'; } else { resultMessage = 'Keep Practicing! 📚'; }

             const resultsDiv = document.createElement('div'); resultsDiv.className = 'results-container';
             resultsDiv.innerHTML = `
                <h2 class="results-header">${resultMessage}</h2>
                <div class="results-score"><div class="score-circle"><span class="score-number">${scoreRounded}</span><span class="score-percent-sign">%</span></div></div>
                <div class="results-details">
                    <p><span class="detail-icon">📚</span><strong>Subject:</strong> <span class="detail-value">${quizState.subject || 'N/A'}</span></p>
                    <p><span class="detail-icon">🗓️</span><strong>Semester:</strong> <span class="detail-value">${quizState.semester || 'N/A'}</span></p>
                    <p><span class="detail-icon">🔖</span><strong>Unit:</strong> <span class="detail-value">${quizState.unit || 'N/A'}</span></p>
                    <p><span class="detail-icon">📖</span><strong>Lesson:</strong> <span class="detail-value">${quizState.lesson || 'N/A'}</span></p>
                    <p><span class="detail-icon">✅</span><strong>Correct:</strong> <span class="detail-value">${quizState.correctAnswers} / ${quizState.totalQuestions}</span></p>
                    <p><span class="detail-icon">⏱️</span><strong>Time:</strong> <span class="detail-value">${timeString}</span></p>
                </div>`;
             quizContainerElement.appendChild(resultsDiv);

             // --- Results Buttons ---
             const actionsDiv = document.createElement('div'); actionsDiv.className = 'results-actions quiz-buttons';
             const redoBtn = document.createElement('button'); redoBtn.className = 'btn redo-btn'; redoBtn.innerHTML = '🔄 Redo Quiz';
             redoBtn.onclick = () => { startQuiz(quizState.subject, quizState.semester, quizState.unit, quizState.lesson, quizState.originalQuestions); };
             actionsDiv.appendChild(redoBtn);
             if (quizState.totalQuestions > 0) { const reviewBtn = document.createElement('button'); reviewBtn.id = 'review-btn'; reviewBtn.className = 'btn review-btn'; reviewBtn.innerHTML = '🧐 Review Answers'; reviewBtn.onclick = reviewAnswers; actionsDiv.appendChild(reviewBtn); }
             const backTopicsBtn = document.createElement('button'); backTopicsBtn.className = 'btn back-to-topics-btn'; backTopicsBtn.innerHTML = '⬅️ Back to Topics'; backTopicsBtn.onclick = showTopicList; actionsDiv.appendChild(backTopicsBtn);
             quizButtonsContainerElement.appendChild(actionsDiv);
         }

        // --- Answer Review ---
        function reviewAnswers() { /* ... (same as before) ... */
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;
             quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = ''; quizTitleElement.textContent = `Review: ${quizState.lesson}`;
             const reviewDiv = document.createElement('div'); reviewDiv.className = 'review-container';
             quizState.questions.forEach((q, i) => {
                 const box = document.createElement('div'); const userAns = quizState.selectedAnswers[i]; let { correctnessClass, statusText } = calculateReviewStatus(q, userAns); box.className = `question-review ${correctnessClass}`;
                 const qTypeDisplay = (q.type || 'multiple_choice').replace('_',' ');
                 box.innerHTML = `<div class="review-question-header"><span class="review-question-number">Question ${i + 1} (${qTypeDisplay})</span><span class="review-status">${statusText}</span></div><p class="review-question-text">${q.question||'?'}</p><div class="review-answer-content" id="review-answer-content-${i}"></div>`; reviewDiv.appendChild(box);
                 const contentArea = box.querySelector(`#review-answer-content-${i}`);
                 if (contentArea) { try { switch(q.type){ case "matching": reviewMatchingReview(q, userAns, contentArea); break; case "ordering": reviewOrderingReview(q, userAns, contentArea); break; case "multiple_choice": default: reviewMultipleChoiceReview(q, userAns, contentArea); break; } } catch(e){ console.error("Review render error:", e); contentArea.innerHTML = `<p style="color:red;">Error displaying review.</p>`; } } else { console.warn(`No content area for review index ${i}`); }
             });
             quizContainerElement.appendChild(reviewDiv);
             const actionsDiv = document.createElement('div'); actionsDiv.className = 'review-actions quiz-buttons';
             const backResultsBtn = document.createElement('button'); backResultsBtn.className = 'btn back-btn'; backResultsBtn.textContent = '← Back to Results'; backResultsBtn.onclick = displayResults; actionsDiv.appendChild(backResultsBtn);
             const backTopicsBtn = document.createElement('button'); backTopicsBtn.className = 'btn back-to-topics-btn'; backTopicsBtn.innerHTML = '⬅️ Back to Topics'; backTopicsBtn.onclick = showTopicList; actionsDiv.appendChild(backTopicsBtn);
             quizButtonsContainerElement.appendChild(actionsDiv); quizContainerElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
         }
        function calculateReviewStatus(question, userAnswer) { /* ... (same as before) ... */
            let correctnessClass = 'incorrect', statusText = '✗ Incorrect', isCorrect = false, isPartial = false; try { switch (question.type) { case "matching": const correctPairs = question.answer || {}; const totalCorrectPairs = Object.keys(correctPairs).length; let correctlyMatchedCount = 0; if (totalCorrectPairs > 0 && userAnswer && typeof userAnswer === 'object') { for (const pIdx in correctPairs) { if (userAnswer.hasOwnProperty(pIdx) && userAnswer[pIdx] === correctPairs[pIdx]) { correctlyMatchedCount++; } } } isCorrect = totalCorrectPairs > 0 && correctlyMatchedCount === totalCorrectPairs && Object.keys(userAnswer || {}).length === totalCorrectPairs; isPartial = totalCorrectPairs > 0 && correctlyMatchedCount > 0 && !isCorrect; if (isCorrect) { correctnessClass = "correct"; statusText = "✓ Correct"; } else if (isPartial) { correctnessClass = "partial"; statusText = `~ Partial (${correctlyMatchedCount}/${totalCorrectPairs})`; } break; case "ordering": if (userAnswer && Array.isArray(userAnswer) && question.answer && Array.isArray(question.answer)) { isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.answer); } if (userAnswer === null || !Array.isArray(userAnswer)) { statusText = ' अधूरा'; correctnessClass = 'incorrect'; } else if (isCorrect) { correctnessClass = "correct"; statusText = "✓ Correct"; } break; case "multiple_choice": default: if (userAnswer !== null && question.options && question.answer) { isCorrect = question.options[userAnswer] === question.answer; } if (userAnswer === null) { statusText = 'अनुत्तरित'; correctnessClass = 'incorrect'; } else if (isCorrect) { correctnessClass = "correct"; statusText = "✓ Correct"; } break; } } catch (e) { console.error("CalculateReviewStatus Error:", e); correctnessClass = 'incorrect'; statusText = 'Error'; } return { correctnessClass, statusText };
         }
        function reviewMultipleChoiceReview(question, userAnswerIndex, container) { /* ... (same as before) ... */
            const div = document.createElement("div"); div.className = "review-mc-answer"; const userSelectedText = (userAnswerIndex !== null && question.options?.[userAnswerIndex] !== undefined) ? question.options[userAnswerIndex] : "No answer selected"; const isCorrect = (userAnswerIndex !== null && userSelectedText === question.answer); let userAnswerHTML = `<span class="user-answer-text`; if (userAnswerIndex === null) { userAnswerHTML += `">`; } else if (isCorrect) { userAnswerHTML += ` correct">`; } else { userAnswerHTML += ` incorrect">`; } userAnswerHTML += `${userSelectedText}</span>`; div.innerHTML = `<p><strong>Your answer:</strong> ${userAnswerHTML}</p>`; if (!isCorrect) { div.innerHTML += `<p><strong>Correct answer:</strong> <span class="correct-answer-text">${question.answer || "N/A"}</span></p>`; } container.appendChild(div);
         }
        function reviewMatchingReview(question, userPairs, container) { /* ... (same as before) ... */
             const div=document.createElement("div");div.className="review-matching-answer"; div.innerHTML="<p><strong>Matching Review:</strong> (Your Match vs Correct)</p>"; const grid=document.createElement("div");grid.className="review-matching-grid"; const pCol=document.createElement("div"); pCol.className="review-matching-column"; const mCol=document.createElement("div"); mCol.className="review-matching-column"; const correctPairs=question.answer||{}; const prompts = question.prompts || []; const matches = question.matches || [];
             prompts.forEach((promptText, promptIndex) => { const userMatchIndex = userPairs ? userPairs[promptIndex] : null; const correctMatchIndex = correctPairs[promptIndex]; const isPairCorrect = (userMatchIndex !== null && userMatchIndex === correctMatchIndex); const pDiv = document.createElement("div"); pDiv.textContent = `${promptIndex + 1}. ${promptText}`; const mDiv = document.createElement("div"); const userMatchText = (userMatchIndex !== null && matches[userMatchIndex] !== undefined) ? matches[userMatchIndex] : "(No match)"; const correctMatchText = (correctMatchIndex !== undefined && matches[correctMatchIndex] !== undefined) ? matches[correctMatchIndex] : "(N/A)";
                 if (isPairCorrect) { pDiv.className = "review-matched-pair-correct"; mDiv.textContent = correctMatchText; mDiv.className = "review-matched-pair-correct"; } else { pDiv.className = "review-matched-pair-incorrect"; mDiv.innerHTML = `<span style="text-decoration: line-through;">${userMatchText}</span> <span style="font-weight:500;">(${correctMatchText})</span>`; mDiv.className = "review-matched-pair-incorrect"; } pCol.appendChild(pDiv); mCol.appendChild(mDiv); });
             grid.append(pCol, mCol); div.appendChild(grid); container.appendChild(div);
         }
        function reviewOrderingReview(question, userOrderedItems, container) { /* ... (same as before) ... */
             const div = document.createElement("div"); div.className = "review-ordering-answer"; const correctOrder = question.answer || []; const isFullyCorrect = userOrderedItems && JSON.stringify(userOrderedItems) === JSON.stringify(correctOrder); div.innerHTML = `<p><strong>Ordering Review:</strong></p>`; const list = document.createElement("div"); list.className = "review-ordering-list";
             correctOrder.forEach((correctItemText, correctIndex) => { const itemDiv = document.createElement("div"); itemDiv.className = "review-ordering-list-item"; const userIndex = userOrderedItems ? userOrderedItems.indexOf(correctItemText) : -1; const userPosition = (userIndex !== -1) ? userIndex + 1 : null; const correctPosition = correctIndex + 1; let numberSpanHTML = '';
                 if (userPosition === correctPosition) { numberSpanHTML = `<span class="review-order-number review-order-correct">${correctPosition}.</span>`; itemDiv.style.backgroundColor = 'var(--correct-bg)'; } else if (userPosition !== null) { numberSpanHTML = `<span class="review-order-number review-order-incorrect">${userPosition}.</span> <span class="review-order-number review-order-correct">(${correctPosition}.)</span>`; itemDiv.style.backgroundColor = 'var(--incorrect-bg)'; } else { numberSpanHTML = `<span class="review-order-number review-order-incorrect">(NP)</span> <span class="review-order-number review-order-correct">(${correctPosition}.)</span>`; itemDiv.style.backgroundColor = 'var(--partial-bg)'; } itemDiv.innerHTML = `${numberSpanHTML} ${correctItemText}`; list.appendChild(itemDiv); });
             div.appendChild(list); container.appendChild(div);
         }


        // --- Error Display ---
        function showError(subject, unit, lesson, message = '') { /* ... (same as before) ... */
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return; showQuizView(); quizTitleElement.textContent = 'Error'; quizContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = '';
             const defaultMsg = `Sorry, no questions are currently available for "${lesson}" in the "${unit}" unit.`; const displayMsg = message || defaultMsg; const errDiv = document.createElement('div'); errDiv.className = 'error-display'; errDiv.innerHTML = `<div class="error-message">${displayMsg}</div>`;
             const backBtn = document.createElement('button'); backBtn.className = 'btn back-to-topics-btn'; backBtn.innerHTML = '⬅️ Back to Topics'; backBtn.onclick = showTopicList; errDiv.appendChild(backBtn); quizContainerElement.appendChild(errDiv);
        }

        // --- Get Questions Data ---
        // Modified to accept semester
        function getQuestions(subject, semester, unitTitle, lessonTitle) {
             if (!subject || !semester || !unitTitle || !lessonTitle) { console.error("Missing parameters for getQuestions:", { subject, semester, unitTitle, lessonTitle }); return []; }
             try {
                 const semesterData = topicsData[subject]?.[semester]; if (!semesterData?.units) { console.warn(`Data structure error: Units missing for ${subject} -> ${semester}`); return []; }
                 const unit = semesterData.units.find(u => u?.title === unitTitle); if (!unit?.lessons) { console.warn(`Unit "${unitTitle}" or lessons missing in ${subject} -> ${semester}.`); return []; }
                 const lesson = unit.lessons.find(l => l?.title === lessonTitle); if (!lesson) { console.warn(`Lesson "${lessonTitle}" missing in unit "${unitTitle}".`); return []; }
                 if (Array.isArray(lesson.questions) && lesson.questions.length > 0) { return lesson.questions.map(q => ({ ...(q.type ? {} : { type: 'multiple_choice' }), ...q })); }
                 else { console.log(`No questions found for lesson "${lessonTitle}".`); return []; }
             } catch (e) { console.error("Error accessing question data:", e); return []; }
         }

        // --- END OF questions.js ---
    </script>

</body>
</html>
