<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Question Bank</title>
    <style>
        /* --- START OF styles.css --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc; /* Light background for body */
            color: #1e293b; /* Default text color */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff; /* White background for main container */
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .header {
            text-align: left;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
            color: #0f172a; /* Darker heading */
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .subjects {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px;
        }

        .secondary-nav {
            display: flex;
            gap: 10px;
            padding-left: 0; /* No indent needed now */
            align-items: center;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            color: #334155;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
            border-color: #cbd5e1;
        }

        .nav-btn.active {
            background-color: #0f172a;
            color: white;
            border-color: #0f172a; /* Match border */
        }
        .nav-btn.active span { /* Adjust icon color on active */
             filter: brightness(0) invert(1);
        }


        .semester-toggle {
            display: flex;
            gap: 5px;
            background-color: #f1f5f9;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .semester-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: none;
            color: #334155; /* Default color */
            transition: all 0.2s ease;
        }

        .semester-btn.active {
            background-color: #ffffff;
            color: #0f172a; /* Active color */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- Topic List Styles (#content) --- */
        #content {
            /* Styles for when the topic list is visible */
        }

        .unit-container { /* Container for semester title AND units */
             margin-bottom: 20px;
        }
        #content > .semester-content > .unit-container:last-child { /* Last unit block in semester */
             /* This rule might be redundant now, sections handle spacing */
        }

        .unit-title { /* Title for the Semester (e.g., "First Semester") */
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e293b;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
             /* Put semester title in its own container if needed, or style directly */
             /* background-color: #f8fafc; padding: 15px 25px; border-radius: 12px; border: 1px solid #e2e8f0; */
        }

        .section { /* Represents a Unit Box */
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            margin-bottom: 20px; /* Space between units */
        }
         /* Remove bottom margin from the last unit section in the list */
        .semester-content > .section:last-of-type {
             margin-bottom: 0;
         }


        .section-title { /* Represents the Unit Title inside the Unit Box */
            font-size: 17px; /* Unit title size */
            font-weight: 600;
            margin-bottom: 15px;
            color: #334155;
        }

        /* .section-content represents a clickable Lesson Box inside a Unit Box */
        .section-content {
            padding: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            font-size: 15px;
            color: #334155;
            display: block;
            text-align: left;
        }
        .section-content:last-child { /* Last lesson box in a unit */
            margin-bottom: 0;
        }

        .section-content:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
            transform: translateY(-1px);
        }

        .semester-content {
            display: none;
        }
        .semester-content.active {
            display: block;
        }

        /* --- Quiz View Styles (#quiz-view) --- */
        #quiz-view {
             padding: 20px 0;
        }

        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        #quiz-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        #quiz-container {
            margin-bottom: 20px;
        }

        .question-type-wrapper {
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #ffffff;
            margin-bottom: 20px;
             box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .question-progress {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 15px;
            text-align: right;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 25px;
            line-height: 1.6;
            color: #1e293b;
        }
        .question-text strong {
            font-weight: 600;
            margin-right: 5px;
        }

        /* --- MC Specific --- */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 0; }
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; background-color: #fff; }
        .option-label:hover { background-color: #f1f5f9; border-color: #cbd5e1; }
        .option-label input:checked + .option-text { font-weight: 500; }
        .option-label input:checked { accent-color: #2563eb; }
        .option-input { margin-right: 15px; flex-shrink: 0; }
        .option-text { flex-grow: 1; font-size: 16px; color: #334155; }

        /* --- Matching Specific --- */
        .matching-instructions { font-size: 15px; color: #475569; margin-bottom: 20px; }
        .matching-container { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px; margin-bottom: 0; }
        .matching-column { flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 10px; }
        .matching-column h4 { margin: 0 0 10px 0; font-size: 15px; font-weight: 600; color: #4a5568; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .matching-item { padding: 10px 15px; border: 1px solid #cbd5e1; background-color: #fff; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 15px; }
        .matching-item:hover { background-color: #f1f5f9; border-color: #94a3b8; }
        .matching-item.selected { background-color: #dbeafe; border-color: #60a5fa; font-weight: 500; }
        .matching-item.matched { background-color: #e5e7eb; border-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        .review-matched-pair-correct { background-color: #dcfce7 !important; border-color: #16a34a !important; }
        .review-matched-pair-incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }

        /* --- Ordering Specific --- */
        .ordering-instructions { font-size: 15px; color: #475569; margin-bottom: 20px; }
        .ordering-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 0; }
        .ordering-item { display: flex; align-items: center; padding: 10px 15px; border: 1px solid #e2e8f0; background-color: #fff; border-radius: 6px; }
        .ordering-select { margin-right: 15px; padding: 5px 8px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 14px; min-width: 60px; }
        .ordering-text { flex-grow: 1; font-size: 16px; }
        .review-order-number { font-weight: 600; min-width: 25px; text-align: right; margin-right: 10px; }
        .review-order-correct { color: #059669; }
        .review-order-incorrect { color: #dc2626; text-decoration: line-through; margin-right: 5px;}

        /* --- Feedback & Buttons --- */
        #feedback-container { padding: 15px; margin-top: 20px; border-radius: 6px; background-color: #f1f5f9; border: 1px solid #e2e8f0; }
        #feedback-container.hidden { display: none; }
        .correct-feedback { color: #059669; font-weight: 600; font-size: 16px; }
        .incorrect-feedback { color: #dc2626; font-weight: 600; font-size: 16px; }
        .incorrect-feedback span { display: block; font-weight: 500; margin-top: 8px; font-size: 15px; color: #475569; line-height: 1.5; }
        .partial-feedback { color: #ca8a04; font-weight: 600; font-size: 16px; }

        /* Highlighting */
        .correct-option { background-color: #dcfce7 !important; border-color: #16a34a !important; }
        .correct-option .option-text { color: #065f46 !important; }
        .incorrect-option { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .incorrect-option .option-text { color: #b91c1c !important; }

        /* Button container */
        #quiz-buttons-container { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        .results-actions, .review-actions { justify-content: space-between; }
        .results-actions .back-to-topics-btn { margin-left: auto; }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s ease; line-height: 1.5; }
        .submit-btn { background-color: #2563eb; color: white; }
        .submit-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        .submit-btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .next-btn { background-color: #059669; color: white; }
        .next-btn:hover { background-color: #047857; }
        .review-btn { background-color: #16a34a; color: white; }
        .review-btn:hover { background-color: #15803d; }
        .close-btn, .back-to-topics-btn { background-color: #64748b; color: white; }
        .close-btn:hover, .back-to-topics-btn:hover { background-color: #475569; }
        .back-btn { background-color: #64748b; color: white; }
        .back-btn:hover { background-color: #475569; }

        .hidden { display: none !important; }

        /* --- Error Message Styles --- */
        .error-display { padding: 30px; text-align: center; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; }
        .error-message { color: #b91c1c; font-weight: 500; margin-bottom: 20px; }

        /* --- Results Styles --- */
        .results-container { padding: 10px 0; text-align: center; }
        .results-header { font-size: 24px; margin-bottom: 25px; color: #1e293b; }
        .results-score { margin: 30px 0 35px 0; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; background-color: #f1f5f9; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; border: 6px solid #2563eb; box-shadow: 0 0 15px rgba(37, 99, 235, 0.2); }
        .score-number { font-size: 40px; font-weight: bold; color: #1e293b; line-height: 1; }
        .score-percent-sign { font-size: 18px; font-weight: 500; color: #475569; margin-top: 2px; }
        .results-details { max-width: 450px; margin: 0 auto 35px auto; text-align: left; background-color: #f8fafc; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .results-details p { margin: 10px 0; font-size: 15px; color: #334155; }
        .results-details p strong { color: #1e293b; min-width: 120px; display: inline-block; }

        /* --- Review Answers Styles --- */
        .review-container { padding: 10px 0; }
        .question-review { padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e2e8f0; border-left-width: 5px; background-color: #fff; }
        .question-review.correct { border-left-color: #16a34a; }
        .question-review.incorrect { border-left-color: #ef4444; }
        .question-review.partial { border-left-color: #f59e0b; }
        .review-question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; }
        .review-question-number { font-weight: 600; color: #1e293b; font-size: 16px; }
        .review-status { font-weight: 600; font-size: 14px; padding: 3px 8px; border-radius: 4px; text-align: center; }
        .question-review.correct .review-status { color: #065f46; background-color: #dcfce7; }
        .question-review.incorrect .review-status { color: #991b1b; background-color: #fee2e2; }
        .question-review.partial .review-status { color: #854d0e; background-color: #fef9c3; }
        .review-question-text { margin-bottom: 15px; font-size: 16px; color: #334155; }

        /* Review specific content */
        .review-mc-answer, .review-matching-answer, .review-ordering-answer { background-color: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; margin-top: 15px; }
        .review-mc-answer p, .review-matching-answer p, .review-ordering-answer p { margin: 8px 0; font-size: 15px; color: #475569; }
        .review-mc-answer p strong, .review-matching-answer p strong, .review-ordering-answer p strong { color: #1e293b; margin-right: 5px; display: inline-block; min-width: 110px; }
        .review-mc-answer .correct-answer-text, .review-matching-answer .correct-answer-text, .review-ordering-answer .correct-answer-text { color: #059669; font-weight: 500; }
        .review-mc-answer .user-answer-text.incorrect { color: #dc2626; text-decoration: line-through; }
        .review-mc-answer .user-answer-text.correct { color: #059669; font-weight: 500; }

        /* Review Matching */
        .review-matching-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .review-matching-column { flex: 1; min-width: 200px;}
        .review-matching-column div { padding: 5px 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #e2e8f0; background-color: #fff; }

        /* Review Ordering */
        .review-ordering-list { margin-top: 10px; }
        .review-ordering-list-item { display: flex; align-items: center; margin-bottom: 5px; padding: 5px 8px; border-radius: 4px; border: 1px solid #e2e8f0; background-color: #fff; }

        /* --- END OF styles.css --- */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Interactive Question Bank</h1>
        </div>

        <!-- Navigation -->
        <div class="nav-section">
            <div class="subjects">
                <button class="nav-btn" data-subject="اللغة العربية"><span>📚</span> اللغة العربية</button>
                <button class="nav-btn active" data-subject="english"><span>🌎</span> English</button>
                <button class="nav-btn" data-subject="التاريخ"><span>📜</span> التاريخ</button>
                <button class="nav-btn" data-subject="دين"><span>📖</span> دين</button>
            </div>
            <div class="secondary-nav">
                <div class="semester-toggle">
                    <button class="semester-btn active" data-semester="first">First Semester</button>
                    <button class="semester-btn" data-semester="second">Second Semester</button>
                </div>
            </div>
        </div>

        <!-- Content Area for Topic Lists -->
        <div id="content">
            <!-- Topic lists loaded by JS -->
        </div>

        <!-- Quiz View Area (Initially Hidden) -->
        <div id="quiz-view" class="hidden">
            <div id="quiz-header">
                <h2 id="quiz-title">Quiz Title</h2>
                <button class="btn back-to-topics-btn" onclick="showTopicList()">← Back to Topics</button>
            </div>
            <div id="quiz-container">
                 <!-- Quiz Question/Results/Review content loads here -->
            </div>
             <div id="feedback-container" class="feedback-container hidden">
                 <!-- Feedback messages load here -->
             </div>
             <div id="quiz-buttons-container" class="quiz-buttons">
                 <!-- Submit/Next/Review/Back buttons load here -->
            </div>
        </div>

    </div> <!-- End of .container -->

    <script>
        // --- START OF topics.js ---

        // FULL Topics data structure - RESTORED PLACEHOLDERS
        const topicsData = {
            "english": {
                "first": {
                    "title": "First Semester",
                    "units": [
                        {
                            "title": "Unit 1", // Unit Title
                            "lessons": [ // Lessons within the unit
                                {
                                    "title": "Vocabulary & Grammar Basics", // Lesson Title
                                    "questions": [
                                        { "type": "multiple_choice", "question": "Device in 'curtain of night fell'?", "options": ["Simile", "Metaphor", "Alliteration", "Hyperbole"], "answer": "Metaphor" },
                                        { "type": "multiple_choice", "question": "'Ambiguous' means:", "options": ["Clear", "Uncertain", "Definite", "Determined"], "answer": "Uncertain" },
                                        { "type": "ordering", "question": "Order alphabetically:", "items": ["Banana", "Apple", "Cherry", "Date", "Fig"], "answer": ["Apple", "Banana", "Cherry", "Date", "Fig"] },
                                        { "type": "matching", "question": "Match country and capital:", "prompts": ["France", "Japan", "Egypt", "Brazil", "Canada"], "matches": ["Cairo", "Tokyo", "Paris", "Brasília", "Ottawa"], "answer": { "0": 2, "1": 1, "2": 0, "3": 3, "4": 4 } },
                                        { "type": "ordering", "question": "Order tea steps:", "items": ["Add tea bag", "Boil water", "Pour water"], "answer": ["Boil water", "Add tea bag", "Pour water"] }
                                    ]
                                },
                                {
                                    "title": "Past & Present Tenses & Question Tags",
                                    "questions": [
                                        { "type": "multiple_choice", "question": "Correct tense: 'She ___ school.'", "options": ["go", "goes", "going", "went"], "answer": "goes" },
                                        { "type": "multiple_choice", "question": "Correct tag: 'You're coming, ___?'", "options": ["aren't you", "don't you", "isn't you", "won't you"], "answer": "aren't you" }
                                    ]
                                }
                            ]
                        },
                        {
                            "title": "Unit 2",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Future Forms", "questions": [] }
                            ]
                        },
                        {
                            "title": "Unit 3",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Habits & Clauses", "questions": [] }
                            ]
                        },
                        {
                            "title": "Unit 4",
                            "lessons": [
                                { "title": "Reading and Vocabulary", "questions": [] },
                                { "title": "Narration & Inversion", "questions": [] }
                            ]
                        }
                    ]
                },
                "second": {
                    "title": "Second Semester",
                    "units": [
                        { "title": "Unit 1", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modal & Related & Articles", "questions": [] } ] },
                        { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Reported Speech & Reporting Verbs", "questions": [] } ] },
                        { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "The Passive", "questions": [] } ] },
                        { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Conditionals & Modals", "questions": [] } ] },
                        { "title": "Unit 5", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modals & Clauses", "questions": [] } ] }
                    ]
                }
            },
            "اللغة العربية": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الوحدة الأولى", "lessons": [ { "title": "من القيم الإنسانية في القرآن", "questions": [] }, { "title": "اسلوب الطلب وجوابه المجزوم والتشبيه المفرد", "questions": [] } ] },
                        { "title": "الوحدة الثانية", "lessons": [ { "title": "عمانيات", "questions": [] }, { "title": "صور الفاعل والتشبيه التمثيلي", "questions": [] } ] },
                        { "title": "الوحدة الثالثة", "lessons": [ { "title": "الزهايمر-الخرف المبكر", "questions": [] }, { "title": "صور المبتدأ والخبر والجملة الخبرية والإنشائية", "questions": [] } ] },
                        { "title": "الوحدة الرابعة", "lessons": [ { "title": "الإعلام ومشروع النهوض باللغة العربية", "questions": [] }, { "title": "المفعول معه والأمر", "questions": [] } ] },
                        { "title": "الوحدة الخامسة", "lessons": [ { "title": "التعليم التقني بوابة المستقبل في عالم متغير", "questions": [] }, { "title": "انواع ما والإستفهام", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "في فتح القدس", "questions": [] }, { "title": "معاني حروف الجر والتشخيص", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "قصة-حفنة تمر", "questions": [] }, { "title": "اسم الفاعل واسم المفعول والطباق والمقابلة", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "شاعرات من بلدي", "questions": [] }, { "title": "اسم الزمان واسم المكان وجمع التكسير (القلة والكثرة)", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "من مقامات بديع الزمان الهمذاني", "questions": [] }, { "title": "مصدر المرة ومصدر الهيئة والبحر المتدارك", "questions": [] } ] },
                         { "title": "الوحدة الخامسة", "lessons": [ { "title": "الذكاء الاصطناعي-عالم جديد", "questions": [] }, { "title": "اسم الآلة", "questions": [] } ] }
                    ]
                }
            },
             "التاريخ": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الأردن في العصور القديمة", "lessons": [ { "title": "الأردن في العصور الحجرية", "questions": [] }, { "title": "الأردن في العصر الحديدي", "questions": [] }, { "title": "مملكة الأنباط", "questions": [] }, { "title": "مظاهر الحضارة اليونانية في الأردن", "questions": [] }, { "title": "مظاهر الحضارة الرومانية-البيزنطية في الأردن", "questions": [] } ] },
                        { "title": "الأردن في صدر الإسلام", "lessons": [ { "title": "الأردن في صدر الإسلام", "questions": [] }, { "title": "الأردن في العصر الأموي", "questions": [] }, { "title": "الأردن في العصر العباسي", "questions": [] }, { "title": "الأردن خلال حملات الفرنجة", "questions": [] }, { "title": "الأردن في العصر الأيوبي", "questions": [] }, { "title": "الأردن في العصر المملوكي", "questions": [] } ] },
                        { "title": "الأردن في العصر الحديث", "lessons": [ { "title": "الأوضاع السياسية والإدارية في الأردن في العهد العثماني", "questions": [] }, { "title": "الأوضاع الإجتماعية والإقتصادية الأردن في العهد العثماني", "questions": [] }, { "title": "الثورة العربية الكبرى", "questions": [] }, { "title": "الأردن في عهد المملكة العربية السورية والحكومات المحلية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                     "units": [
                        { "title": "الحياة السياسية في الأردن", "lessons": [ { "title": "تأسيس الإمارة الأردنية", "questions": [] }, { "title": "استقلال المملكة الأردنية الهاشمية", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1948-1957)", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1958-1999)", "questions": [] }, { "title": "الحياة السياسية في الأردن منذ 1999", "questions": [] }, { "title": "الأردن والعلاقات العربية والدولية", "questions": [] }, { "title": "القوات المسلحة الأردنية - الجيش العربي", "questions": [] }, { "title": "الأجهزة الأمنية الأردنية", "questions": [] } ] },
                        { "title": "الحياة الاقتصادية في الأردن", "lessons": [ { "title": "الحياة الاقتصادية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1951-1967)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1968-1999)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "الحياة الاجتماعية في الأردن", "lessons": [ { "title": "الحياة الاجتماعية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن بين عامي (1951-1999)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "التعليم والثقافة في الأردن", "lessons": [ { "title": "التعليم العام في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1951-1987)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1988-2024)", "questions": [] }, { "title": "التعليم العالي والبحث العلمي في الأردن منذ عام 1951", "questions": [] }, { "title": "الحياة الثقافية في الأردن في عهد الإمارة", "questions": [] }, { "title": "الحياة الثقافية في الأردن منذ عام 1946", "questions": [] } ] },
                        { "title": "الأردن والقضية الفلسطينية", "lessons": [ { "title": "موقف الأردن من القضية الفلسطينية بين عامي (1916-1951)", "questions": [] }, { "title": "موقف الأردن من القضية الفلسطينية منذ عام 1951", "questions": [] }, { "title": "الوصاية والإعمار الهاشمي للمقدسات الدينية في القدس", "questions": [] } ] }
                    ]
                }
            },
             "دين": {
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة آل عمران (102-105)", "questions": [] }, { "title": "حديث اتقاء الشبهات", "questions": [] }, { "title": "من صور الضلال", "questions": [] }, { "title": "كرامة الإنسان في الشريعة", "questions": [] }, { "title": "الزواج-مشروعيته ومقدماته", "questions": [] }, { "title": "الجهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "جهود علماء المسلمين في خدمة القرآن", "questions": [] }, { "title": "العزيمة والرخصة", "questions": [] }, { "title": "معركة مؤتة (8 هجري)", "questions": [] }, { "title": "المحرمات من النساء", "questions": [] }, { "title": "التعايش الإنساني", "questions": [] }, { "title": "الحقوق الإجتماعية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة آل عمران (169-174)", "questions": [] }, { "title": "حديث - رضا الله تعالى", "questions": [] }, { "title": "فتح مكة (8 هجري)", "questions": [] }, { "title": "من خصائص الشريعة - الإيجابية", "questions": [] }, { "title": "شروط صحة عقد الزواج", "questions": [] }, { "title": "الحقوق المالية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "سورة الروم (21-24)", "questions": [] }, { "title": "مكانة السنة النبوية في التشريع", "questions": [] }, { "title": "مراعاة الأعراف في الشريعة", "questions": [] }, { "title": "حقوق الزوجين", "questions": [] }, { "title": "تنظيم النسل وتحديده", "questions": [] }, { "title": "الأمن الغذائي في الإسلام", "questions": [] }, { "title": "الإسلام والوحدة الوطنية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة البقرة (284-286)", "questions": [] }, { "title": "دلائل وجود الله تعالى", "questions": [] }, { "title": "إعجاز القرآن الكريم", "questions": [] }, { "title": "الأمر بالمعروف والنهي عن المنكر", "questions": [] }, { "title": "اليوم الآخر - احداثه وآثار الإيمان به", "questions": [] }, { "title": "الإجتهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "سورة الأعراف (31-34)", "questions": [] }, { "title": "مراعاة المصالح في الشريعة", "questions": [] }, { "title": "جهود علماء المسلمين في الحفاظ على السنة النبوية", "questions": [] }, { "title": "حديث - منهج الإسلام في الحياة", "questions": [] }, { "title": "رسائل النبي الى الملوك والزعماء في عصره", "questions": [] }, { "title": "يوم تبوك (9 هجري)", "questions": [] }, { "title": "الحقوق السياسية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة الفرقان (63-77)", "questions": [] }, { "title": "الطلاق", "questions": [] }, { "title": "العدة", "questions": [] }, { "title": "الوصية في الشريعة", "questions": [] }, { "title": "الميراث في الشريعة", "questions": [] }, { "title": "من خصائص الشريعة - الوسطية", "questions": [] }, { "title": "مجالات الوقف ودورها في التنمية", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "حديث - مفهوم الإفلاس بين الدنيا والآخرة", "questions": [] }, { "title": "مقاصد الشريعة", "questions": [] }, { "title": "منهج الإسلام في مكافحة الجريمة", "questions": [] }, { "title": "من وصايا النبي في حجة الوداع", "questions": [] }, { "title": "المسؤولية المجتمعية في الإسلام", "questions": [] }, { "title": "حقوق الإنسان بين الإسلام والإعلان العالمي لحقوق الإنسان", "questions": [] } ] }
                    ]
                }
            }
        };

        // Function to generate HTML for topic lists - REVISED for UI
        function generateSemesterContent(subject, semester) {
            if (!topicsData[subject] || !topicsData[subject][semester]) {
                console.error(`Data missing for subject: ${subject}, semester: ${semester}`);
                return `<div id="${subject}-${semester}" class="semester-content"><div class="unit-container"><div class="unit-title">Error</div><p>Content not available.</p></div></div>`;
            }

            const semesterData = topicsData[subject][semester];
            // Outer div for the whole semester's content
            let html = `<div id="${subject}-${semester}" class="semester-content">
                            <div class="unit-container"> <!-- Separate container for semester title -->
                                 <div class="unit-title">${semesterData.title}</div>
                            </div>`; // Close semester title container

            if (!semesterData.units || !Array.isArray(semesterData.units) || semesterData.units.length === 0) {
                 html += `<div class="section"><p>No units available for this semester.</p></div>`; // Message within a section box
            } else {
                 semesterData.units.forEach(unit => {
                     if (unit && unit.title) {
                         html += `<div class="section">
                                     <div class="section-title">${unit.title}</div>`; // Unit title
                         if (unit.lessons && Array.isArray(unit.lessons) && unit.lessons.length > 0) {
                             unit.lessons.forEach(lesson => {
                                 if (lesson && lesson.title) {
                                     html += `<div class="section-content" data-subject="${subject}" data-unit="${unit.title}" data-lesson="${lesson.title}">
                                                 ${lesson.title}
                                               </div>`;
                                 } else { console.warn(`Invalid lesson in unit: ${unit.title}`, lesson); }
                             });
                         } else {
                             html += `<p style="margin-left: 0; margin-top: 10px; font-size: 14px; color: #64748b;">(No lessons in this unit yet)</p>`;
                         }
                         html += `</div>`; // End Unit section
                     } else { console.warn(`Invalid unit in subject: ${subject}, semester: ${semester}`, unit); }
                 });
            }
            html += `</div>`; // End outer semester div
            return html;
        }


        // Generate content for all subjects and semesters
        function generateAllContent() {
            let contentHTML = '';
            const contentDiv = document.getElementById('content');
            if (!contentDiv) { console.error("Content container #content not found!"); return; }
            for (const subject in topicsData) {
                if (topicsData.hasOwnProperty(subject)) {
                    for (const semester in topicsData[subject]) {
                         if (topicsData[subject].hasOwnProperty(semester)) {
                            contentHTML += generateSemesterContent(subject, semester);
                         }
                    }
                }
            }
            contentDiv.innerHTML = contentHTML;
        }

        // Initialize content when the page loads
        document.addEventListener('DOMContentLoaded', generateAllContent);

        // --- END OF topics.js ---
    </script>

    <script>
        // --- START OF questions.js ---

        // --- Global State ---
        let quizState = {
            currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null,
            selectedAnswers: [], questions: [], subject: '', unit: '', lesson: '',
            matchingState: { selectedPromptElement: null, userPairs: {} }
        };

        // --- DOM Element References ---
        let contentElement, quizViewElement, quizTitleElement, quizContainerElement, feedbackContainerElement, quizButtonsContainerElement;

        // --- Utility Functions ---
        function shuffleArray(array) { /* Fisher-Yates Shuffle */
             for (let i = array.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [array[i], array[j]] = [array[j], array[i]];
             }
             return array;
         }

        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            contentElement = document.getElementById('content');
            quizViewElement = document.getElementById('quiz-view');
            quizTitleElement = document.getElementById('quiz-title');
            quizContainerElement = document.getElementById('quiz-container');
            feedbackContainerElement = document.getElementById('feedback-container');
            quizButtonsContainerElement = document.getElementById('quiz-buttons-container');

            // Nav button listeners with confirmation
            document.querySelectorAll('.nav-btn[data-subject]').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress lost.")) return;
                    showTopicList(); // Always go back to list view before updating content
                    document.querySelectorAll('.nav-btn[data-subject]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });
            document.querySelectorAll('.semester-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (!quizViewElement.classList.contains('hidden') && !confirm("Leave quiz? Progress lost.")) return;
                    showTopicList();
                    document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });

            updateContent(); // Initial topic list load
        });

        // --- View Management ---
        function showTopicList() {
            if (contentElement && quizViewElement) {
                contentElement.classList.remove('hidden');
                quizViewElement.classList.add('hidden');
                quizState = { // Reset state
                    currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: 0, startTime: null, endTime: null,
                    selectedAnswers: [], questions: [], subject: '', unit: '', lesson: '',
                    matchingState: { selectedPromptElement: null, userPairs: {} }
                };
                // console.log("Returned to topic list, quiz state reset.");
            }
        }
        function showQuizView() {
             if (contentElement && quizViewElement) {
                 contentElement.classList.add('hidden');
                 quizViewElement.classList.remove('hidden');
                 quizViewElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
        }

        // --- Core Functions ---
        // Update main topic list view
        function updateContent() {
            const activeSubjectBtn = document.querySelector('.nav-btn[data-subject].active');
            const activeSemesterBtn = document.querySelector('.semester-btn.active');
            if (!activeSubjectBtn || !activeSemesterBtn || !contentElement) return;
            const activeSubject = activeSubjectBtn.dataset.subject;
            const activeSemester = activeSemesterBtn.dataset.semester;

            contentElement.querySelectorAll('.semester-content').forEach(content => content.classList.remove('active'));
            const contentId = `${activeSubject}-${activeSemester}`;
            const semesterContentElement = contentElement.querySelector(`#${contentId}`);

            if (semesterContentElement) {
                semesterContentElement.classList.add('active');
                semesterContentElement.querySelectorAll('.section-content').forEach(lessonBox => { // Target lesson boxes
                    const newLessonBox = lessonBox.cloneNode(true);
                    lessonBox.parentNode.replaceChild(newLessonBox, lessonBox);
                    newLessonBox.addEventListener('click', function() {
                        handleSectionClick(this.dataset.subject, this.dataset.unit, this.dataset.lesson);
                    });
                });
            } else { console.warn(`Semester content element ID "${contentId}" not found.`); }
        }

        // Handle clicking a lesson -> Start Quiz
        function handleSectionClick(subject, unit, lesson) {
             if (!subject || !unit || !lesson) { alert("Error identifying topic."); return; }
            // console.log(`Starting quiz for: Subject=${subject}, Unit=${unit}, Lesson=${lesson}`);
            try {
                const questions = getQuestions(subject, unit, lesson);
                if (questions && questions.length > 0) {
                    startQuiz(subject, unit, lesson, questions);
                } else { showError(subject, unit, lesson); } // Show error in quiz view
            } catch (error) {
                console.error("Error handling section click:", error);
                showError(subject, unit, lesson, "An error occurred loading questions.");
            }
        }

        // Start a new quiz
        function startQuiz(subject, unit, lesson, questions) {
            quizState = { // Reset state
                currentQuestionIndex: 0, correctAnswers: 0, totalQuestions: questions.length, startTime: new Date(), endTime: null,
                selectedAnswers: new Array(questions.length).fill(null), questions: questions, subject: subject, unit: unit, lesson: lesson,
                matchingState: { selectedPromptElement: null, userPairs: {} }
            };
            if (quizTitleElement) quizTitleElement.textContent = `${lesson}`;
            showQuizView(); displayQuestion();
        }

        // Display the current question
        function displayQuestion() {
            if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement) return;
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
            if (!currentQuestion) { displayResults(); return; } // End quiz if no more questions

            quizContainerElement.innerHTML = ''; feedbackContainerElement.innerHTML = ''; feedbackContainerElement.classList.add('hidden'); quizButtonsContainerElement.innerHTML = ''; // Clear areas

            const questionWrapper = document.createElement('div'); questionWrapper.className = 'question-display-wrapper';
            const progressText = document.createElement('div'); progressText.className = 'question-progress'; progressText.textContent = `Question ${quizState.currentQuestionIndex + 1} of ${quizState.totalQuestions}`; questionWrapper.appendChild(progressText);
            const questionText = document.createElement('p'); questionText.className = 'question-text'; questionText.innerHTML = `<strong>Q:</strong> ${currentQuestion.question || 'Missing question text'}`; questionWrapper.appendChild(questionText);
            const typeWrapper = document.createElement('div'); typeWrapper.className = 'question-type-wrapper';

            try { // Render based on type
                 switch (currentQuestion.type) {
                     case "matching": renderMatching(currentQuestion, typeWrapper); break;
                     case "ordering": renderOrdering(currentQuestion, typeWrapper); break;
                     case "multiple_choice": default: renderMultipleChoice(currentQuestion, typeWrapper); break;
                 }
            } catch (renderError) { console.error("Error rendering question:", renderError); typeWrapper.innerHTML = `<p style="color: red;">Error displaying question.</p>`; }
            questionWrapper.appendChild(typeWrapper); quizContainerElement.appendChild(questionWrapper);

            // Render Buttons
            const submitBtn = document.createElement('button'); submitBtn.className = 'btn submit-btn'; submitBtn.id = 'submit-btn'; submitBtn.textContent = 'Submit Answer'; submitBtn.onclick = checkAnswer;
            const nextBtn = document.createElement('button'); nextBtn.className = 'btn next-btn hidden'; nextBtn.id = 'next-btn'; nextBtn.textContent = quizState.currentQuestionIndex === quizState.totalQuestions - 1 ? 'See Results' : 'Next Question'; nextBtn.onclick = nextQuestion;
            quizButtonsContainerElement.appendChild(submitBtn); quizButtonsContainerElement.appendChild(nextBtn);

             // Set initial disabled state for submit button based on type
             submitBtn.disabled = true; // Start disabled
             if (currentQuestion.type === 'multiple_choice') {
                 // Enabled by listener in renderMultipleChoice
             } else if (currentQuestion.type === 'matching') {
                 // Enabled by listener in handleMatchingClick when all paired
             } else if (currentQuestion.type === 'ordering') {
                 // Enabled by listener in renderOrdering when all selected
             } else {
                  submitBtn.disabled = false; // Default to enabled if type unknown or simple
             }
        }

        // --- Rendering Functions ---
        function renderMultipleChoice(question, container) { /* Same as before */
            if (!question.options || !Array.isArray(question.options)) { container.textContent = 'Error: Options invalid.'; return; }
            const optionsDiv = document.createElement('div'); optionsDiv.className = 'options-container'; optionsDiv.id = 'options-list';
            question.options.forEach((option, index) => {
                const optionId = `option-${index}`, label = document.createElement('label'); label.className = 'option-label'; label.htmlFor = optionId;
                const input = document.createElement('input'); input.type = 'radio'; input.name = 'question-option'; input.value = index; input.id = optionId; input.className = 'option-input';
                input.addEventListener('change', () => { document.getElementById('submit-btn').disabled = false; }); // Enable on change
                const text = document.createElement('span'); text.className = 'option-text'; text.textContent = option;
                label.appendChild(input); label.appendChild(text); optionsDiv.appendChild(label);
            }); container.appendChild(optionsDiv);
         }
        function renderMatching(question, container) { /* Same as before */
             if (!question.prompts || !question.matches || !Array.isArray(question.prompts) || !Array.isArray(question.matches) || question.prompts.length !== question.matches.length) { container.textContent = 'Error: Matching data invalid.'; return; }
             quizState.matchingState.userPairs = {};
             const instructions = document.createElement('p'); instructions.className = 'matching-instructions'; instructions.textContent = 'Click left item, then matching right item.'; container.appendChild(instructions);
             const matchingContainer = document.createElement('div'); matchingContainer.className = 'matching-container';
             const promptsCol = document.createElement('div'); promptsCol.className = 'matching-column'; promptsCol.id = 'prompts-column'; promptsCol.innerHTML = '<h4>Items</h4>';
             const matchesCol = document.createElement('div'); matchesCol.className = 'matching-column'; matchesCol.id = 'matches-column'; matchesCol.innerHTML = '<h4>Matches</h4>';
             const shuffledMatches = question.matches.map((text, idx) => ({ text, originalIndex: idx })).sort(() => Math.random() - 0.5);
             question.prompts.forEach((promptText, index) => { const item = document.createElement('div'); item.className = 'matching-item prompt-item'; item.textContent = promptText; item.dataset.index = index; item.addEventListener('click', handleMatchingClick); promptsCol.appendChild(item); });
             shuffledMatches.forEach((matchObj) => { const item = document.createElement('div'); item.className = 'matching-item match-item'; item.textContent = matchObj.text; item.dataset.index = matchObj.originalIndex; item.addEventListener('click', handleMatchingClick); matchesCol.appendChild(item); });
             matchingContainer.appendChild(promptsCol); matchingContainer.appendChild(matchesCol); container.appendChild(matchingContainer);
         }
        function renderOrdering(question, container) { /* Same as before, includes checkAllSelected */
             if (!question.items || !Array.isArray(question.items) || question.items.length === 0) { container.textContent = 'Error: Ordering data invalid.'; return; }
             const numItems = question.items.length;
             const instructions = document.createElement('p'); instructions.className = 'ordering-instructions'; instructions.textContent = `Select order number (1-${numItems}) for each.`; container.appendChild(instructions);
             const orderingContainer = document.createElement('div'); orderingContainer.className = 'ordering-container'; orderingContainer.id = 'ordering-list';
             const checkAllSelected = () => { const allSelected = Array.from(orderingContainer.querySelectorAll('.ordering-select')).every(s => s.value !== ""); const btn = document.getElementById('submit-btn'); if(btn) btn.disabled = !allSelected; };
             question.items.forEach((itemText, index) => {
                 const itemDiv = document.createElement('div'); itemDiv.className = 'ordering-item'; itemDiv.dataset.originalIndex = index;
                 const select = document.createElement('select'); select.className = 'ordering-select'; select.dataset.itemIndex = index; const defaultOption = document.createElement('option'); defaultOption.value = ""; defaultOption.textContent = "-"; defaultOption.selected = true; defaultOption.disabled = true; select.appendChild(defaultOption);
                 for (let i = 1; i <= numItems; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; select.appendChild(option); }
                 select.addEventListener('change', checkAllSelected);
                 const textSpan = document.createElement('span'); textSpan.className = 'ordering-text'; textSpan.textContent = itemText;
                 itemDiv.appendChild(select); itemDiv.appendChild(textSpan); orderingContainer.appendChild(itemDiv);
             }); container.appendChild(orderingContainer);
         }

        // --- Interaction Handlers ---
        function handleMatchingClick(event) { /* Same as before */
            const clickedItem = event.target; if (clickedItem.classList.contains('matched') || !clickedItem.classList.contains('matching-item')) return;
            const isPrompt = clickedItem.classList.contains('prompt-item'); let currentSelection = quizState.matchingState.selectedPromptElement;
            if (isPrompt) { if (currentSelection) currentSelection.classList.remove('selected'); if (currentSelection !== clickedItem) { clickedItem.classList.add('selected'); quizState.matchingState.selectedPromptElement = clickedItem; } else { quizState.matchingState.selectedPromptElement = null; } }
            else { if (currentSelection) { const promptIndex = currentSelection.dataset.index, matchIndex = clickedItem.dataset.index; quizState.matchingState.userPairs[promptIndex] = parseInt(matchIndex, 10); currentSelection.classList.remove('selected'); currentSelection.classList.add('matched'); clickedItem.classList.add('matched'); currentSelection.style.cursor = 'default'; clickedItem.style.cursor = 'default'; quizState.matchingState.selectedPromptElement = null; const total = document.querySelectorAll('.prompt-item').length, matched = document.querySelectorAll('.prompt-item.matched').length; if (total === matched) { document.getElementById('submit-btn').disabled = false; } } }
         }

        // --- Answer Checking ---
        function checkAnswer() { /* Same structure */
            if (!feedbackContainerElement || !quizButtonsContainerElement) return;
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
            let result = { isCorrect: false, feedback: '', userResponse: null, scoreIncrement: 0 };
            try { switch (currentQuestion.type) { case "matching": result = checkMatching(currentQuestion); break; case "ordering": result = checkOrdering(currentQuestion); break; case "multiple_choice": default: result = checkMultipleChoice(currentQuestion); break; } }
            catch (error) { console.error("Check error:", error); result = { isCorrect: false, feedback: '<div class="incorrect-feedback">Error checking answer.</div>', userResponse: null, scoreIncrement: 0 }; }
            quizState.selectedAnswers[quizState.currentQuestionIndex] = result.userResponse; if (result.isCorrect) { quizState.correctAnswers += result.scoreIncrement; }
            feedbackContainerElement.innerHTML = result.feedback; feedbackContainerElement.classList.remove('hidden');
            disableInputs(); const submitBtn = quizButtonsContainerElement.querySelector('#submit-btn'), nextBtn = quizButtonsContainerElement.querySelector('#next-btn'); if(submitBtn) submitBtn.classList.add('hidden'); if(nextBtn) nextBtn.classList.remove('hidden');
         }
        function checkMultipleChoice(question) { /* Same as before */
            const sel = document.querySelector('input[name="question-option"]:checked'); if (!sel) return { isCorrect: false, feedback: '<div class="incorrect-feedback">Select answer.</div>', userResponse: null, scoreIncrement: 0 };
            const idx = parseInt(sel.value, 10), correctText = question.answer, selText = question.options[idx], isCorrect = selText === correctText;
            document.querySelectorAll('.option-label').forEach((lbl, i) => { const inp = lbl.querySelector('input'); if (question.options[i] === correctText) lbl.classList.add('correct-option'); if (inp && parseInt(inp.value, 10) === idx && !isCorrect) lbl.classList.add('incorrect-option'); });
            const fb = isCorrect ? '<div class="correct-feedback">Correct! ✓</div>' : `<div class="incorrect-feedback">Incorrect. <span>Correct: ${correctText}</span></div>`;
            return { isCorrect, feedback: fb, userResponse: idx, scoreIncrement: isCorrect ? 1 : 0 };
         }
        function checkMatching(question) { /* Same as before */
            const userPairs = quizState.matchingState.userPairs, correctPairs = question.answer || {}, total = Object.keys(correctPairs).length; let correctCount = 0; if (total === 0) return { isCorrect: true, feedback: '<div class="correct-feedback">N/A</div>', userResponse: userPairs, scoreIncrement: 0 };
            for (const pIdx in correctPairs) { if (userPairs.hasOwnProperty(pIdx) && userPairs[pIdx] === correctPairs[pIdx]) correctCount++; } const isFull = correctCount === total;
            let fb = ''; if (isFull) fb = `<div class="correct-feedback">Correct! ✓ (${correctCount}/${total})</div>`; else if (correctCount > 0) fb = `<div class="partial-feedback">Partial. Matched ${correctCount}/${total}.</div>`; else fb = `<div class="incorrect-feedback">Incorrect. Matched 0/${total}.</div>`;
            return { isCorrect: isFull, feedback: fb, userResponse: userPairs, scoreIncrement: isFull ? 1 : 0 };
         }
        function checkOrdering(question) { /* Same robust logic as verified before */
            const items = question.items || []; const correctOrder = question.answer || []; const numItems = items.length;
            if (numItems === 0 || !Array.isArray(correctOrder) || numItems !== correctOrder.length) { console.error("Invalid ordering data:", question); return { isCorrect: false, feedback: '<div class="incorrect-feedback">Error: Invalid question setup.</div>', userResponse: null, scoreIncrement: 0 }; }
            const userOrderMap = {}, selectedNumbers = new Set(); let allSelected = true, hasDuplicate = false;
            const selects = document.querySelectorAll('#ordering-list .ordering-select');
            if (selects.length !== numItems) { console.error(`Select count mismatch`); return { isCorrect: false, feedback: '<div class="incorrect-feedback">Error processing form.</div>', userResponse: null, scoreIncrement: 0 }; }
            selects.forEach(select => {
                const itemIndex = parseInt(select.dataset.itemIndex, 10), val = select.value;
                if (val === "") { allSelected = false; }
                else { const num = parseInt(val, 10); if (isNaN(num) || num < 1 || num > numItems) { allSelected = false; return; } userOrderMap[itemIndex] = num; if (selectedNumbers.has(num)) hasDuplicate = true; selectedNumbers.add(num); }
            });
            // console.log("User Map:", userOrderMap); // Uncomment for debugging
            if (!allSelected) { console.log("ValFail: Not all selected."); return { isCorrect: false, feedback: '<div class="incorrect-feedback">Select order for all items.</div>', userResponse: null, scoreIncrement: 0 }; }
            if (hasDuplicate || selectedNumbers.size !== numItems) { console.log(`ValFail: Dups(${hasDuplicate}) or Count(${selectedNumbers.size} vs ${numItems})`); return { isCorrect: false, feedback: `<div class="incorrect-feedback">Use each number (1-${numItems}) once.</div>`, userResponse: null, scoreIncrement: 0 }; }
            const userOrderedItems = new Array(numItems).fill(null); let ok = true;
            for (const idxStr in userOrderMap) { if (userOrderMap.hasOwnProperty(idxStr)) { const idx = parseInt(idxStr, 10), text = items[idx], pos = userOrderMap[idx] - 1; if (text === undefined || pos < 0 || pos >= numItems) { ok = false; break; } if (userOrderedItems[pos] !== null) { ok = false; break; } userOrderedItems[pos] = text; } }
            if (!ok || userOrderedItems.some(i => i === null)) { console.error("Construction Fail:", userOrderedItems); return { isCorrect: false, feedback: '<div class="incorrect-feedback">Error processing sequence.</div>', userResponse: userOrderedItems, scoreIncrement: 0 }; }
            // console.log("User Ordered:", JSON.stringify(userOrderedItems)); console.log("Correct:", JSON.stringify(correctOrder)); // Uncomment for debugging
            const isCorrect = JSON.stringify(userOrderedItems) === JSON.stringify(correctOrder); // console.log("Is Correct:", isCorrect);
            let fb = ''; if (isCorrect) fb = `<div class="correct-feedback">Correct! ✓</div>`; else fb = `<div class="incorrect-feedback">Incorrect. <span>Correct: ${correctOrder.join(' → ')}</span></div>`;
            selects.forEach(sel => { const idx = parseInt(sel.dataset.itemIndex, 10), userN = userOrderMap[idx], correctN = correctOrder.indexOf(items[idx]) + 1; sel.style.borderColor = (userN === correctN) ? '#16a34a' : '#ef4444'; sel.style.borderWidth = '2px'; });
            return { isCorrect, feedback: fb, userResponse: userOrderedItems, scoreIncrement: isCorrect ? 1 : 0 };
        }
        function disableInputs() { /* Same as before */
             document.querySelectorAll('input[name="question-option"], .ordering-select').forEach(i => i.disabled = true); document.querySelectorAll('.option-label').forEach(l => l.style.cursor = 'default'); document.querySelectorAll('.matching-item').forEach(i => { i.style.pointerEvents = 'none'; i.style.cursor = 'default'; });
         }


        // --- Navigation and Results ---

        function nextQuestion() {
            quizState.currentQuestionIndex++;
            if (quizState.currentQuestionIndex < quizState.totalQuestions) {
                displayQuestion();
            } else {
                quizState.endTime = new Date();
                displayResults();
            }
        }

        // Display results within the #quiz-container
        function displayResults() {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement) return;

             quizContainerElement.innerHTML = ''; // Clear question area
             feedbackContainerElement.classList.add('hidden'); // Hide feedback area
             quizButtonsContainerElement.innerHTML = ''; // Clear standard buttons

             const timeTaken = quizState.endTime && quizState.startTime ? (quizState.endTime - quizState.startTime) / 1000 : 0;
             const minutes = Math.floor(timeTaken / 60);
             const seconds = Math.floor(timeTaken % 60);
             const timeString = timeTaken > 0 ? `${minutes}m ${seconds}s` : 'N/A';
             const scorePercentage = quizState.totalQuestions > 0 ? (quizState.correctAnswers / quizState.totalQuestions) * 100 : 0;
             let performanceMessage = ''; // Determine message based on score... (same as before)
              if (quizState.totalQuestions === 0) performanceMessage = 'No questions were answered.';
              else if (scorePercentage >= 90) performanceMessage = 'Excellent job! 🎉';
              else if (scorePercentage >= 70) performanceMessage = 'Good work! 👍';
              else if (scorePercentage >= 50) performanceMessage = 'Not bad. Keep practicing! 💪';
              else performanceMessage = 'You might need more study time. 📚';


             const resultsDiv = document.createElement('div');
             resultsDiv.className = 'results-container';
             resultsDiv.innerHTML = `
                <h2 class="results-header">${performanceMessage}</h2>
                <div class="results-score"> <div class="score-circle"> <span class="score-number">${scorePercentage.toFixed(0)}</span> <span class="score-percent-sign">%</span> </div> </div>
                <div class="results-details">
                    <p><strong>Subject:</strong> ${quizState.subject || 'N/A'}</p> <p><strong>Unit:</strong> ${quizState.unit || 'N/A'}</p> <p><strong>Lesson:</strong> ${quizState.lesson || 'N/A'}</p>
                    <p><strong>Correct Answers:</strong> ${quizState.correctAnswers} out of ${quizState.totalQuestions}</p> <p><strong>Time Taken:</strong> ${timeString}</p>
                </div>`;
             quizContainerElement.appendChild(resultsDiv);

             // Add Results Buttons to the button container
             const actionsDiv = document.createElement('div');
             actionsDiv.className = 'results-actions'; // Use specific class if needed
             if (quizState.totalQuestions > 0) {
                 const reviewBtn = document.createElement('button');
                 reviewBtn.id = 'review-btn'; reviewBtn.className = 'btn review-btn'; reviewBtn.textContent = 'Review Answers';
                 reviewBtn.addEventListener('click', reviewAnswers);
                 actionsDiv.appendChild(reviewBtn);
             }
             const backBtn = document.createElement('button');
             backBtn.className = 'btn back-to-topics-btn'; backBtn.textContent = 'Back to Topics';
             backBtn.onclick = showTopicList; // Use the view switching function
             actionsDiv.appendChild(backBtn);
             quizButtonsContainerElement.appendChild(actionsDiv);
         }

        // --- Answer Review Functions (Render into #quiz-container) ---

        function reviewAnswers() {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement) return;

             quizContainerElement.innerHTML = ''; // Clear results
             feedbackContainerElement.classList.add('hidden'); // Hide feedback
             quizButtonsContainerElement.innerHTML = ''; // Clear results buttons

             if (quizTitleElement) quizTitleElement.textContent = `Review: ${quizState.lesson}`; // Update title

             const reviewDiv = document.createElement('div');
             reviewDiv.className = 'review-container';

             // Render each question review
             quizState.questions.forEach((question, index) => {
                 const questionReview = document.createElement('div');
                 const userAnswer = quizState.selectedAnswers[index];
                 let { correctnessClass, statusText } = calculateReviewStatus(question, userAnswer); // Use helper

                 questionReview.className = `question-review ${correctnessClass}`;
                 questionReview.innerHTML = `
                    <div class="review-question-header">
                        <span class="review-question-number">Question ${index + 1} (${question.type.replace('_', ' ')})</span>
                        <span class="review-status">${statusText}</span>
                    </div>
                    <p class="review-question-text">${question.question || 'Missing question text'}</p>
                    <div id="review-answer-content-${index}"></div>`;
                 reviewDiv.appendChild(questionReview);

                 const reviewContentContainer = reviewDiv.querySelector(`#review-answer-content-${index}`);
                 if (reviewContentContainer) {
                     try {
                          switch (question.type) {
                              case "matching": reviewMatchingReview(question, userAnswer, reviewContentContainer); break; // Renamed review renderers
                              case "ordering": reviewOrderingReview(question, userAnswer, reviewContentContainer); break;
                              case "multiple_choice": default: reviewMultipleChoiceReview(question, userAnswer, reviewContentContainer); break;
                          }
                     } catch (reviewError) {
                         console.error("Error rendering review for question", index, reviewError);
                         reviewContentContainer.innerHTML = `<p style="color: red;">Error displaying review.</p>`;
                     }
                 }
             });
             quizContainerElement.appendChild(reviewDiv); // Add all reviews to quiz container

             // Add Review Buttons
             const actionsDiv = document.createElement('div');
             actionsDiv.className = 'review-actions'; // Specific class for review buttons layout
             const backToResultsBtn = document.createElement('button');
             backToResultsBtn.className = 'btn back-btn'; backToResultsBtn.textContent = '← Back to Results';
             backToResultsBtn.addEventListener('click', displayResults);
             actionsDiv.appendChild(backToResultsBtn);
              const backToTopicsBtn = document.createElement('button');
             backToTopicsBtn.className = 'btn back-to-topics-btn'; backToTopicsBtn.textContent = 'Back to Topics';
             backToTopicsBtn.onclick = showTopicList;
             actionsDiv.appendChild(backToTopicsBtn);

             quizButtonsContainerElement.appendChild(actionsDiv);
         }

         // Helper to determine review status class/text
         function calculateReviewStatus(question, userAnswer) {
             let correctnessClass = 'incorrect'; let statusText = '✗ Incorrect'; let reviewCorrectness = false;
             try {
                 switch (question.type) {
                     case "matching":
                         const correctPairs = question.answer || {}; const totalPairs = Object.keys(correctPairs).length; let correctCount = 0;
                         if (totalPairs > 0 && userAnswer && typeof userAnswer === 'object') {
                             for (const promptIndex in correctPairs) {
                                 if (userAnswer.hasOwnProperty(promptIndex) && userAnswer[promptIndex] === correctPairs[promptIndex]) correctCount++;
                             }
                         }
                         reviewCorrectness = totalPairs > 0 && (correctCount === totalPairs);
                         if (reviewCorrectness) { correctnessClass = 'correct'; statusText = '✓ Correct'; }
                         else if (correctCount > 0) { correctnessClass = 'partial'; statusText = `~ Partial (${correctCount}/${totalPairs})`; }
                         break; // Keep default incorrect if 0 correct
                     case "ordering":
                         if (userAnswer && Array.isArray(userAnswer) && question.answer && Array.isArray(question.answer)) {
                             reviewCorrectness = JSON.stringify(userAnswer) === JSON.stringify(question.answer);
                         }
                         correctnessClass = reviewCorrectness ? 'correct' : 'incorrect'; statusText = reviewCorrectness ? '✓ Correct' : '✗ Incorrect';
                         break;
                     case "multiple_choice": default:
                         if (userAnswer !== null && question.options && question.answer) {
                             reviewCorrectness = (question.options[userAnswer] === question.answer);
                         }
                         correctnessClass = reviewCorrectness ? 'correct' : 'incorrect'; statusText = reviewCorrectness ? '✓ Correct' : '✗ Incorrect';
                         break;
                 }
             } catch(e) { console.error("Error in calculateReviewStatus", e); /* Keep default incorrect */ }
             return { correctnessClass, statusText };
         }


         // Renamed Review Rendering functions (logic remains the same)
         function reviewMultipleChoiceReview(question, userAnswerIndex, container) { /* Use logic from previous reviewMultipleChoice */
              const div = document.createElement('div'); div.className = 'review-mc-answer';
              const userSelectedText = (userAnswerIndex !== null && question.options && question.options[userAnswerIndex] !== undefined) ? question.options[userAnswerIndex] : 'No answer selected';
              const isCorrect = (userAnswerIndex !== null) && (userSelectedText === question.answer);
              div.innerHTML = `<p><strong>Your answer:</strong> <span class="user-answer-text ${isCorrect ? 'correct' : (userAnswerIndex !== null ? 'incorrect' : '')}">${userSelectedText}</span></p>${!isCorrect ? `<p><strong>Correct answer:</strong> <span class="correct-answer-text">${question.answer || 'N/A'}</span></p>` : ''}`;
              container.appendChild(div);
          }
         function reviewMatchingReview(question, userPairs, container) { /* Use logic from previous reviewMatching */
              const div = document.createElement('div'); div.className = 'review-matching-answer'; div.innerHTML = `<p><strong>Matching Review:</strong></p>`;
              const reviewGrid = document.createElement('div'); reviewGrid.className = 'review-matching-grid';
              const promptsCol = document.createElement('div'); promptsCol.className = 'review-matching-column';
              const matchesCol = document.createElement('div'); matchesCol.className = 'review-matching-column';
              const correctPairs = question.answer || {};

              (question.prompts || []).forEach((promptText, promptIndex) => {
                  const userMatchIndex = userPairs ? userPairs[promptIndex] : null;
                  const correctMatchIndex = correctPairs[promptIndex]; // Can be undefined if data bad
                  const isPairCorrect = userMatchIndex !== null && userMatchIndex === correctMatchIndex;

                  const promptDiv = document.createElement('div'); promptDiv.textContent = promptText;
                  const matchDiv = document.createElement('div');
                  const userMatchText = (userMatchIndex !== null && question.matches && question.matches[userMatchIndex]) ? question.matches[userMatchIndex] : '(No match)';
                  const correctMatchText = (correctMatchIndex !== undefined && question.matches && question.matches[correctMatchIndex]) ? question.matches[correctMatchIndex] : '(N/A)';

                  if (isPairCorrect) {
                      promptDiv.classList.add('review-matched-pair-correct'); matchDiv.textContent = correctMatchText; matchDiv.classList.add('review-matched-pair-correct');
                  } else {
                      promptDiv.classList.add('review-matched-pair-incorrect'); matchDiv.innerHTML = `<span style="text-decoration: line-through; color: #dc2626;">${userMatchText}</span> <span style="color: #059669;">(${correctMatchText})</span>`; matchDiv.classList.add('review-matched-pair-incorrect');
                  }
                  promptsCol.appendChild(promptDiv); matchesCol.appendChild(matchDiv);
              });
              reviewGrid.appendChild(promptsCol); reviewGrid.appendChild(matchesCol); div.appendChild(reviewGrid); container.appendChild(div);
          }
         function reviewOrderingReview(question, userOrderedItems, container) { /* Use logic from previous reviewOrdering */
              const div = document.createElement('div'); div.className = 'review-ordering-answer';
              const correctOrder = question.answer || [];
              const isCorrect = userOrderedItems && (JSON.stringify(userOrderedItems) === JSON.stringify(correctOrder));
              div.innerHTML = `<p><strong>Ordering Review:</strong></p>`;
              const listDiv = document.createElement('div'); listDiv.className = 'review-ordering-list';

              correctOrder.forEach((correctItemText, correctIndex) => {
                   const itemDiv = document.createElement('div'); itemDiv.className = 'review-ordering-list-item';
                   const userIndex = userOrderedItems ? userOrderedItems.indexOf(correctItemText) : -1;
                   const userNumber = (userIndex !== -1) ? userIndex + 1 : null;
                   const correctNumber = correctIndex + 1;
                   let userNumSpan = '';
                   if (userNumber === correctNumber) userNumSpan = `<span class="review-order-number review-order-correct">${userNumber}.</span>`;
                   else if (userNumber !== null) userNumSpan = `<span class="review-order-number review-order-incorrect">${userNumber}.</span> <span class="review-order-number review-order-correct">(${correctNumber}.)</span>`;
                   else userNumSpan = `<span class="review-order-number review-order-incorrect">(N/P)</span> <span class="review-order-number review-order-correct">(${correctNumber}.)</span>`; // N/P = Not Placed
                   itemDiv.innerHTML = `${userNumSpan} ${correctItemText}`; listDiv.appendChild(itemDiv);
              });
              div.appendChild(listDiv);
              if (!isCorrect && userOrderedItems) div.innerHTML += `<p style="margin-top: 10px;"><strong>Your Order:</strong> ${userOrderedItems.join(' → ')}</p>`;
              container.appendChild(div);
          }


        // --- Error Display (within #quiz-container) ---
        function showError(subject, unit, lesson, message = '') {
             if (!quizContainerElement || !feedbackContainerElement || !quizButtonsContainerElement || !quizTitleElement) return;

            showQuizView(); // Ensure quiz view is visible
            quizTitleElement.textContent = 'Error'; // Set title

             quizContainerElement.innerHTML = ''; // Clear question area
             feedbackContainerElement.classList.add('hidden'); // Hide feedback area
             quizButtonsContainerElement.innerHTML = ''; // Clear standard buttons

            const defaultMessage = `Sorry, no questions are available yet for ${lesson} in ${unit}.`;
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-display'; // Use new class for styling
            errorDiv.innerHTML = `<div class="error-message">${message || defaultMessage}</div>`;

             // Add Back Button
             const backBtn = document.createElement('button');
             backBtn.className = 'btn back-to-topics-btn';
             backBtn.textContent = 'Back to Topics';
             backBtn.onclick = showTopicList;
             errorDiv.appendChild(backBtn);

            quizContainerElement.appendChild(errorDiv); // Add error display to quiz container
        }

        // --- Get Questions Data ---
        function getQuestions(subject, unitTitle, lessonTitle) {
             const activeSemesterBtn = document.querySelector('.semester-btn.active');
             if (!activeSemesterBtn) { console.error("Cannot determine active semester."); return []; }
             const activeSemester = activeSemesterBtn.dataset.semester;
             if (!subject || !unitTitle || !lessonTitle || !activeSemester) { console.error("Missing params for getQuestions."); return []; }

             try {
                 const subjectData = topicsData[subject];
                 const semesterData = subjectData ? subjectData[activeSemester] : null;
                 const units = semesterData ? semesterData.units : null;
                 if (!units) { console.warn(`Data structure missing: ${subject} -> ${activeSemester}`); return []; }

                 const unit = units.find(u => u && u.title === unitTitle);
                 const lessons = unit ? unit.lessons : null;
                 if (!lessons) { console.warn(`Unit "${unitTitle}" or lessons not found.`); return []; }

                 const lesson = lessons.find(l => l && l.title === lessonTitle);
                 if (!lesson) { console.warn(`Lesson "${lessonTitle}" not found.`); return []; }

                 if (lesson.questions && Array.isArray(lesson.questions)) {
                      // Add default type ONLY if 'type' is completely missing
                      return lesson.questions.map(q => ({ type: q.type || 'multiple_choice', ...q }));
                 } else { return []; }
             } catch (error) {
                 console.error("Error finding questions:", error); return [];
             }
         }

        // --- END OF questions.js ---
    </script>

</body>
</html>
