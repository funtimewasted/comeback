<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Question Bank</title>
    <style>
        /* --- START OF styles.css --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #ffffff;
            color: #1e293b; /* Default text color */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: left;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin: 0 0 20px 0;
            color: #0f172a; /* Darker heading */
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .subjects {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px;
        }

        .secondary-nav {
            display: flex;
            gap: 10px;
            padding-left: 10px; /* Slight indent */
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            color: #334155;
        }

        .nav-btn:hover {
            background-color: #f8f9fa;
            border-color: #cbd5e1;
        }

        .nav-btn.active {
            background-color: #0f172a;
            color: white;
            border-color: #0f172a; /* Match border */
        }
        .nav-btn.active span { /* Adjust icon color on active */
             filter: brightness(0) invert(1);
        }


        .semester-toggle {
            display: flex;
            gap: 5px;
            background-color: #f1f5f9;
            padding: 4px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .semester-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: none;
            color: #334155; /* Default color */
            transition: all 0.2s ease;
        }

        .semester-btn.active {
            background-color: #ffffff;
            color: #0f172a; /* Active color */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .unit-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .unit-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e293b; /* Darker title color */
        }

        .section {
            margin-bottom: 25px;
        }
        /* Add this to remove bottom margin from the last section */
        .section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .section-content {
            padding: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 15px; /* Slightly larger font */
            color: #334155; /* Content text color */
        }
         /* Remove margin from the last item in a section */
        .section-content:last-child {
            margin-bottom: 0;
        }

        .section-content:hover {
            background-color: #f8f9fa;
            border-color: #cbd5e1; /* Highlight border on hover */
        }

        .semester-content {
            display: none;
        }

        .semester-content.active {
            display: block;
        }

        /* --- Modal Styles --- */
        .question-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 1000;
            overflow-y: auto; /* Allow modal itself to scroll if content overflows */
            padding: 20px 0; /* Add some padding top/bottom */
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 20px auto; /* Reduced top margin, auto horizontal margin */
            padding: 30px; /* Increased padding */
            width: 90%; /* Responsive width */
            max-width: 800px;
            border-radius: 12px;
            min-height: 300px; /* Ensure minimum height */
            max-height: calc(100vh - 40px); /* Limit height based on viewport */
            overflow-y: auto; /* Allow content inside modal to scroll */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Stronger shadow */
        }

        .close-modal {
            position: absolute;
            right: 15px; /* Adjust position */
            top: 15px;   /* Adjust position */
            font-size: 28px; /* Larger close icon */
            font-weight: bold;
            cursor: pointer;
            color: #666;
            line-height: 1; /* Prevent extra spacing */
            z-index: 10; /* Ensure it's above title */
        }
        .close-modal:hover {
            color: #333;
        }

        #modalTitle {
            font-size: 20px; /* Slightly smaller modal title */
            font-weight: 600;
            margin-bottom: 25px; /* Increased spacing */
            color: #1e293b;
            padding-right: 30px; /* Ensure title doesn't overlap close button */
            border-bottom: 1px solid #e2e8f0; /* Separator */
            padding-bottom: 15px;
        }

        /* --- Quiz Interface Styles --- */
        .question-container {
            margin-bottom: 20px;
            /* Removed fixed padding, border, background - applied within type-specific containers */
        }
         /* Style for the specific question type wrapper */
        .question-type-wrapper {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f8fafc;
            margin-bottom: 20px; /* Space before feedback/buttons */
        }

        .question-progress {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 15px;
            text-align: right; /* Align progress to the right */
        }

        .question-text {
            font-size: 18px; /* Larger question text */
            margin-bottom: 25px; /* Increased spacing */
            line-height: 1.6;
            color: #1e293b; /* Darker text */
        }
        .question-text strong {
            font-weight: 600; /* Make "Q:" bolder */
            margin-right: 5px;
        }

        /* --- Multiple Choice Specific --- */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px; /* Increased spacing */
        }

        .option-label {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #fff; /* White background for options */
        }

        .option-label:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }
        .option-label input:checked + .option-text {
             font-weight: 500; /* Slightly bolder when selected */
        }
        .option-label input:checked {
             accent-color: #2563eb; /* Color the radio button */
        }

        .option-input {
            margin-right: 15px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .option-text {
            flex-grow: 1;
            font-size: 16px; /* Slightly larger option text */
            color: #334155;
        }

        /* --- Matching Specific --- */
        .matching-instructions {
            font-size: 15px;
            color: #475569;
            margin-bottom: 20px;
        }
        .matching-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 25px;
        }
        .matching-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .matching-column h4 {
            margin: 0 0 10px 0;
            font-size: 15px;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
        }
        .matching-item {
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            background-color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
        }
        .matching-item:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
        }
        .matching-item.selected {
            background-color: #dbeafe; /* Light blue */
            border-color: #60a5fa;
            font-weight: 500;
        }
         /* Style for items that have been successfully matched by the user */
        .matching-item.matched {
            background-color: #e5e7eb; /* Light gray */
            border-color: #9ca3af;
            cursor: not-allowed; /* Indicate it's locked */
            opacity: 0.8;
        }
        /* Style applied to both items in a review pair */
        .review-matched-pair-correct {
             background-color: #dcfce7 !important;
             border-color: #16a34a !important;
        }
         .review-matched-pair-incorrect {
             background-color: #fee2e2 !important;
             border-color: #ef4444 !important;
         }


        /* --- Ordering Specific --- */
        .ordering-instructions {
            font-size: 15px;
            color: #475569;
            margin-bottom: 20px;
        }
        .ordering-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        .ordering-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            background-color: #fff;
            border-radius: 6px;
        }
        .ordering-select {
            margin-right: 15px;
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            font-size: 14px;
            min-width: 60px; /* Give it some width */
        }
        .ordering-text {
            flex-grow: 1;
            font-size: 16px;
        }
        /* Style for review display */
        .review-order-number {
            font-weight: 600;
            min-width: 25px;
            text-align: right;
            margin-right: 10px;
        }
        .review-order-correct { color: #059669; }
        .review-order-incorrect { color: #dc2626; text-decoration: line-through; margin-right: 5px;}


        /* --- Feedback & Buttons --- */
        .feedback-container {
            padding: 15px;
            margin: 20px 0 0 0; /* Only margin top, attached below question type wrapper */
            border-radius: 6px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0; /* Add subtle border */
        }
         .feedback-container.hidden {
             display: none; /* Ensure hidden class works */
         }

        .correct-feedback {
            color: #059669;
            font-weight: 600; /* Bolder feedback */
            font-size: 16px;
        }
        .incorrect-feedback {
            color: #dc2626;
            font-weight: 600; /* Bolder feedback */
            font-size: 16px;
        }
        .incorrect-feedback span { /* Style for correct answer explanation */
            display: block;
            font-weight: 500;
            margin-top: 8px;
            font-size: 15px;
            color: #475569;
            line-height: 1.5;
        }
        .partial-feedback { /* For matching/ordering partial correctness */
             color: #ca8a04; /* Amber color */
             font-weight: 600;
             font-size: 16px;
         }


        .correct-option { /* MC Correct Option Highlighting */
            background-color: #dcfce7 !important; /* Lighter green */
            border-color: #16a34a !important;
        }
        .correct-option .option-text {
            color: #065f46 !important; /* Darker green text */
        }
        .incorrect-option { /* MC Incorrect Option Highlighting */
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        .incorrect-option .option-text {
            color: #b91c1c !important; /* Darker red text */
        }


        .quiz-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px; /* Increased spacing */
            border-top: 1px solid #e2e8f0; /* Separator line */
            padding-top: 20px; /* Space above buttons */
        }

        .btn {
            padding: 10px 20px; /* Slightly larger buttons */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px; /* Slightly larger font */
            font-weight: 500;
            transition: all 0.2s ease;
            line-height: 1.5; /* Ensure consistent height */
        }

        .submit-btn {
            background-color: #2563eb;
            color: white;
        }
        .submit-btn:hover:not(:disabled) {
            background-color: #1d4ed8;
        }
        .submit-btn:disabled {
             background-color: #94a3b8;
             cursor: not-allowed;
        }

        .next-btn {
            background-color: #059669; /* Green for next */
            color: white;
        }
        .next-btn:hover {
            background-color: #047857;
        }

        .add-question-btn {
            background-color: #2563eb;
            color: white;
            margin-top: 15px; /* Space above button */
        }
        .add-question-btn:hover {
            background-color: #1d4ed8;
        }

        .hidden {
            display: none !important; /* Use important to ensure hiding */
        }

        /* --- Error Message Styles --- */
        .error-message {
            padding: 20px;
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            color: #b45309;
            margin-bottom: 20px;
            text-align: center;
        }
        .add-question-prompt {
            text-align: center;
            color: #475569;
        }
        .add-question-prompt p {
            margin-bottom: 10px;
        }


        /* --- Results Styles --- */
        .results-container {
            padding: 30px;
            text-align: center;
        }
        .results-header {
            font-size: 24px;
            margin-bottom: 25px; /* Increased spacing */
            color: #1e293b; /* Darker header */
        }
        .results-score {
            margin: 30px 0 35px 0; /* Increased bottom margin */
        }
        .score-circle {
            width: 140px; /* Larger circle */
            height: 140px; /* Larger circle */
            border-radius: 50%;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column; /* Stack number and '%' sign */
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border: 6px solid #2563eb; /* Thicker border */
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.2); /* Add subtle glow */
        }
        .score-number {
            font-size: 40px; /* Larger score number */
            font-weight: bold;
            color: #1e293b;
            line-height: 1;
        }
         .score-percent-sign { /* Style for the '%' sign */
             font-size: 18px;
             font-weight: 500;
             color: #475569;
             margin-top: 2px;
         }
        .results-details {
            max-width: 400px;
            margin: 0 auto 35px auto; /* Increased bottom margin */
            text-align: left;
            background-color: #f8fafc;
            padding: 25px; /* Increased padding */
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .results-details p {
            margin: 10px 0; /* Increased spacing */
            font-size: 15px;
            color: #334155;
        }
         .results-details p strong {
            color: #1e293b;
            min-width: 120px; /* Align keys */
            display: inline-block;
         }
        .results-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px; /* Increased spacing */
        }
        .review-btn {
            background-color: #16a34a; /* Green for review */
            color: white;
        }
        .review-btn:hover {
            background-color: #15803d;
        }
        .close-btn {
            background-color: #64748b;
            color: white;
        }
        .close-btn:hover {
            background-color: #475569;
        }


        /* --- Review Answers Styles --- */
        .review-container {
            padding: 20px 0; /* Adjust padding */
        }
        .back-btn {
            background-color: #64748b;
            color: white;
            margin-bottom: 25px; /* Increased spacing */
        }
        .back-btn:hover {
            background-color: #475569;
        }
        .question-review {
            padding: 20px; /* Increased padding */
            margin-bottom: 20px; /* Increased spacing */
            border-radius: 8px;
            border: 1px solid #e2e8f0; /* Default border */
            border-left-width: 5px; /* Thicker left border */
            background-color: #fff; /* White background */
        }
        .question-review.correct {
            border-left-color: #16a34a; /* Updated green */
            /* background-color: #f0fdf4; */ /* Optional subtle background */
        }
        .question-review.incorrect {
            border-left-color: #ef4444; /* Updated red */
            /* background-color: #fef2f2; */ /* Optional subtle background */
        }
         .question-review.partial { /* Style for partially correct review */
             border-left-color: #f59e0b; /* Amber */
         }

        .review-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align items vertically */
            margin-bottom: 15px; /* Increased spacing */
            padding-bottom: 10px; /* Add padding below header */
            border-bottom: 1px solid #e2e8f0; /* Separator line */
        }
        .review-question-number {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }
        .review-status {
            font-weight: 600; /* Bolder status */
            font-size: 14px; /* Slightly smaller status */
            padding: 3px 8px; /* Add padding */
            border-radius: 4px; /* Rounded corners */
            text-align: center;
        }
        .question-review.correct .review-status {
            color: #065f46; /* Darker green text */
            background-color: #dcfce7; /* Light green background */
        }
        .question-review.incorrect .review-status {
            color: #991b1b; /* Darker red text */
            background-color: #fee2e2; /* Light red background */
        }
         .question-review.partial .review-status {
             color: #854d0e; /* Dark Amber */
             background-color: #fef9c3; /* Light Amber */
         }

        .review-question-text {
            margin-bottom: 15px;
            font-size: 16px; /* Match question text size */
            color: #334155;
        }

        /* Review specific content styles */
        .review-mc-answer,
        .review-matching-answer,
        .review-ordering-answer {
            background-color: #f8fafc; /* Light background for answer section */
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-top: 15px;
        }

        .review-mc-answer p,
        .review-matching-answer p,
        .review-ordering-answer p {
            margin: 8px 0;
            font-size: 15px;
            color: #475569;
        }
        .review-mc-answer p strong,
        .review-matching-answer p strong,
        .review-ordering-answer p strong {
            color: #1e293b;
            margin-right: 5px;
            display: inline-block;
            min-width: 110px; /* Align labels */
        }
        .review-mc-answer .correct-answer-text,
        .review-matching-answer .correct-answer-text,
        .review-ordering-answer .correct-answer-text {
             color: #059669;
             font-weight: 500;
         }
        .review-mc-answer .user-answer-text.incorrect {
             color: #dc2626;
             text-decoration: line-through; /* Strikethrough incorrect answer */
         }
        .review-mc-answer .user-answer-text.correct {
             color: #059669;
             font-weight: 500;
         }

        /* Review Matching Specific */
        .review-matching-grid {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .review-matching-column {
            flex: 1;
        }
         .review-matching-column div {
             padding: 5px 8px;
             margin-bottom: 5px;
             border-radius: 4px;
             border: 1px solid #e2e8f0;
             background-color: #fff;
         }

        /* Review Ordering Specific */
        .review-ordering-list {
             margin-top: 10px;
        }
        .review-ordering-list-item {
             display: flex;
             align-items: center;
             margin-bottom: 5px;
             padding: 5px 8px;
             border-radius: 4px;
             border: 1px solid #e2e8f0;
             background-color: #fff;
         }

        /* --- END OF styles.css --- */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Interactive Question Bank</h1>
        </div>

        <div class="nav-section">
            <div class="subjects">
                <button class="nav-btn" data-subject="اللغة العربية">
                    <span>📚</span> اللغة العربية
                </button>
                <button class="nav-btn active" data-subject="english">
                    <span>🌎</span> English
                </button>
                <button class="nav-btn" data-subject="التاريخ">
                    <span>📜</span> التاريخ
                </button>
                <button class="nav-btn" data-subject="دين">
                    <span>📖</span> دين
                </button>
            </div>

            <div class="secondary-nav">
                <div class="semester-toggle">
                    <button class="semester-btn active" data-semester="first">First Semester</button>
                    <button class="semester-btn" data-semester="second">Second Semester</button>
                </div>
            </div>
        </div>

        <div id="content">
            <!-- Content will be loaded dynamically by topics.js -->
        </div>

        <div class="question-modal" id="questionModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">×</span>
                <h2 id="modalTitle"></h2>
                <div id="questionContent">
                    <!-- Quiz content (question, options, feedback, buttons) loads here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- START OF topics.js ---

        // Topics data structure for all subjects and semesters
        const topicsData = {
            "english": {
                "first": {
                    "title": "First Semester",
                    "units": [
                        {
                            "title": "Unit 1",
                            "lessons": [
                                {
                                    "title": "Vocabulary & Grammar Basics",
                                    "questions": [
                                        {
                                            "type": "multiple_choice", // Explicit type
                                            "question": "What literary device is used in the phrase 'the curtain of night fell'?",
                                            "options": ["Simile", "Metaphor", "Alliteration", "Hyperbole"],
                                            "answer": "Metaphor"
                                        },
                                        {
                                            "type": "multiple_choice",
                                            "question": "The word 'ambiguous' most closely means:",
                                            "options": ["Clear", "Uncertain", "Definite", "Determined"],
                                            "answer": "Uncertain"
                                        },
                                        {
                                            "type": "ordering", // Ordering Question Example
                                            "question": "Order the following words alphabetically:",
                                            "items": ["Banana", "Apple", "Cherry", "Date"],
                                            "answer": ["Apple", "Banana", "Cherry", "Date"] // Correct sequence
                                        },
                                        {
                                            "type": "matching", // Matching Question Example
                                            "question": "Match the country with its capital city:",
                                            "prompts": ["France", "Japan", "Egypt", "Brazil"], // Left column items
                                            "matches": ["Cairo", "Tokyo", "Paris", "Brasília"], // Right column items (will be shuffled)
                                            "answer": { // Correct pairings: { promptIndex: matchIndex }
                                                "0": 2, // France -> Paris (index 2 in matches)
                                                "1": 1, // Japan -> Tokyo (index 1 in matches)
                                                "2": 0, // Egypt -> Cairo (index 0 in matches)
                                                "3": 3  // Brazil -> Brasília (index 3 in matches)
                                            }
                                        }
                                    ]
                                },
                                {
                                    "title": "Past&Present Tenses&Question Tags",
                                    "questions": [
                                        {
                                            "type": "multiple_choice",
                                            "question": "Choose the correct present tense: 'She _____ to school every day.'",
                                            "options": ["go", "goes", "going", "went"],
                                            "answer": "goes"
                                        },
                                        {
                                            "type": "multiple_choice",
                                            "question": "Which is the correct question tag? 'You're coming to the party, _____?'",
                                            "options": ["aren't you", "don't you", "isn't you", "won't you"],
                                            "answer": "aren't you"
                                        }
                                    ]
                                }
                            ]
                        },
                         { // Keep other units for structure, removing questions for brevity
                            "title": "Unit 2",
                            "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Future Forms", "questions": [] } ]
                        },
                        {
                            "title": "Unit 3",
                            "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Habits&Clauses", "questions": [] } ]
                        },
                        {
                            "title": "Unit 4",
                            "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Narration&Inversion", "questions": [] } ]
                        }
                    ]
                },
                "second": { // Keep structure, empty questions for brevity
                    "title": "Second Semester",
                    "units": [
                        { "title": "Unit 1", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modal&Related&Articles", "questions": [] } ] },
                        { "title": "Unit 2", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Reported Speach&Reporting Verbs", "questions": [] } ] },
                        { "title": "Unit 3", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "The Passive", "questions": [] } ] },
                        { "title": "Unit 4", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Conditionals&Modals", "questions": [] } ] },
                        { "title": "Unit 5", "lessons": [ { "title": "Reading and Vocabulary", "questions": [] }, { "title": "Modals&Clauses", "questions": [] } ] }
                    ]
                }
            },
            "اللغة العربية": { // Keeping structure, empty questions
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الوحدة الأولى", "lessons": [ { "title": "من القيم الإنسانية في القرآن", "questions": [] }, { "title": "اسلوب الطلب وجوابه المجزوم والتشبيه المفرد", "questions": [] } ] },
                        { "title": "الوحدة الثانية", "lessons": [ { "title": "عمانيات", "questions": [] }, { "title": "صور الفاعل والتشبيه التمثيلي", "questions": [] } ] },
                        { "title": "الوحدة الثالثة", "lessons": [ { "title": "الزهايمر-الخرف المبكر", "questions": [] }, { "title": "صور المبتدأ والخبر والجملة الخبرية والإنشائية", "questions": [] } ] },
                        { "title": "الوحدة الرابعة", "lessons": [ { "title": "الإعلام ومشروع النهوض باللغة العربية", "questions": [] }, { "title": "المفعول معه والأمر", "questions": [] } ] },
                        { "title": "الوحدة الخامسة", "lessons": [ { "title": "التعليم التقني بوابة المستقبل في عالم متغير", "questions": [] }, { "title": "انواع ما والإستفهام", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "في فتح القدس", "questions": [] }, { "title": "معاني حروف الجر والتشخيص", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "قصة-حفنة تمر", "questions": [] }, { "title": "اسم الفاعل واسم المفعول والطباق والمقابلة", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "شاعرات من بلدي", "questions": [] }, { "title": "اسم الزمان واسم المكان وجمع التكسير (القلة والكثرة)", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "من مقامات بديع الزمان الهمذاني", "questions": [] }, { "title": "مصدر المرة ومصدر الهيئة والبحر المتدارك", "questions": [] } ] },
                         { "title": "الوحدة الخامسة", "lessons": [ { "title": "الذكاء الاصطناعي-عالم جديد", "questions": [] }, { "title": "اسم الآلة", "questions": [] } ] }
                    ]
                }
            },
             "التاريخ": { // Keeping structure, empty questions
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                        { "title": "الأردن في العصور القديمة", "lessons": [ { "title": "الأردن في العصور الحجرية", "questions": [] }, { "title": "الأردن في العصر الحديدي", "questions": [] }, { "title": "مملكة الأنباط", "questions": [] }, { "title": "مظاهر الحضارة اليونانية في الأردن", "questions": [] }, { "title": "مظاهر الحضارة الرومانية-البيزنطية في الأردن", "questions": [] } ] },
                        { "title": "الأردن في صدر الإسلام", "lessons": [ { "title": "الأردن في صدر الإسلام", "questions": [] }, { "title": "الأردن في العصر الأموي", "questions": [] }, { "title": "الأردن في العصر العباسي", "questions": [] }, { "title": "الأردن خلال حملات الفرنجة", "questions": [] }, { "title": "الأردن في العصر الأيوبي", "questions": [] }, { "title": "الأردن في العصر المملوكي", "questions": [] } ] },
                        { "title": "الأردن في العصر الحديث", "lessons": [ { "title": "الأوضاع السياسية والإدارية في الأردن في العهد العثماني", "questions": [] }, { "title": "الأوضاع الإجتماعية والإقتصادية الأردن في العهد العثماني", "questions": [] }, { "title": "الثورة العربية الكبرى", "questions": [] }, { "title": "الأردن في عهد المملكة العربية السورية والحكومات المحلية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                     "units": [
                        { "title": "الحياة السياسية في الأردن", "lessons": [ { "title": "تأسيس الإمارة الأردنية", "questions": [] }, { "title": "استقلال المملكة الأردنية الهاشمية", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1948-1957)", "questions": [] }, { "title": "تطور الحياة السياسية في الأردن بين عامي (1958-1999)", "questions": [] }, { "title": "الحياة السياسية في الأردن منذ 1999", "questions": [] }, { "title": "الأردن والعلاقات العربية والدولية", "questions": [] }, { "title": "القوات المسلحة الأردنية - الجيش العربي", "questions": [] }, { "title": "الأجهزة الأمنية الأردنية", "questions": [] } ] },
                        { "title": "الحياة الاقتصادية في الأردن", "lessons": [ { "title": "الحياة الاقتصادية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1951-1967)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن بين عامي (1968-1999)", "questions": [] }, { "title": "الحياة الاقتصادية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "الحياة الاجتماعية في الأردن", "lessons": [ { "title": "الحياة الاجتماعية في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن بين عامي (1951-1999)", "questions": [] }, { "title": "الحياة الاجتماعية في الأردن منذ عام 1999", "questions": [] } ] },
                        { "title": "التعليم والثقافة في الأردن", "lessons": [ { "title": "التعليم العام في الأردن بين عامي (1921-1950)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1951-1987)", "questions": [] }, { "title": "التعليم العام في الأردن بين عامي (1988-2024)", "questions": [] }, { "title": "التعليم العالي والبحث العلمي في الأردن منذ عام 1951", "questions": [] }, { "title": "الحياة الثقافية في الأردن في عهد الإمارة", "questions": [] }, { "title": "الحياة الثقافية في الأردن منذ عام 1946", "questions": [] } ] },
                        { "title": "الأردن والقضية الفلسطينية", "lessons": [ { "title": "موقف الأردن من القضية الفلسطينية بين عامي (1916-1951)", "questions": [] }, { "title": "موقف الأردن من القضية الفلسطينية منذ عام 1951", "questions": [] }, { "title": "الوصاية والإعمار الهاشمي للمقدسات الدينية في القدس", "questions": [] } ] }
                    ]
                }
            },
             "دين": { // Keeping structure, empty questions
                "first": {
                    "title": "الفصل الأول",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة آل عمران (102-105)", "questions": [] }, { "title": "حديث اتقاء الشبهات", "questions": [] }, { "title": "من صور الضلال", "questions": [] }, { "title": "كرامة الإنسان في الشريعة", "questions": [] }, { "title": "الزواج-مشروعيته ومقدماته", "questions": [] }, { "title": "الجهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "جهود علماء المسلمين في خدمة القرآن", "questions": [] }, { "title": "العزيمة والرخصة", "questions": [] }, { "title": "معركة مؤتة (8 هجري)", "questions": [] }, { "title": "المحرمات من النساء", "questions": [] }, { "title": "التعايش الإنساني", "questions": [] }, { "title": "الحقوق الإجتماعية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة آل عمران (169-174)", "questions": [] }, { "title": "حديث - رضا الله تعالى", "questions": [] }, { "title": "فتح مكة (8 هجري)", "questions": [] }, { "title": "من خصائص الشريعة - الإيجابية", "questions": [] }, { "title": "شروط صحة عقد الزواج", "questions": [] }, { "title": "الحقوق المالية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "سورة الروم (21-24)", "questions": [] }, { "title": "مكانة السنة النبوية في التشريع", "questions": [] }, { "title": "مراعاة الأعراف في الشريعة", "questions": [] }, { "title": "حقوق الزوجين", "questions": [] }, { "title": "تنظيم النسل وتحديده", "questions": [] }, { "title": "الأمن الغذائي في الإسلام", "questions": [] }, { "title": "الإسلام والوحدة الوطنية", "questions": [] } ] }
                    ]
                },
                "second": {
                    "title": "الفصل الثاني",
                    "units": [
                         { "title": "الوحدة الأولى", "lessons": [ { "title": "سورة البقرة (284-286)", "questions": [] }, { "title": "دلائل وجود الله تعالى", "questions": [] }, { "title": "إعجاز القرآن الكريم", "questions": [] }, { "title": "الأمر بالمعروف والنهي عن المنكر", "questions": [] }, { "title": "اليوم الآخر - احداثه وآثار الإيمان به", "questions": [] }, { "title": "الإجتهاد في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثانية", "lessons": [ { "title": "سورة الأعراف (31-34)", "questions": [] }, { "title": "مراعاة المصالح في الشريعة", "questions": [] }, { "title": "جهود علماء المسلمين في الحفاظ على السنة النبوية", "questions": [] }, { "title": "حديث - منهج الإسلام في الحياة", "questions": [] }, { "title": "رسائل النبي الى الملوك والزعماء في عصره", "questions": [] }, { "title": "يوم تبوك (9 هجري)", "questions": [] }, { "title": "الحقوق السياسية للمرأة في الإسلام", "questions": [] } ] },
                         { "title": "الوحدة الثالثة", "lessons": [ { "title": "سورة الفرقان (63-77)", "questions": [] }, { "title": "الطلاق", "questions": [] }, { "title": "العدة", "questions": [] }, { "title": "الوصية في الشريعة", "questions": [] }, { "title": "الميراث في الشريعة", "questions": [] }, { "title": "من خصائص الشريعة - الوسطية", "questions": [] }, { "title": "مجالات الوقف ودورها في التنمية", "questions": [] } ] },
                         { "title": "الوحدة الرابعة", "lessons": [ { "title": "حديث - مفهوم الإفلاس بين الدنيا والآخرة", "questions": [] }, { "title": "مقاصد الشريعة", "questions": [] }, { "title": "منهج الإسلام في مكافحة الجريمة", "questions": [] }, { "title": "من وصايا النبي في حجة الوداع", "questions": [] }, { "title": "المسؤولية المجتمعية في الإسلام", "questions": [] }, { "title": "حقوق الإنسان بين الإسلام والإعلان العالمي لحقوق الإنسان", "questions": [] } ] }
                    ]
                }
            }
        };

        // Function to generate HTML for a semester's content
        function generateSemesterContent(subject, semester) {
            if (!topicsData[subject] || !topicsData[subject][semester]) {
                console.error(`Data missing for subject: ${subject}, semester: ${semester}`);
                return `<div id="${subject}-${semester}" class="semester-content"><p>Content not available.</p></div>`;
            }

            const semesterData = topicsData[subject][semester];
            let html = `
                <div id="${subject}-${semester}" class="semester-content">
                    <div class="unit-container">
                        <div class="unit-title">${semesterData.title}</div>
            `;

            if (semesterData.units && Array.isArray(semesterData.units)) {
                semesterData.units.forEach(unit => {
                    if (unit && unit.title) {
                        html += `<div class="section">
                                <div class="section-title">${unit.title}</div>`;

                        if (unit.lessons && Array.isArray(unit.lessons)) {
                            unit.lessons.forEach(lesson => {
                                if (lesson && lesson.title) {
                                    html += `<div class="section-content" data-subject="${subject}" data-unit="${unit.title}" data-lesson="${lesson.title}">${lesson.title}</div>`;
                                } else {
                                     console.warn(`Invalid lesson structure in unit: ${unit.title}, subject: ${subject}, semester: ${semester}`, lesson);
                                }
                            });
                        } else {
                            console.warn(`No lessons array found for unit: ${unit.title}, subject: ${subject}, semester: ${semester}`);
                        }
                        html += `</div> <!-- .section -->`;
                    } else {
                         console.warn(`Invalid unit structure in subject: ${subject}, semester: ${semester}`, unit);
                    }
                });
            } else {
                 console.warn(`No units array found for subject: ${subject}, semester: ${semester}`);
            }
            html += `   </div> <!-- .unit-container -->
                </div> <!-- .semester-content -->`;
            return html;
        }

        // Generate content for all subjects and semesters
        function generateAllContent() {
            let contentHTML = '';
            const contentDiv = document.getElementById('content');
            if (!contentDiv) {
                console.error("Content container element not found!");
                return;
            }
            for (const subject in topicsData) {
                if (topicsData.hasOwnProperty(subject)) {
                    for (const semester in topicsData[subject]) {
                         if (topicsData[subject].hasOwnProperty(semester)) {
                            contentHTML += generateSemesterContent(subject, semester);
                         }
                    }
                }
            }
            contentDiv.innerHTML = contentHTML;
        }

        // Initialize content when the page loads
        document.addEventListener('DOMContentLoaded', generateAllContent);

        // --- END OF topics.js ---
    </script>

    <script>
        // --- START OF questions.js ---

        // Global quiz state
        let quizState = {
            currentQuestionIndex: 0,
            correctAnswers: 0, // Tracks fully correct answers
            totalQuestions: 0,
            startTime: null,
            endTime: null,
            selectedAnswers: [], // Stores user's complete answer structure for each question
            questions: [],
            subject: '',
            unit: '',
            lesson: '',
            // State specific to matching question interaction
            matchingState: {
                selectedPromptElement: null,
                userPairs: {}, // Stores { promptIndex: matchIndex } as user makes them
            }
        };

        // --- Utility Functions ---
        // Fisher-Yates Shuffle
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded', function() {
            // Subject button listeners
            document.querySelectorAll('.nav-btn[data-subject]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.nav-btn[data-subject]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });

            // Semester button listeners
            document.querySelectorAll('.semester-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    updateContent();
                });
            });

             // Modal close button listener (alternative to inline onclick)
             const closeModalButton = document.getElementById('questionModal')?.querySelector('.close-modal');
             if (closeModalButton) {
                 closeModalButton.addEventListener('click', closeModal);
             }


            // Initial content load
            updateContent();
        });

        // --- Core Functions ---

        // Update main content view
        function updateContent() {
            const activeSubjectBtn = document.querySelector('.nav-btn[data-subject].active');
            const activeSemesterBtn = document.querySelector('.semester-btn.active');
            if (!activeSubjectBtn || !activeSemesterBtn) return;

            const activeSubject = activeSubjectBtn.dataset.subject;
            const activeSemester = activeSemesterBtn.dataset.semester;

            document.querySelectorAll('.semester-content').forEach(content => content.classList.remove('active'));

            const contentId = `${activeSubject}-${activeSemester}`;
            const contentElement = document.getElementById(contentId);

            if (contentElement) {
                contentElement.classList.add('active');
                // Re-attach listeners using clone/replace
                contentElement.querySelectorAll('.section-content').forEach(section => {
                    const newSection = section.cloneNode(true);
                    section.parentNode.replaceChild(newSection, section);
                    newSection.addEventListener('click', function() {
                        handleSectionClick(this.dataset.subject, this.dataset.unit, this.dataset.lesson);
                    });
                });
            } else {
                 console.warn(`Content element with ID "${contentId}" not found.`);
                 const contentArea = document.getElementById('content');
                 if(contentArea){
                    contentArea.innerHTML = `<div class="unit-container"><p style="padding: 20px; text-align: center; color: #dc2626;">Error: Content for ${activeSubject} - ${activeSemester} could not be loaded.</p></div>`;
                 }
            }
        }

        // Handle clicking a lesson
        function handleSectionClick(subject, unit, lesson) {
             if (!subject || !unit || !lesson) {
                 console.error("Missing data attributes on clicked section.");
                 showError("Unknown", "Unknown", "Unknown", "Error identifying the selected topic.");
                 return;
             }
            console.log(`Clicked: Subject=${subject}, Unit=${unit}, Lesson=${lesson}`);
            try {
                const questions = getQuestions(subject, unit, lesson);
                if (questions && questions.length > 0) {
                    startQuiz(subject, unit, lesson, questions);
                } else {
                    console.log(`No questions found for ${subject} - ${unit} - ${lesson}`);
                    showError(subject, unit, lesson);
                }
            } catch (error) {
                console.error("Error handling section click:", error);
                showError(subject, unit, lesson, "An error occurred while loading questions.");
            }
        }

        // Start a new quiz
        function startQuiz(subject, unit, lesson, questions) {
            quizState = {
                ...quizState, // Keep potentially useful parts of old state if needed? No, fresh start.
                currentQuestionIndex: 0,
                correctAnswers: 0,
                totalQuestions: questions.length,
                startTime: new Date(),
                endTime: null,
                selectedAnswers: new Array(questions.length).fill(null),
                questions: questions,
                subject: subject,
                unit: unit,
                lesson: lesson,
                matchingState: { selectedPromptElement: null, userPairs: {} } // Reset matching state too
            };
            displayQuestion();
            const modal = document.getElementById('questionModal');
            modal.style.display = 'block';
            modal.scrollTop = 0;
        }

        // Display the current question based on its type
        function displayQuestion() {
            const modalTitle = document.getElementById('modalTitle');
            const questionContent = document.getElementById('questionContent');
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex];

            if (!currentQuestion) {
                console.error("Error: Invalid question index.");
                displayResults(); return;
            }

            modalTitle.textContent = `${quizState.lesson}`;
            questionContent.innerHTML = ''; // Clear previous

            const questionContainer = document.createElement('div');
            questionContainer.className = 'question-container';

            // Progress
            const progressText = document.createElement('div');
            progressText.className = 'question-progress';
            progressText.textContent = `Question ${quizState.currentQuestionIndex + 1} of ${quizState.totalQuestions}`;
            questionContainer.appendChild(progressText);

            // Question Text
            const questionText = document.createElement('p');
            questionText.className = 'question-text';
            questionText.innerHTML = `<strong>Q:</strong> ${currentQuestion.question}`;
            questionContainer.appendChild(questionText);

            // Type-specific rendering
            const typeWrapper = document.createElement('div');
            typeWrapper.className = 'question-type-wrapper'; // Wrapper for type-specific content
            switch (currentQuestion.type) {
                case "matching":
                    renderMatching(currentQuestion, typeWrapper);
                    break;
                case "ordering":
                    renderOrdering(currentQuestion, typeWrapper);
                    break;
                case "multiple_choice":
                default: // Default to multiple choice
                    renderMultipleChoice(currentQuestion, typeWrapper);
                    break;
            }
            questionContainer.appendChild(typeWrapper);


            // Feedback Area (Initially Hidden)
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback-container hidden';
            feedbackDiv.id = 'feedback';
            questionContainer.appendChild(feedbackDiv);

            // Buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'quiz-buttons';
            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn submit-btn';
            submitBtn.id = 'submit-btn';
            submitBtn.textContent = 'Submit Answer';
            submitBtn.onclick = checkAnswer;
             // Disable initially only for MC, enable later on selection
             submitBtn.disabled = currentQuestion.type === 'multiple_choice';

            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn next-btn hidden';
            nextBtn.id = 'next-btn';
            nextBtn.textContent = quizState.currentQuestionIndex === quizState.totalQuestions - 1 ? 'See Results' : 'Next Question';
            nextBtn.onclick = nextQuestion;

            buttonsDiv.appendChild(submitBtn);
            buttonsDiv.appendChild(nextBtn);
            questionContainer.appendChild(buttonsDiv);

            questionContent.appendChild(questionContainer);
            document.getElementById('questionModal').querySelector('.modal-content').scrollTop = 0; // Scroll content within modal
        }

        // --- Rendering Functions for Question Types ---

        function renderMultipleChoice(question, container) {
            if (!question.options || !Array.isArray(question.options)) {
                container.textContent = 'Error: Options not available for this question.';
                return;
            }
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options-container';
            optionsDiv.id = 'options-list';

            question.options.forEach((option, index) => {
                const optionId = `option-${index}`;
                const optionLabel = document.createElement('label');
                optionLabel.className = 'option-label';
                optionLabel.htmlFor = optionId;

                const optionInput = document.createElement('input');
                optionInput.type = 'radio';
                optionInput.name = 'question-option';
                optionInput.value = index;
                optionInput.id = optionId;
                optionInput.className = 'option-input';
                 // Add event listener to enable submit button
                 optionInput.addEventListener('change', () => {
                     document.getElementById('submit-btn').disabled = false;
                 });


                const optionText = document.createElement('span');
                optionText.className = 'option-text';
                optionText.textContent = option;

                optionLabel.appendChild(optionInput);
                optionLabel.appendChild(optionText);
                optionsDiv.appendChild(optionLabel);
            });
            container.appendChild(optionsDiv);
        }

        function renderMatching(question, container) {
            if (!question.prompts || !question.matches || !Array.isArray(question.prompts) || !Array.isArray(question.matches) || question.prompts.length !== question.matches.length) {
                container.textContent = 'Error: Invalid matching question data.';
                return;
            }

            quizState.matchingState.userPairs = {}; // Reset user pairs for this question

             const instructions = document.createElement('p');
             instructions.className = 'matching-instructions';
             instructions.textContent = 'Click an item on the left, then click its matching item on the right.';
             container.appendChild(instructions);

            const matchingContainer = document.createElement('div');
            matchingContainer.className = 'matching-container';

            const promptsColumn = document.createElement('div');
            promptsColumn.className = 'matching-column';
            promptsColumn.id = 'prompts-column';
             const promptsHeader = document.createElement('h4');
             promptsHeader.textContent = "Items";
             promptsColumn.appendChild(promptsHeader);


            const matchesColumn = document.createElement('div');
            matchesColumn.className = 'matching-column';
            matchesColumn.id = 'matches-column';
             const matchesHeader = document.createElement('h4');
             matchesHeader.textContent = "Matches";
             matchesColumn.appendChild(matchesHeader);


            // Create and shuffle match items *with original index*
            const shuffledMatches = question.matches
                .map((matchText, originalIndex) => ({ text: matchText, originalIndex: originalIndex }))
                .sort(() => Math.random() - 0.5); // Simple shuffle


            question.prompts.forEach((promptText, index) => {
                const promptItem = document.createElement('div');
                promptItem.className = 'matching-item prompt-item';
                promptItem.textContent = promptText;
                promptItem.dataset.index = index; // Store original index
                promptItem.addEventListener('click', handleMatchingClick);
                promptsColumn.appendChild(promptItem);
            });

            shuffledMatches.forEach((matchObj) => {
                 const matchItem = document.createElement('div');
                 matchItem.className = 'matching-item match-item';
                 matchItem.textContent = matchObj.text;
                 matchItem.dataset.index = matchObj.originalIndex; // Store original index
                 matchItem.addEventListener('click', handleMatchingClick);
                 matchesColumn.appendChild(matchItem);
            });


            matchingContainer.appendChild(promptsColumn);
            matchingContainer.appendChild(matchesColumn);
            container.appendChild(matchingContainer);
        }

         function renderOrdering(question, container) {
            if (!question.items || !Array.isArray(question.items) || question.items.length === 0) {
                container.textContent = 'Error: Invalid ordering question data.';
                return;
            }

             const instructions = document.createElement('p');
             instructions.className = 'ordering-instructions';
             instructions.textContent = `Select the correct order number (1-${question.items.length}) for each item.`;
             container.appendChild(instructions);


            const orderingContainer = document.createElement('div');
            orderingContainer.className = 'ordering-container';
            orderingContainer.id = 'ordering-list';

            const numItems = question.items.length;

            question.items.forEach((itemText, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ordering-item';
                itemDiv.dataset.originalIndex = index; // Store original index if needed

                const select = document.createElement('select');
                select.className = 'ordering-select';
                select.dataset.itemIndex = index; // Link select to original item index

                // Add default blank option
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-";
                defaultOption.selected = true;
                defaultOption.disabled = true; // Cannot re-select the placeholder
                select.appendChild(defaultOption);


                // Add number options 1 to N
                for (let i = 1; i <= numItems; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }

                const textSpan = document.createElement('span');
                textSpan.className = 'ordering-text';
                textSpan.textContent = itemText;

                itemDiv.appendChild(select);
                itemDiv.appendChild(textSpan);
                orderingContainer.appendChild(itemDiv);
            });

            container.appendChild(orderingContainer);
        }


        // --- Interaction Handlers ---

        function handleMatchingClick(event) {
            const clickedItem = event.target;
             // Ignore clicks if already matched or not a matching item
             if (clickedItem.classList.contains('matched') || !clickedItem.classList.contains('matching-item')) {
                 return;
             }

            const isPrompt = clickedItem.classList.contains('prompt-item');
            let currentSelection = quizState.matchingState.selectedPromptElement;

            if (isPrompt) {
                // If clicking a prompt:
                if (currentSelection) {
                    currentSelection.classList.remove('selected'); // Deselect old prompt
                }
                if (currentSelection !== clickedItem) {
                    clickedItem.classList.add('selected'); // Select new prompt
                    quizState.matchingState.selectedPromptElement = clickedItem;
                } else {
                    quizState.matchingState.selectedPromptElement = null; // Deselect if clicking the same prompt
                }
            } else {
                // If clicking a match:
                if (currentSelection) {
                    // A prompt is selected, make the pair
                    const promptIndex = currentSelection.dataset.index;
                    const matchIndex = clickedItem.dataset.index;

                     // Store the user's pair
                    quizState.matchingState.userPairs[promptIndex] = parseInt(matchIndex, 10);


                    // Visually mark as matched and disable
                    currentSelection.classList.remove('selected');
                    currentSelection.classList.add('matched');
                    clickedItem.classList.add('matched');
                    currentSelection.style.cursor = 'default';
                    clickedItem.style.cursor = 'default';

                    quizState.matchingState.selectedPromptElement = null; // Reset selection

                     // Enable submit button if all prompts are matched
                    const totalPrompts = document.querySelectorAll('.prompt-item').length;
                     const matchedPrompts = document.querySelectorAll('.prompt-item.matched').length;
                     if (matchedPrompts === totalPrompts) {
                         document.getElementById('submit-btn').disabled = false;
                     }
                }
                 // Else: No prompt selected, do nothing when clicking a match item.
            }
        }


        // --- Answer Checking Functions ---

        function checkAnswer() {
            const currentQuestion = quizState.questions[quizState.currentQuestionIndex];
            let result = { isCorrect: false, feedback: '', userResponse: null, scoreIncrement: 0 }; // Store detailed result

             try {
                 switch (currentQuestion.type) {
                    case "matching":
                        result = checkMatching(currentQuestion);
                        break;
                    case "ordering":
                        result = checkOrdering(currentQuestion);
                        break;
                    case "multiple_choice":
                    default:
                        result = checkMultipleChoice(currentQuestion);
                        break;
                }
             } catch (error) {
                 console.error("Error during answer checking:", error);
                 result = { isCorrect: false, feedback: '<div class="incorrect-feedback">An error occurred while checking your answer.</div>', userResponse: null, scoreIncrement: 0 };
             }


            // Store the user's response structure for review
            quizState.selectedAnswers[quizState.currentQuestionIndex] = result.userResponse;

             // Only increment score for fully correct answers
            if (result.isCorrect) {
                quizState.correctAnswers += result.scoreIncrement; // Should be 1 for full correct
            }


            // Show feedback
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = result.feedback;
            feedbackDiv.classList.remove('hidden');

            // Disable inputs, hide submit, show next
             disableInputs(); // Helper function to disable all types
            document.getElementById('submit-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        function checkMultipleChoice(question) {
            const selectedOptionInput = document.querySelector('input[name="question-option"]:checked');
            if (!selectedOptionInput) {
                return { isCorrect: false, feedback: '<div class="incorrect-feedback">Please select an answer.</div>', userResponse: null, scoreIncrement: 0 };
            }

            const selectedIndex = parseInt(selectedOptionInput.value, 10);
            const correctOptionText = question.answer;
            const selectedOptionText = question.options[selectedIndex];
            const isCorrect = selectedOptionText === correctOptionText;

            // Highlight options
            document.querySelectorAll('.option-label').forEach((label, index) => {
                 const input = label.querySelector('input');
                 if (question.options[index] === correctOptionText) {
                     label.classList.add('correct-option');
                 }
                 if (input && parseInt(input.value, 10) === selectedIndex && !isCorrect) {
                    label.classList.add('incorrect-option');
                 }
             });


            const feedback = isCorrect
                ? '<div class="correct-feedback">Correct! ✓</div>'
                : `<div class="incorrect-feedback">Incorrect. <span>The correct answer is: ${correctOptionText}</span></div>`;

            return {
                isCorrect: isCorrect,
                feedback: feedback,
                userResponse: selectedIndex, // Store index for review
                scoreIncrement: isCorrect ? 1 : 0
            };
        }

         function checkMatching(question) {
             const userPairs = quizState.matchingState.userPairs;
             const correctPairs = question.answer;
             const totalPairs = Object.keys(correctPairs).length;
             let correctCount = 0;

             // Compare user pairs with correct pairs
             for (const promptIndex in correctPairs) {
                 if (userPairs.hasOwnProperty(promptIndex) && userPairs[promptIndex] === correctPairs[promptIndex]) {
                     correctCount++;
                 }
             }

             const isFullyCorrect = correctCount === totalPairs;
             let feedback = '';

             if (isFullyCorrect) {
                 feedback = `<div class="correct-feedback">Correct! All pairs matched. ✓ (${correctCount}/${totalPairs})</div>`;
             } else if (correctCount > 0) {
                 feedback = `<div class="partial-feedback">Partially Correct. You matched ${correctCount} out of ${totalPairs} pairs correctly.</div>`;
                 // Could add more detail here showing which were wrong if needed
             } else {
                 feedback = `<div class="incorrect-feedback">Incorrect. No pairs matched correctly. (0/${totalPairs})</div>`;
                  // Could add more detail here showing correct pairs
             }

             // Simple visual feedback on items (could be enhanced)
              document.querySelectorAll('.matching-item.matched').forEach(item => {
                  const isPrompt = item.classList.contains('prompt-item');
                  const index = item.dataset.index;
                  let isPairCorrect = false;
                  if(isPrompt && userPairs.hasOwnProperty(index) && userPairs[index] === correctPairs[index]) {
                      isPairCorrect = true;
                  } else if (!isPrompt) {
                      // Find which prompt this match was paired with by the user
                      const promptIdx = Object.keys(userPairs).find(pIdx => userPairs[pIdx] === parseInt(index));
                      if(promptIdx && userPairs[promptIdx] === correctPairs[promptIdx]){
                         isPairCorrect = true;
                      }
                  }
                 // Apply basic correct/incorrect styling (could conflict with 'matched' gray, might need refinement)
                  // item.classList.add(isPairCorrect ? 'review-matched-pair-correct' : 'review-matched-pair-incorrect');
              });


             return {
                 isCorrect: isFullyCorrect, // Only fully correct counts towards score
                 feedback: feedback,
                 userResponse: userPairs, // Store the user's pairs object
                 scoreIncrement: isFullyCorrect ? 1 : 0
             };
         }

        function checkOrdering(question) {
            const numItems = question.items.length;
            const userOrderMap = {}; // { originalIndex: selectedOrderNumber }
            const selectedNumbers = new Set();
            let isValid = true;
            let duplicateNumber = false;

            document.querySelectorAll('.ordering-select').forEach(select => {
                const itemIndex = parseInt(select.dataset.itemIndex, 10);
                const selectedValue = select.value;

                if (selectedValue === "") {
                    isValid = false; // Must select a number for all items
                } else {
                    const orderNum = parseInt(selectedValue, 10);
                    userOrderMap[itemIndex] = orderNum;
                    if (selectedNumbers.has(orderNum)) {
                        duplicateNumber = true; // Found duplicate selection
                    }
                    selectedNumbers.add(orderNum);
                }
            });

            if (!isValid) {
                return { isCorrect: false, feedback: '<div class="incorrect-feedback">Please select an order number for every item.</div>', userResponse: null, scoreIncrement: 0 };
            }
            if (duplicateNumber || selectedNumbers.size !== numItems) {
                 return { isCorrect: false, feedback: `<div class="incorrect-feedback">Please use each order number (1-${numItems}) exactly once.</div>`, userResponse: null, scoreIncrement: 0 };
            }

            // Construct user's ordered array of *item strings*
            const userOrderedItems = new Array(numItems);
            for (const originalIndex in userOrderMap) {
                const itemText = question.items[originalIndex];
                const userPosition = userOrderMap[originalIndex] - 1; // Convert 1-based order to 0-based index
                userOrderedItems[userPosition] = itemText;
            }

            const correctOrder = question.answer; // Assumes answer is array of strings in correct order
            const isCorrect = JSON.stringify(userOrderedItems) === JSON.stringify(correctOrder); // Simple array comparison

             let feedback = '';
             if (isCorrect) {
                 feedback = `<div class="correct-feedback">Correct! The order is perfect. ✓</div>`;
             } else {
                 feedback = `<div class="incorrect-feedback">Incorrect. The order is not quite right. <span>Correct order: ${correctOrder.join(', ')}</span></div>`;
             }

             // Add visual feedback to selects (optional)
              document.querySelectorAll('.ordering-item').forEach(itemDiv => {
                  const originalIndex = parseInt(itemDiv.dataset.originalIndex, 10);
                  const userNum = userOrderMap[originalIndex]; // User's chosen number (1-based)
                  const correctNum = correctOrder.indexOf(question.items[originalIndex]) + 1; // Correct number (1-based)
                  const select = itemDiv.querySelector('select');
                  if (select) {
                      select.style.borderColor = (userNum === correctNum) ? '#16a34a' : '#ef4444';
                      select.style.borderWidth = '2px';
                  }
              });


            return {
                isCorrect: isCorrect,
                feedback: feedback,
                userResponse: userOrderedItems, // Store the user's ordered array
                scoreIncrement: isCorrect ? 1 : 0
            };
        }

        // Helper to disable inputs after submission
        function disableInputs() {
            // Disable radio buttons
            document.querySelectorAll('input[name="question-option"]').forEach(input => {
                 input.disabled = true;
                 const label = input.closest('.option-label');
                 if (label) label.style.cursor = 'default';
             });
             // Disable matching items
            document.querySelectorAll('.matching-item').forEach(item => {
                 item.style.pointerEvents = 'none'; // Prevent further clicks
                 item.style.cursor = 'default';
             });
             // Disable ordering selects
            document.querySelectorAll('.ordering-select').forEach(select => {
                 select.disabled = true;
             });
        }


        // --- Navigation and Results ---

        function nextQuestion() {
            quizState.currentQuestionIndex++;
            if (quizState.currentQuestionIndex < quizState.totalQuestions) {
                displayQuestion();
            } else {
                quizState.endTime = new Date();
                displayResults();
            }
        }

        function displayResults() {
            const modalTitle = document.getElementById('modalTitle');
            const questionContent = document.getElementById('questionContent');
            modalTitle.textContent = 'Quiz Results';

            const timeTaken = quizState.endTime && quizState.startTime ? (quizState.endTime - quizState.startTime) / 1000 : 0;
            const minutes = Math.floor(timeTaken / 60);
            const seconds = Math.floor(timeTaken % 60);
            const timeString = timeTaken > 0 ? `${minutes}m ${seconds}s` : 'N/A';
            const scorePercentage = quizState.totalQuestions > 0 ? (quizState.correctAnswers / quizState.totalQuestions) * 100 : 0;

            let performanceMessage = '';
            if (quizState.totalQuestions === 0) performanceMessage = 'No questions were answered.';
            else if (scorePercentage >= 90) performanceMessage = 'Excellent job! 🎉';
            else if (scorePercentage >= 70) performanceMessage = 'Good work! 👍';
            else if (scorePercentage >= 50) performanceMessage = 'Not bad. Keep practicing! 💪';
            else performanceMessage = 'You might need more study time. 📚';

            questionContent.innerHTML = '';
            const resultsDiv = document.createElement('div');
            resultsDiv.className = 'results-container';
            resultsDiv.innerHTML = `
                <h2 class="results-header">${performanceMessage}</h2>
                <div class="results-score">
                    <div class="score-circle">
                        <span class="score-number">${scorePercentage.toFixed(0)}</span>
                        <span class="score-percent-sign">%</span>
                    </div>
                </div>
                <div class="results-details">
                    <p><strong>Subject:</strong> ${quizState.subject || 'N/A'}</p>
                    <p><strong>Unit:</strong> ${quizState.unit || 'N/A'}</p>
                    <p><strong>Lesson:</strong> ${quizState.lesson || 'N/A'}</p>
                    <p><strong>Correct Answers:</strong> ${quizState.correctAnswers} out of ${quizState.totalQuestions}</p>
                    <p><strong>Time Taken:</strong> ${timeString}</p>
                </div>
                <div class="results-actions">
                    ${quizState.totalQuestions > 0 ? '<button id="review-btn" class="btn review-btn">Review Answers</button>' : ''}
                    <button class="btn close-btn" onclick="closeModal()">Close</button>
                </div>`;
            questionContent.appendChild(resultsDiv);

             const modalContentDiv = document.getElementById('questionModal')?.querySelector('.modal-content');
            if(modalContentDiv) modalContentDiv.scrollTop = 0;

            const reviewBtn = document.getElementById('review-btn');
            if (reviewBtn) reviewBtn.addEventListener('click', reviewAnswers);
        }

        // --- Answer Review Functions ---

        function reviewAnswers() {
            const modalTitle = document.getElementById('modalTitle');
            const questionContent = document.getElementById('questionContent');
            modalTitle.textContent = 'Review Answers';

            questionContent.innerHTML = '';
            const reviewDiv = document.createElement('div');
            reviewDiv.className = 'review-container';

            const backBtn = document.createElement('button');
            backBtn.className = 'btn back-btn';
            backBtn.textContent = '← Back to Results';
            backBtn.addEventListener('click', displayResults);
            reviewDiv.appendChild(backBtn);

            quizState.questions.forEach((question, index) => {
                 const questionReview = document.createElement('div');
                 const userAnswer = quizState.selectedAnswers[index];
                 // Determine correctness status for styling the review box
                 // This needs refinement for partial credit if you want visual distinction
                 let correctnessClass = '';
                 let statusText = '';

                  // Recalculate correctness based on stored answer for review display
                  let reviewCorrectness = false;
                  try {
                      switch (question.type) {
                          case "matching":
                              const correctPairs = question.answer;
                              const totalPairs = Object.keys(correctPairs).length;
                              let correctCount = 0;
                              if (userAnswer && typeof userAnswer === 'object') {
                                  for (const promptIndex in correctPairs) {
                                      if (userAnswer.hasOwnProperty(promptIndex) && userAnswer[promptIndex] === correctPairs[promptIndex]) {
                                          correctCount++;
                                      }
                                  }
                              }
                              reviewCorrectness = (correctCount === totalPairs);
                              if (reviewCorrectness) { correctnessClass = 'correct'; statusText = '✓ Correct'; }
                              else if (correctCount > 0) { correctnessClass = 'partial'; statusText = `~ Partial (${correctCount}/${totalPairs})`; }
                              else { correctnessClass = 'incorrect'; statusText = '✗ Incorrect'; }
                              break;

                          case "ordering":
                              if (userAnswer && Array.isArray(userAnswer)) {
                                   reviewCorrectness = JSON.stringify(userAnswer) === JSON.stringify(question.answer);
                              }
                              correctnessClass = reviewCorrectness ? 'correct' : 'incorrect';
                              statusText = reviewCorrectness ? '✓ Correct' : '✗ Incorrect';
                              break;

                          case "multiple_choice":
                          default:
                             if (userAnswer !== null && question.options && question.answer) {
                                 reviewCorrectness = question.options[userAnswer] === question.answer;
                             }
                              correctnessClass = reviewCorrectness ? 'correct' : 'incorrect';
                              statusText = reviewCorrectness ? '✓ Correct' : '✗ Incorrect';
                              break;
                      }
                  } catch (e) {
                     console.error("Error determining correctness in review for question", index, e);
                     correctnessClass = 'incorrect'; statusText = 'Error';
                  }


                 questionReview.className = `question-review ${correctnessClass}`;

                 questionReview.innerHTML = `
                    <div class="review-question-header">
                        <span class="review-question-number">Question ${index + 1} (${question.type.replace('_', ' ')})</span>
                        <span class="review-status">${statusText}</span>
                    </div>
                    <p class="review-question-text">${question.question}</p>
                    <div id="review-answer-content-${index}"></div> <!-- Placeholder for type-specific review -->
                 `;
                 reviewDiv.appendChild(questionReview);

                 // Call type-specific review renderer
                  const reviewContentContainer = reviewDiv.querySelector(`#review-answer-content-${index}`);
                 if (reviewContentContainer) {
                      switch (question.type) {
                          case "matching":
                              reviewMatching(question, userAnswer, reviewContentContainer);
                              break;
                          case "ordering":
                              reviewOrdering(question, userAnswer, reviewContentContainer);
                              break;
                          case "multiple_choice":
                          default:
                              reviewMultipleChoice(question, userAnswer, reviewContentContainer);
                              break;
                      }
                 }
            });

            questionContent.appendChild(reviewDiv);
             const modalContentDiv = document.getElementById('questionModal')?.querySelector('.modal-content');
             if(modalContentDiv) modalContentDiv.scrollTop = 0;
        }


        function reviewMultipleChoice(question, userAnswerIndex, container) {
             const div = document.createElement('div');
             div.className = 'review-mc-answer';

             const userSelectedText = (userAnswerIndex !== null && question.options && question.options[userAnswerIndex] !== undefined)
                                      ? question.options[userAnswerIndex]
                                      : 'No answer selected';
             const isCorrect = (userAnswerIndex !== null) && (userSelectedText === question.answer);

             div.innerHTML = `
                <p><strong>Your answer:</strong> <span class="user-answer-text ${isCorrect ? 'correct' : (userAnswerIndex !== null ? 'incorrect' : '')}">${userSelectedText}</span></p>
                ${!isCorrect ? `<p><strong>Correct answer:</strong> <span class="correct-answer-text">${question.answer || 'N/A'}</span></p>` : ''}
             `;
             container.appendChild(div);
         }

        function reviewMatching(question, userPairs, container) {
             const div = document.createElement('div');
             div.className = 'review-matching-answer';
             div.innerHTML = `<p><strong>Matching Review:</strong></p>`;

             const reviewGrid = document.createElement('div');
             reviewGrid.className = 'review-matching-grid';

             const promptsCol = document.createElement('div');
             promptsCol.className = 'review-matching-column';
             const matchesCol = document.createElement('div');
             matchesCol.className = 'review-matching-column';

             const correctPairs = question.answer;

             question.prompts.forEach((promptText, promptIndex) => {
                 const userMatchIndex = userPairs ? userPairs[promptIndex] : null;
                 const correctMatchIndex = correctPairs[promptIndex];
                 const isPairCorrect = userMatchIndex === correctMatchIndex;

                 const promptDiv = document.createElement('div');
                 promptDiv.textContent = promptText;

                 const matchDiv = document.createElement('div');
                 // Find the text of the match the user selected (if any)
                 const userMatchText = (userMatchIndex !== null && question.matches[userMatchIndex]) ? question.matches[userMatchIndex] : '(No match selected)';
                 // Find the text of the correct match
                 const correctMatchText = question.matches[correctMatchIndex] || '(Error: Correct match not found)';


                 if (isPairCorrect) {
                     promptDiv.classList.add('review-matched-pair-correct');
                     matchDiv.textContent = correctMatchText; // Only need to show correct one if right
                     matchDiv.classList.add('review-matched-pair-correct');
                 } else {
                     promptDiv.classList.add('review-matched-pair-incorrect');
                      // Show user's incorrect choice and the correct one
                     matchDiv.innerHTML = `<span style="text-decoration: line-through; color: #dc2626;">${userMatchText}</span> <span style="color: #059669;">(${correctMatchText})</span>`;
                     matchDiv.classList.add('review-matched-pair-incorrect');
                 }

                 promptsCol.appendChild(promptDiv);
                 matchesCol.appendChild(matchDiv);
             });

             reviewGrid.appendChild(promptsCol);
             reviewGrid.appendChild(matchesCol);
             div.appendChild(reviewGrid);
             container.appendChild(div);
         }

        function reviewOrdering(question, userOrderedItems, container) {
             const div = document.createElement('div');
             div.className = 'review-ordering-answer';

             const correctOrder = question.answer;
             const isCorrect = JSON.stringify(userOrderedItems) === JSON.stringify(correctOrder);

             div.innerHTML = `<p><strong>Ordering Review:</strong></p>`;

             const listDiv = document.createElement('div');
             listDiv.className = 'review-ordering-list';

             // Display items based on the *correct* order for comparison
             correctOrder.forEach((correctItemText, correctIndex) => {
                  const itemDiv = document.createElement('div');
                  itemDiv.className = 'review-ordering-list-item';

                  const userIndex = userOrderedItems ? userOrderedItems.indexOf(correctItemText) : -1;
                  const userNumber = (userIndex !== -1) ? userIndex + 1 : null; // User's chosen position (1-based)
                  const correctNumber = correctIndex + 1; // Correct position (1-based)

                  let userNumSpan = '';
                  if (userNumber === correctNumber) {
                     userNumSpan = `<span class="review-order-number review-order-correct">${userNumber}.</span>`;
                  } else if (userNumber !== null) {
                     userNumSpan = `<span class="review-order-number review-order-incorrect">${userNumber}.</span> <span class="review-order-number review-order-correct">(${correctNumber}.)</span>`;
                  } else {
                      userNumSpan = `<span class="review-order-number review-order-incorrect">(Not placed)</span> <span class="review-order-number review-order-correct">(${correctNumber}.)</span>`;
                  }


                  itemDiv.innerHTML = `${userNumSpan} ${correctItemText}`;
                  listDiv.appendChild(itemDiv);
             });


             div.appendChild(listDiv);

              if (!isCorrect && userOrderedItems) {
                  div.innerHTML += `<p style="margin-top: 10px;"><strong>Your Order:</strong> ${userOrderedItems.join(', ')}</p>`;
              }

             container.appendChild(div);
         }


        // --- Modal & Error Handling ---

        function closeModal() {
            const modal = document.getElementById('questionModal');
            if (modal) modal.style.display = 'none';
            // Reset quiz state if closing means abandoning? Optional.
        }

        function showError(subject, unit, lesson, message = '') {
            const modal = document.getElementById('questionModal');
            const modalTitle = document.getElementById('modalTitle');
            const questionContent = document.getElementById('questionContent');

            modalTitle.textContent = 'No Questions Available';
            const defaultMessage = `Sorry, no questions are available yet for ${lesson} in ${unit}.`;

            questionContent.innerHTML = `
                <div class="error-message">
                    ${message || defaultMessage}
                </div>
                <div class="add-question-prompt">
                   <!-- <p>Would you like to be notified when questions are added?</p> -->
                   <!-- <button class="btn add-question-btn" id="notify-btn">Notify Me (Coming Soon)</button> -->
                     <button class="btn close-btn" onclick="closeModal()" style="margin-left: 10px;">Close</button>
                </div>`;

            modal.style.display = 'block';
            modal.scrollTop = 0;
        }

        // Get questions data (uses topicsData from topics.js)
        function getQuestions(subject, unitTitle, lessonTitle) {
            const activeSemesterBtn = document.querySelector('.semester-btn.active');
            if (!activeSemesterBtn) {
                console.error("Cannot determine active semester in getQuestions."); return [];
            }
            const activeSemester = activeSemesterBtn.dataset.semester;

            if (!subject || !unitTitle || !lessonTitle || !activeSemester) {
                 console.error("Missing parameters for getQuestions:", { subject, unitTitle, lessonTitle, activeSemester }); return [];
            }

            try {
                if (!topicsData || !topicsData[subject] || !topicsData[subject][activeSemester] || !topicsData[subject][activeSemester].units) {
                     console.warn(`Data structure missing for ${subject} -> ${activeSemester}`); return [];
                }
                const semesterData = topicsData[subject][activeSemester];
                const unit = semesterData.units.find(u => u && u.title === unitTitle);
                if (!unit || !unit.lessons) {
                    console.warn(`Unit "${unitTitle}" or its lessons not found in ${subject} -> ${activeSemester}.`); return [];
                }
                const lesson = unit.lessons.find(l => l && l.title === lessonTitle);
                if (!lesson) {
                    console.warn(`Lesson "${lessonTitle}" not found in unit "${unitTitle}".`); return [];
                }
                // Validate questions array and add default type if missing
                 if (lesson.questions && Array.isArray(lesson.questions)) {
                    return lesson.questions.map(q => ({ type: 'multiple_choice', ...q })); // Default to MC if type missing
                } else {
                    return [];
                 }

            } catch (error) {
                console.error("Error finding questions in data structure:", error, { subject, unitTitle, lessonTitle, activeSemester });
                return [];
            }
        }

        // --- END OF questions.js ---
    </script>

</body>
</html>
